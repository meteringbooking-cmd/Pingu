<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fail Code Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f23;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(74, 86, 226, 0.3), transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(138, 43, 226, 0.2), transparent 50%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.37),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, rgba(120, 119, 198, 0.2) 0%, rgba(74, 86, 226, 0.2) 100%);
            backdrop-filter: blur(10px);
            color: white;
            padding: 50px 30px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        input, select, button {
            padding: 14px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #7F7FD5;
            box-shadow: 0 0 0 4px rgba(127, 127, 213, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }
        select option {
            background: #1a1a2e;
            color: white;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        button:hover::before {
            left: 100%;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .file-input-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .file-input-label:hover::before {
            left: 100%;
        }
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }

        /* Fail Code Filter */
        .fail-code-filter {
            padding: 30px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .fail-code-filter h3 {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-actions button {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .checkbox-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin: 0;
            padding: 0;
        }
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9em;
            text-transform: none;
            letter-spacing: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .stat-card:hover::before {
            opacity: 1;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
        }
        .stat-label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            padding: 30px;
        }
        .chart-container {
            position: relative;
            height: 500px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            padding: 20px;
        }
        .occurrence-table-container {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .occurrence-table-container h2 {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .occurrence-table {
            width: 100%;
        }
        .occurrence-row {
            display: grid;
            grid-template-columns: 110px 1fr;
            gap: 15px;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        .occurrence-row:hover {
            background: rgba(102, 126, 234, 0.15);
            border-color: rgba(127, 127, 213, 0.5);
            transform: translateX(5px);
        }
        .occurrence-code {
            font-weight: bold;
            color: #a8c0ff;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .occurrence-count {
            font-size: 1.3em;
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.6);
        }
        .no-data-icon {
            font-size: 4em;
            margin-bottom: 20px;
            filter: grayscale(1) opacity(0.5);
        }
        .no-data h2 {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
        }
        .top-performers {
            padding: 0 30px 30px;
        }
        .top-performers h2 {
            padding: 30px 0 20px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.8em;
        }
        .performer-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .performer-card:hover {
            border-color: rgba(127, 127, 213, 0.5);
            box-shadow: 0 8px 32px rgba(127, 127, 213, 0.3);
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.05);
        }
        .performer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .performer-name-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .performer-name {
            font-size: 1.4em;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.95);
        }
        .toggle-jobs-btn {
            background: rgba(102, 126, 234, 0.3);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(102, 126, 234, 0.5);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .toggle-jobs-btn:hover {
            background: rgba(102, 126, 234, 0.5);
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .toggle-jobs-btn .arrow {
            transition: transform 0.3s;
            font-size: 0.9em;
        }
        .toggle-jobs-btn.expanded .arrow {
            transform: rotate(180deg);
        }
        .performer-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .job-numbers-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .job-numbers-section.show {
            display: block;
        }
        .job-numbers-title {
            font-weight: 600;
            color: #a8c0ff;
            margin-bottom: 12px;
            font-size: 1.05em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .job-numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        .job-number-item {
            background: rgba(102, 126, 234, 0.15);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            cursor: default;
        }
        .job-number-item:hover {
            background: rgba(102, 126, 234, 0.25);
            border-color: rgba(102, 126, 234, 0.5);
        }
        .job-numbers-grid::-webkit-scrollbar {
            width: 8px;
        }
        .job-numbers-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .job-numbers-grid::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 10px;
        }
        .job-numbers-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }
        .fail-codes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }
        .fail-code-item {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        .fail-code-item:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(127, 127, 213, 0.5);
            transform: scale(1.05);
        }
        .fail-code-name {
            font-weight: bold;
            color: #a8c0ff;
            margin-bottom: 6px;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .fail-code-count {
            font-size: 1.4em;
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
        }
        
        /* Color badge styles */
        .color-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .color-badge.red {
            background: linear-gradient(135deg, #ff4757, #c23616);
        }
        .color-badge.amber {
            background: linear-gradient(135deg, #ffa502, #ff6348);
        }
        .color-badge.purple {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        }
        
        /* Tooltip styles */
        .tooltip {
            position: absolute;
            background: rgba(20, 20, 40, 0.98);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9em;
            max-width: 350px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            border: 1px solid rgba(127, 127, 213, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        .tooltip.show {
            opacity: 1;
        }
        .tooltip-code {
            font-weight: bold;
            color: #a8c0ff;
            margin-bottom: 6px;
            font-size: 1.1em;
        }
        .tooltip-description {
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(127, 127, 213, 0.3);
        }
        .tooltip-teams {
            margin-top: 10px;
        }
        .tooltip-teams-title {
            font-weight: 600;
            color: #a8c0ff;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .team-list-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.9em;
        }
        .team-list-item .team-name {
            color: rgba(255, 255, 255, 0.9);
        }
        .team-list-item .team-count {
            color: #a8c0ff;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* Scrollbar styling */
        .occurrence-table-container::-webkit-scrollbar,
        .checkbox-grid::-webkit-scrollbar {
            width: 8px;
        }
        .occurrence-table-container::-webkit-scrollbar-track,
        .checkbox-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .occurrence-table-container::-webkit-scrollbar-thumb,
        .checkbox-grid::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 10px;
        }
        .occurrence-table-container::-webkit-scrollbar-thumb:hover,
        .checkbox-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .occurrence-table-container {
                max-height: 400px;
            }
        }
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            .fail-codes-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Fail Code Analysis Dashboard</h1>
            <p>Upload your CSV file to analyze fail codes by team and date range</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Upload CSV File</label>
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".csv" />
                    <label for="fileInput" class="file-input-label">
                        üìÅ Choose File
                    </label>
                </div>
            </div>

            <div class="control-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate" />
            </div>

            <div class="control-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate" />
            </div>

            <div class="control-group">
                <label for="teamFilter">Team</label>
                <select id="teamFilter">
                    <option value="all">All Teams</option>
                </select>
            </div>
        </div>

        <div class="fail-code-filter" id="teamNumberFilter" style="display: none;">
            <h3>üë• Filter Team Numbers</h3>
            <div class="filter-actions">
                <button onclick="selectAllTeamNumbers()">Select All</button>
                <button onclick="deselectAllTeamNumbers()">Deselect All</button>
            </div>
            <div class="checkbox-grid" id="teamNumberCheckboxGrid"></div>
        </div>

        <div class="fail-code-filter" id="failCodeFilter" style="display: none;">
            <h3>üîç Filter Fail Codes</h3>
            <div class="filter-actions">
                <button onclick="selectAllCodes()">Select All</button>
                <button onclick="deselectAllCodes()">Deselect All</button>
                <button onclick="selectRedCodes()">Select Red Only</button>
                <button onclick="selectAmberCodes()">Select Amber Only</button>
                <button onclick="selectPurpleCodes()">Select Purple Only</button>
            </div>
            <div class="checkbox-grid" id="checkboxGrid"></div>
        </div>

        <div class="stats" id="stats"></div>

        <div class="main-content" id="mainContent" style="display: none;">
            <div class="chart-container">
                <canvas id="failCodeChart"></canvas>
            </div>
            <div class="occurrence-table-container">
                <h2>üìã All Fail Codes</h2>
                <div class="occurrence-table" id="occurrenceTable"></div>
            </div>
        </div>

        <div id="topPerformers" class="top-performers" style="display: none;">
            <h2>üèÜ Top Performers by Fail Code Count</h2>
            <div id="performersList"></div>
        </div>

        <div id="noData" class="no-data" style="display: none;">
            <div class="no-data-icon">üìã</div>
            <h2>No Data Available</h2>
            <p>Please upload a CSV file to begin analysis</p>
        </div>
    </div>

    <!-- Tooltip element -->
    <div class="tooltip" id="tooltip">
        <div class="tooltip-code"></div>
        <div class="tooltip-description"></div>
        <div class="tooltip-teams"></div>
    </div>

    <script>
        const FAIL_CODES = [
            'E1', 'E2', 'E3', 'E4', 'E5', 'E6', 'E7', 'E8', 'E9', 'E10',
            'E11', 'E12', 'E13', 'E14', 'E15', 'E16', 'E17', 'E18', 'E19', 'E20',
            'E23', 'E24', 'E25', 'E26', 'E27', 'E28', 'E29', 'E30', 'E31', 'E32',
            'E33', 'E34', 'E35', 'E36', 'E37', 'E38', 'E39', 'E40', 'E41', 'E42',
            'E43', 'E44', 'E45', 'E46', 'E47', 'E48', 'E49', 'E50', 'E51', 'EX2',
            'E52', 'E53', 'E54', 'E55', 'E56', 'E57', 'E58', 'E59', 'E60', 'E61',
            'E62', 'E63', 'E64', 'E65', 'E66', 'E67', 'E68', 'E69', 'E70', 'EX1',
            'EX3', 'R10', 'R11', 'R12', 'R13', 'R14', 'R15', 'R16', 'R17', 'R18',
            'R19', 'R20', 'R21', 'R22', 'R23', 'R24', 'R25', 'R26', 'R27', 'R28',
            'R29', 'R30', 'R31', 'R32', 'R33', 'R34', 'R35', 'R36', 'R37', 'R38',
            'R39', 'R40', 'R41', 'R42', 'R43', 'R44', 'R45', 'R46', 'R47', 'R48',
            'R49', 'R50', 'R51', 'R52', 'R53', 'R54', 'RX1', 'RX2', 'RX3'
        ];

        const FAIL_CODE_COLORS = {
            // Red E-codes
            'E1': 'red', 'E2': 'red', 'E3': 'red', 'E4': 'red', 'E5': 'red',
            'E6': 'red', 'E7': 'red', 'E8': 'red', 'E9': 'red', 'E10': 'red',
            'E11': 'red', 'E12': 'red', 'E13': 'red', 'E14': 'red', 'E15': 'red',
            'E16': 'red', 'E17': 'red', 'E18': 'red', 'E19': 'red', 'E20': 'red',
            'EX1': 'red',
            // Amber E-codes
            'E22': 'amber', 'E23': 'amber', 'E24': 'amber', 'E25': 'amber', 'E26': 'amber',
            'E27': 'amber', 'E28': 'amber', 'E29': 'amber', 'E30': 'amber', 'E31': 'amber',
            'E32': 'amber', 'E33': 'amber', 'E34': 'amber', 'E35': 'amber', 'E36': 'amber',
            'E37': 'amber', 'E38': 'amber', 'E39': 'amber', 'E40': 'amber', 'E41': 'amber',
            'E42': 'amber', 'E43': 'amber', 'E44': 'amber', 'E45': 'amber', 'E46': 'amber',
            'E47': 'amber', 'E48': 'amber', 'E49': 'amber', 'E50': 'amber', 'E51': 'amber',
            'EX2': 'amber',
            // Purple E-codes
            'E52': 'purple', 'E53': 'purple', 'E54': 'purple', 'E55': 'purple', 'E56': 'purple',
            'E57': 'purple', 'E58': 'purple', 'E59': 'purple', 'E60': 'purple', 'E61': 'purple',
            'E62': 'purple', 'E63': 'purple', 'E64': 'purple', 'E65': 'purple', 'E66': 'purple',
            'E67': 'purple', 'E68': 'purple', 'E69': 'purple', 'E70': 'purple', 'EX3': 'purple',
            // Red R-codes
            'R10': 'red', 'R11': 'red', 'R12': 'red', 'R13': 'red', 'R14': 'red',
            'R15': 'red', 'R16': 'red', 'RX1': 'red',
            // Amber R-codes
            'R17': 'amber', 'R18': 'amber', 'R19': 'amber', 'R20': 'amber', 'R21': 'amber',
            'R22': 'amber', 'R23': 'amber', 'R24': 'amber', 'R25': 'amber', 'R26': 'amber',
            'R27': 'amber', 'R28': 'amber', 'R29': 'amber', 'R30': 'amber', 'R31': 'amber',
            'R32': 'amber', 'R33': 'amber', 'R34': 'amber', 'R35': 'amber', 'R36': 'amber',
            'R37': 'amber', 'R38': 'amber', 'R39': 'amber', 'R40': 'amber', 'RX2': 'amber',
            // Purple R-codes
            'R41': 'purple', 'R42': 'purple', 'R43': 'purple', 'R44': 'purple', 'R45': 'purple',
            'R46': 'purple', 'R47': 'purple', 'R48': 'purple', 'R49': 'purple', 'R50': 'purple',
            'R51': 'purple', 'R52': 'purple', 'R53': 'purple', 'R54': 'purple', 'RX3': 'purple'
        };

        const FAIL_CODE_DESCRIPTIONS = {
            'E1': 'Missed an A code on distribution equipment (DNO)',
            'E2': 'Under sized cable installed for equipment / length of cable run',
            'E3': 'Incorrect or no PPE worn',
            'E4': 'Cable damaged when installed',
            'E5': 'Incorrect type of cable installed',
            'E6': 'Conductor only secured by one terminal screw',
            'E7': 'Reverse Polarity (AC or DC) Provide notes',
            'E8': 'Non IP rated consumer unit installed outside',
            'E9': 'The enclosure does not protect to IP55',
            'E10': 'Electrical certificate blank / not filled in',
            'E11': '',
            'E12': 'Terminals are over tightened, torque screwdriver not used',
            'E13': 'Test results on the EIC are different to supplied photos',
            'E14': 'Test result taken not suitable for install and/or are outside BS7671 limits',
            'E15': 'Exposed Conductors (including un-plugged holes, both live and neutral and customer blocks)',
            'E16': 'Loose terminations- greater than 360¬∞ rotation on any termination',
            'E17': 'Engineer worked out of scope/Engineer not applying competence',
            'E18': 'Signs of distress, over heating, burning, fire etc',
            'E19': 'DC cable has no warning stickers',
            'E20': 'Fire detection not fitted',
            'EX1': 'Miscellaneous - supporting notes required',
            'E22': 'Missed a B code on distribution equipment (DNO)',
            'E23': 'Incorrect MCB, RCBO or RCD type',
            'E24': 'Incorrect mA rating on RCD',
            'E25': 'Incorrect ferrules or crimps fitted',
            'E26': 'Fuse pull has not been completed in KF',
            'E27': 'Incorrect size of tails installed or not used',
            'E28': 'Plastic consumer unit fitted inside',
            'E29': 'The enclosure does not protect to IP2X sides and bottom/IP4X top',
            'E30': 'CT clamp installed in the incorrect location / not fitted',
            'E31': '',
            'E32': 'Fitted outside BS 7671 requirements (provide notes)',
            'E33': 'Smoke alarms not interlinked',
            'E34': 'No socket polarity plug test / only one performed',
            'E35': '',
            'E36': 'Extraneous bonding not installed/inadequate - provide notes',
            'E37': 'Electrical certificate / MCS forms not complete',
            'E38': 'Solar equipment not installed in correct location',
            'E39': 'Testing on MFT using incorrect setting',
            'E40': 'Solar equipment installed using incorrect fixings',
            'E41': 'No lock-off kit used',
            'E42': 'Not connected to the internet and not left in smart mode',
            'E43': 'Not connected to customers app',
            'E44': 'Not a clear explanation how the app and the system works',
            'E45': 'Testing results different to recorded details but within limits',
            'E46': 'Fire rated clips not used',
            'E47': 'No glands installed',
            'E48': 'Fire detection only fitted at battery location',
            'E49': 'No photos taken',
            'E50': 'Single insulation visible outside of enclosures',
            'E51': 'Terminations not adequately tightened- rotation on any terminal screw between 180¬∞ and 360¬∞ (half turn)',
            'EX2': 'Miscellaneous - provide notes',
            'E52': 'Cable installed in incorrect zones',
            'E53': 'Cable inadequately supported',
            'E54': 'No sealant used',
            'E55': 'DC cable run not stickered enough for length of run',
            'E56': 'Missed a C code on distribution equipment (DNO)',
            'E57': 'EIC / MCS forms not filled in correctly',
            'E58': 'No polarity identification on tails / Grey tails used',
            'E59': 'Not all signatures recorded',
            'E60': 'Same photo of test load twice',
            'E61': 'RCD testing completed on wrong setting (Type AC instead of A)',
            'E62': 'Identification only used on tails',
            'E63': 'Periodic and RCD test label missing',
            'E64': '230 Volt label missing',
            'E65': 'Safety labelling missing from inverter, storage battery or metering position',
            'E66': 'Drain wire incorrectly terminated',
            'E67': 'No signatures taken',
            'E68': 'Missing Photos / missing information',
            'E69': 'Photo taken but inadequate',
            'E70': 'Incorrect glands installed with selected cable',
            'EX3': 'Miscellaneous - provide notes',
            'R10': 'Working within 2m of an unprotected edge without correct PPE',
            'R11': 'Working outside of Scaffolded area',
            'R12': 'Working on an unsafe scaffold',
            'R13': 'Working on an unsafe Ladder',
            'R14': 'DC cable installed unprotected within the building envelope',
            'R15': 'Cable damage when installed',
            'R16': 'Installer worked outside of scope/installer not applying competence',
            'RX1': 'Miscellaneous - supporting notes required',
            'R17': 'No structural cals completed',
            'R18': 'Working on scaffold not to TG20:21 standards',
            'R19': 'Incorrect/No PPE worn',
            'R20': 'Incorrect hook used for tile type',
            'R21': 'Rail replacement outside of clamping zone',
            'R22': 'Incorrect number of fixings in roof hooks',
            'R23': 'Incorrect fixings used on roof hooks',
            'R24': '5mm gap not observed to the side of between the roof hook bracket and the roof tile beneath',
            'R25': 'Incorrect tile flashing used',
            'R26': 'Flashing incorrectly installed and not weathertight',
            'R27': 'Incorrect number of placement of hooks',
            'R28': 'Maximum span between roof hooks exceeded',
            'R29': 'Racking system bolts under/over tightened. Torque wrench not used.',
            'R30': 'Rail profiles protrude less than 10mm at module edge',
            'R31': 'Array not as per schematics',
            'R32': 'Rail profiles protrude more than 0.4m past the last hook at the sides of the array',
            'R33': 'Micro inverter fixings under/over tightened, torque wrench not used',
            'R34': 'Module clamps under/over tightened. Torque wrench not used.',
            'R35': 'Micro inverters incorrectly installed',
            'R36': 'Installation of bird guard does not meet manufacturers instructions',
            'R37': 'Array installed over mechanical vents',
            'R38': 'Roof not left weathertight, tiles not flush or broken',
            'R39': 'Property left with split rafters or screws protrudes rafters',
            'R40': 'Failed to meet the requirements of MCS, installed within 400mm of an edge without special measures considered',
            'RX2': 'Miscellaneous - supporting notes required',
            'R41': 'Unidentified pre existing damage to roof/roof in poor condition',
            'R42': 'Cables inadequately supports',
            'R43': 'No sealant used on cable entry in wall',
            'R44': 'Cutting rails in situ on the roof',
            'R45': 'Cutting tiles in situ on the roof',
            'R46': 'Missing photos',
            'R47': 'Photos taken but inadequate',
            'R48': 'Installation of bird guard does not meet company standard',
            'R49': 'Cable roof entry not to spec',
            'R50': 'Rails profile do not protrude module by 50mm',
            'R51': 'Ladder work without tetra safety systems',
            'R52': 'Failed to replace broken tiles',
            'R53': 'Clearances not observed to in roof features',
            'R54': 'Working on a scaffold not to OES standards',
            'RX3': 'Miscellaneous - supporting notes required'
        };

        let allData = [];
        let chart = null;
        const tooltip = document.getElementById('tooltip');
        let selectedCodes = new Set(FAIL_CODES); // All codes selected by default
        let selectedTeamNumbers = new Set(); // Will be populated when file is loaded

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('startDate').addEventListener('change', updateDashboard);
        document.getElementById('endDate').addEventListener('change', updateDashboard);
        document.getElementById('teamFilter').addEventListener('change', updateDashboard);

        function getColorBadge(code) {
            const color = FAIL_CODE_COLORS[code] || 'purple';
            return `<span class="color-badge ${color}"></span>`;
        }

        function initializeCheckboxes() {
            const grid = document.getElementById('checkboxGrid');
            grid.innerHTML = FAIL_CODES.map(code => `
                <div class="checkbox-item">
                    <input type="checkbox" id="code-${code}" value="${code}" checked onchange="handleCodeToggle()">
                    <label for="code-${code}">${getColorBadge(code)} ${code}</label>
                </div>
            `).join('');
        }

        function initializeTeamNumberCheckboxes() {
            const teamNumbers = [...new Set(allData.map(r => r['Team Number']).filter(Boolean))].sort();
            selectedTeamNumbers = new Set(teamNumbers); // Select all by default
            
            const grid = document.getElementById('teamNumberCheckboxGrid');
            grid.innerHTML = teamNumbers.map(teamNumber => `
                <div class="checkbox-item">
                    <input type="checkbox" id="teamnum-${teamNumber}" value="${teamNumber}" checked onchange="handleTeamNumberToggle()">
                    <label for="teamnum-${teamNumber}">${teamNumber}</label>
                </div>
            `).join('');
        }

        function handleCodeToggle() {
            selectedCodes.clear();
            document.querySelectorAll('#checkboxGrid input:checked').forEach(checkbox => {
                selectedCodes.add(checkbox.value);
            });
            updateDashboard();
        }

        function handleTeamNumberToggle() {
            selectedTeamNumbers.clear();
            document.querySelectorAll('#teamNumberCheckboxGrid input:checked').forEach(checkbox => {
                selectedTeamNumbers.add(checkbox.value);
            });
            updateDashboard();
        }

        function selectAllCodes() {
            document.querySelectorAll('#checkboxGrid input').forEach(cb => cb.checked = true);
            handleCodeToggle();
        }

        function deselectAllCodes() {
            document.querySelectorAll('#checkboxGrid input').forEach(cb => cb.checked = false);
            handleCodeToggle();
        }

        function selectRedCodes() {
            document.querySelectorAll('#checkboxGrid input').forEach(cb => {
                cb.checked = FAIL_CODE_COLORS[cb.value] === 'red';
            });
            handleCodeToggle();
        }

        function selectAmberCodes() {
            document.querySelectorAll('#checkboxGrid input').forEach(cb => {
                cb.checked = FAIL_CODE_COLORS[cb.value] === 'amber';
            });
            handleCodeToggle();
        }

        function selectPurpleCodes() {
            document.querySelectorAll('#checkboxGrid input').forEach(cb => {
                cb.checked = FAIL_CODE_COLORS[cb.value] === 'purple';
            });
            handleCodeToggle();
        }

        function selectAllTeamNumbers() {
            document.querySelectorAll('#teamNumberCheckboxGrid input').forEach(cb => cb.checked = true);
            handleTeamNumberToggle();
        }

        function deselectAllTeamNumbers() {
            document.querySelectorAll('#teamNumberCheckboxGrid input').forEach(cb => cb.checked = false);
            handleTeamNumberToggle();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                complete: function(results) {
                    console.log('Raw data:', results.data);
                    
                    const headers = results.data[1];
                    console.log('Headers:', headers);
                    
                    const dataRows = results.data.slice(2).filter(row => row.length > 1 && row[0]);

                    allData = dataRows.map(row => {
                        const obj = {};
                        headers.forEach((header, i) => {
                            const cleanHeader = header ? header.trim() : '';
                            obj[cleanHeader] = row[i] || '';
                        });
                        return obj;
                    });

                    console.log('Parsed data sample:', allData[0]);
                    console.log('Team values:', allData.map(r => r['Team']).slice(0, 10));

                    initializeCheckboxes();
                    initializeTeamNumberCheckboxes();
                    populateTeamFilter();
                    setDefaultDateRange();
                    document.getElementById('teamNumberFilter').style.display = 'block';
                    document.getElementById('failCodeFilter').style.display = 'block';
                    updateDashboard();
                },
                skipEmptyLines: true
            });
        }

        function populateTeamFilter() {
            const teams = [...new Set(allData.map(r => r['Team']).filter(Boolean))].sort();
            const select = document.getElementById('teamFilter');
            select.innerHTML = '<option value="all">All Teams</option>';
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                select.appendChild(option);
            });
        }

        function setDefaultDateRange() {
            const dates = allData
                .map(r => parseDate(r['Date received']))
                .filter(d => d)
                .sort((a, b) => a - b);

            if (dates.length > 0) {
                document.getElementById('startDate').valueAsDate = dates[0];
                document.getElementById('endDate').valueAsDate = dates[dates.length - 1];
            }
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateStr);
        }

        function getTeamsByFailCode(data, failCode) {
            const teamCounts = {};
            
            data.forEach(row => {
                const team = row['Team'] || 'Unknown';
                for (let i = 1; i <= 12; i++) {
                    const code = row[`Fail Code ${i}`];
                    if (code === failCode) {
                        teamCounts[team] = (teamCounts[team] || 0) + 1;
                    }
                }
            });

            return Object.entries(teamCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Top 5 teams
        }

        function updateDashboard() {
            if (allData.length === 0) {
                document.getElementById('noData').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('stats').style.display = 'none';
                document.getElementById('topPerformers').style.display = 'none';
                return;
            }

            document.getElementById('noData').style.display = 'none';
            document.getElementById('mainContent').style.display = 'grid';
            document.getElementById('stats').style.display = 'grid';

            const startDate = document.getElementById('startDate').valueAsDate;
            const endDate = document.getElementById('endDate').valueAsDate;
            const selectedTeam = document.getElementById('teamFilter').value;

            const filtered = allData.filter(row => {
                const rowDate = parseDate(row['Date received']);
                const dateMatch = (!startDate || !endDate || !rowDate) || 
                                 (rowDate >= startDate && rowDate <= endDate);
                const teamMatch = selectedTeam === 'all' || row['Team'] === selectedTeam;
                const teamNumberMatch = selectedTeamNumbers.size === 0 || selectedTeamNumbers.has(row['Team Number']);
                return dateMatch && teamMatch && teamNumberMatch;
            });

            updateStats(filtered, startDate, endDate);
            updateChart(filtered);
            updateOccurrenceTable(filtered);
            updateTopPerformers(filtered);
        }

        function updateStats(data, startDate, endDate) {
            let totalIncidents = 0;
            if (startDate && endDate) {
                totalIncidents = allData.filter(row => {
                    const rowDate = parseDate(row['Date received']);
                    return rowDate && rowDate >= startDate && rowDate <= endDate;
                }).length;
            } else {
                totalIncidents = data.length;
            }
            
            const uniqueTeams = new Set(data.map(r => r['Team']).filter(Boolean)).size;
            
            let totalFailCodes = 0;
            data.forEach(row => {
                for (let i = 1; i <= 12; i++) {
                    const code = row[`Fail Code ${i}`];
                    if (code && selectedCodes.has(code)) totalFailCodes++;
                }
            });

            const revisitsRequired = data.filter(r => 
                r['Revisit required?'] && r['Revisit required?'].toLowerCase() === 'yes'
            ).length;

            const revisitsCompleted = data.filter(r => 
                r['Revisit completed'] && r['Revisit completed'].toLowerCase() === 'yes'
            ).length;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Incidents</div>
                    <div class="stat-value">${totalIncidents}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Fail Codes</div>
                    <div class="stat-value">${totalFailCodes}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Teams</div>
                    <div class="stat-value">${uniqueTeams}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Revisits</div>
                    <div class="stat-value">${revisitsCompleted} / ${revisitsRequired}</div>
                    <div style="font-size: 0.75em; opacity: 0.7; margin-top: 8px;">Completed / Required</div>
                </div>
            `;
            document.getElementById('stats').innerHTML = statsHTML;
        }

        function updateChart(data) {
            const failCodeCounts = {};
            FAIL_CODES.forEach(code => failCodeCounts[code] = 0);

            data.forEach(row => {
                for (let i = 1; i <= 12; i++) {
                    const code = row[`Fail Code ${i}`];
                    if (code && selectedCodes.has(code)) {
                        failCodeCounts[code]++;
                    }
                }
            });

            const chartData = FAIL_CODES
                .filter(code => selectedCodes.has(code))
                .map(code => ({ code, count: failCodeCounts[code] }))
                .filter(item => item.count > 0)
                .sort((a, b) => b.count - a.count)
                .slice(0, 20);

            if (chart) chart.destroy();

            const ctx = document.getElementById('failCodeChart').getContext('2d');
            
            const backgroundColors = chartData.map(item => {
                const color = FAIL_CODE_COLORS[item.code];
                if (color === 'red') return 'rgba(255, 71, 87, 0.8)';
                if (color === 'amber') return 'rgba(255, 165, 2, 0.8)';
                return 'rgba(162, 155, 254, 0.8)';
            });
            
            const borderColors = chartData.map(item => {
                const color = FAIL_CODE_COLORS[item.code];
                if (color === 'red') return 'rgba(255, 71, 87, 1)';
                if (color === 'amber') return 'rgba(255, 165, 2, 1)';
                return 'rgba(162, 155, 254, 1)';
            });

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(item => item.code),
                    datasets: [{
                        label: 'Fail Code Count',
                        data: chartData.map(item => item.count),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top 20 Fail Codes',
                            color: 'rgba(255, 255, 255, 0.9)',
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(20, 20, 40, 0.95)',
                            titleColor: '#a8c0ff',
                            bodyColor: 'rgba(255, 255, 255, 0.9)',
                            borderColor: 'rgba(127, 127, 213, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    return 'Count: ' + context.parsed.y;
                                },
                                afterLabel: function(context) {
                                    const code = context.label;
                                    const description = FAIL_CODE_DESCRIPTIONS[code];
                                    return description ? '\n' + description : '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateOccurrenceTable(data) {
            const failCodeCounts = {};
            FAIL_CODES.forEach(code => failCodeCounts[code] = 0);

            data.forEach(row => {
                for (let i = 1; i <= 12; i++) {
                    const code = row[`Fail Code ${i}`];
                    if (code && selectedCodes.has(code)) {
                        failCodeCounts[code]++;
                    }
                }
            });

            const sortedCodes = FAIL_CODES
                .filter(code => selectedCodes.has(code))
                .map(code => ({ code, count: failCodeCounts[code] }))
                .filter(item => item.count > 0)
                .sort((a, b) => b.count - a.count);

            const tableHTML = sortedCodes.map(item => `
                <div class="occurrence-row" data-code="${item.code}">
                    <div class="occurrence-code">${getColorBadge(item.code)} ${item.code}</div>
                    <div class="occurrence-count">${item.count}</div>
                </div>
            `).join('');

            document.getElementById('occurrenceTable').innerHTML = tableHTML;

            document.querySelectorAll('.occurrence-row').forEach(row => {
                row.addEventListener('mouseenter', showTooltip);
                row.addEventListener('mousemove', moveTooltip);
                row.addEventListener('mouseleave', hideTooltip);
            });
        }

        function updateTopPerformers(data) {
            const performerData = {};

            // First pass - collect all data for each team
            data.forEach(row => {
                const name = row['Team'] || 'Unknown';
                const jRef = row['J Ref'] || 'N/A';
                
                if (!performerData[name]) {
                    performerData[name] = {
                        total: 0,
                        codes: {},
                        jobNumbers: []
                    };
                }

                // Check if this row has any selected fail codes
                let hasFailCode = false;
                for (let i = 1; i <= 12; i++) {
                    const code = row[`Fail Code ${i}`];
                    if (code && selectedCodes.has(code)) {
                        hasFailCode = true;
                        performerData[name].total++;
                        performerData[name].codes[code] = (performerData[name].codes[code] || 0) + 1;
                    }
                }

                // If this row had fail codes, add the J Ref
                if (hasFailCode) {
                    performerData[name].jobNumbers.push(jRef);
                }
            });

            const sortedPerformers = Object.entries(performerData)
                .filter(([name, data]) => data.total > 0)
                .sort((a, b) => b[1].total - a[1].total);

            if (sortedPerformers.length === 0) {
                document.getElementById('topPerformers').style.display = 'none';
                return;
            }

            document.getElementById('topPerformers').style.display = 'block';

            const performersHTML = sortedPerformers.map(([name, data], index) => {
                const sortedCodes = Object.entries(data.codes)
                    .sort((a, b) => b[1] - a[1]);

                const codesHTML = sortedCodes.map(([code, count]) => `
                    <div class="fail-code-item" data-code="${code}">
                        <div class="fail-code-name">${getColorBadge(code)} ${code}</div>
                        <div class="fail-code-count">${count}</div>
                    </div>
                `).join('');

                // Sort job numbers and keep all instances (including duplicates)
                const jobNumbersArray = data.jobNumbers.sort();
                const uniqueCount = new Set(jobNumbersArray).size;
                const jobNumbersHTML = jobNumbersArray.map(jobNum => `
                    <div class="job-number-item">${jobNum}</div>
                `).join('');

                return `
                    <div class="performer-card">
                        <div class="performer-header">
                            <div class="performer-name-section">
                                <div class="performer-name">${name}</div>
                                <button class="toggle-jobs-btn" onclick="toggleJobNumbers(${index})">
                                    <span>üìã ${jobNumbersArray.length} Instance${jobNumbersArray.length !== 1 ? 's' : ''} (${uniqueCount} unique)</span>
                                    <span class="arrow">‚ñº</span>
                                </button>
                            </div>
                            <div class="performer-total">${data.total} Total Fail Codes</div>
                        </div>
                        <div class="job-numbers-section" id="job-numbers-${index}">
                            <div class="job-numbers-title">
                                üìã J Ref Numbers (${jobNumbersArray.length} instances, ${uniqueCount} unique)
                            </div>
                            <div class="job-numbers-grid">
                                ${jobNumbersHTML}
                            </div>
                        </div>
                        <div class="fail-codes-grid">
                            ${codesHTML}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('performersList').innerHTML = performersHTML;

            document.querySelectorAll('.fail-code-item').forEach(item => {
                item.addEventListener('mouseenter', showTooltip);
                item.addEventListener('mousemove', moveTooltip);
                item.addEventListener('mouseleave', hideTooltip);
            });
        }

        function toggleJobNumbers(index) {
            const section = document.getElementById(`job-numbers-${index}`);
            const button = document.querySelectorAll('.toggle-jobs-btn')[index];
            
            section.classList.toggle('show');
            button.classList.toggle('expanded');
        }

        function showTooltip(e) {
            const code = e.currentTarget.dataset.code;
            const description = FAIL_CODE_DESCRIPTIONS[code];
            
            if (!description && code) {
                const startDate = document.getElementById('startDate').valueAsDate;
                const endDate = document.getElementById('endDate').valueAsDate;
                const selectedTeam = document.getElementById('teamFilter').value;

                const filtered = allData.filter(row => {
                    const rowDate = parseDate(row['Date received']);
                    const dateMatch = (!startDate || !endDate || !rowDate) || 
                                     (rowDate >= startDate && rowDate <= endDate);
                    const teamMatch = selectedTeam === 'all' || row['Team'] === selectedTeam;
                    const teamNumberMatch = selectedTeamNumbers.size === 0 || selectedTeamNumbers.has(row['Team Number']);
                    return dateMatch && teamMatch && teamNumberMatch;
                });

                const teamRankings = getTeamsByFailCode(filtered, code);
                
                if (teamRankings.length === 0) return;

                tooltip.querySelector('.tooltip-code').textContent = code;
                tooltip.querySelector('.tooltip-description').textContent = '';
                
                const teamsHTML = `
                    <div class="tooltip-teams-title">Top Teams:</div>
                    ${teamRankings.map(([team, count]) => `
                        <div class="team-list-item">
                            <span class="team-name">${team}</span>
                            <span class="team-count">${count}</span>
                        </div>
                    `).join('')}
                `;
                tooltip.querySelector('.tooltip-teams').innerHTML = teamsHTML;
                tooltip.classList.add('show');
                moveTooltip(e);
                return;
            }

            if (!description) return;

            const startDate = document.getElementById('startDate').valueAsDate;
            const endDate = document.getElementById('endDate').valueAsDate;
            const selectedTeam = document.getElementById('teamFilter').value;

            const filtered = allData.filter(row => {
                const rowDate = parseDate(row['Date received']);
                const dateMatch = (!startDate || !endDate || !rowDate) || 
                                 (rowDate >= startDate && rowDate <= endDate);
                const teamMatch = selectedTeam === 'all' || row['Team'] === selectedTeam;
                const teamNumberMatch = selectedTeamNumbers.size === 0 || selectedTeamNumbers.has(row['Team Number']);
                return dateMatch && teamMatch && teamNumberMatch;
            });

            const teamRankings = getTeamsByFailCode(filtered, code);

            tooltip.querySelector('.tooltip-code').textContent = code;
            tooltip.querySelector('.tooltip-description').textContent = description;
            
            const teamsHTML = teamRankings.length > 0 ? `
                <div class="tooltip-teams-title">Top Teams:</div>
                ${teamRankings.map(([team, count]) => `
                    <div class="team-list-item">
                        <span class="team-name">${team}</span>
                        <span class="team-count">${count}</span>
                    </div>
                `).join('')}
            ` : '';
            tooltip.querySelector('.tooltip-teams').innerHTML = teamsHTML;
            
            tooltip.classList.add('show');
            moveTooltip(e);
        }

        function moveTooltip(e) {
            const tooltipRect = tooltip.getBoundingClientRect();
            let left = e.pageX + 15;
            let top = e.pageY + 15;

            if (left + tooltipRect.width > window.innerWidth) {
                left = e.pageX - tooltipRect.width - 15;
            }
            if (top + tooltipRect.height > window.innerHeight + window.scrollY) {
                top = e.pageY - tooltipRect.height - 15;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function hideTooltip() {
            tooltip.classList.remove('show');
        }

        // Initialize with no data message
        document.getElementById('noData').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('stats').style.display = 'none';
    </script>
</body>
</html>
