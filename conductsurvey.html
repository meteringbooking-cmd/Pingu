<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conduct Survey | Pingu - Solar</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #FFC857;
            --accent: #00D9FF;
            --dark: #1A1A2E;
            --dark-light: #252541;
            --dark-lighter: #2F2F4A;
            --text: #EAEAEA;
            --text-dim: #9A9AB0;
            --success: #4ECCA3;
            --error: #FF6B6B;
            --warning: #FFA500;
            --shadow: rgba(255, 107, 53, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--dark); color: var(--text);
            line-height: 1.6; overflow-x: hidden; min-height: 100vh;
        }
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 217, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 200, 87, 0.06) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none; z-index: -1;
        }
        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        header { margin-bottom: 2rem; animation: slideDown 0.8s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        .header-content { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .logo {
            font-family: 'Syne', sans-serif; font-size: 2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-decoration: none;
        }
        .back-btn {
            background: var(--dark-light); color: var(--text); text-decoration: none;
            padding: 0.7rem 1.5rem; border-radius: 8px; font-size: 0.9rem;
            transition: all 0.3s ease; border: 2px solid transparent;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .back-btn:hover { background: var(--dark-lighter); border-color: var(--accent); }
        h1 { font-family: 'Syne', sans-serif; font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--text); }
        .subtitle { color: var(--text-dim); font-size: 0.95rem; }
        .survey-form {
            background: var(--dark-light); border-radius: 16px; padding: 2.5rem;
            border: 2px solid var(--dark-lighter); animation: fadeInUp 1s ease-out 0.3s both;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .section-header {
            font-family: 'Syne', sans-serif; font-size: 1.5rem; color: var(--accent);
            margin: 2rem 0 1.5rem 0; padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--dark-lighter);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .section-header:first-child { margin-top: 0; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; color: var(--text); font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; }
        .form-label.required::after { content: ' *'; color: var(--error); }
        .form-input, .form-select, .form-textarea {
            width: 100%; background: var(--dark-lighter); border: 2px solid var(--dark-lighter);
            color: var(--text); padding: 1rem 1.2rem; border-radius: 12px;
            font-family: 'JetBrains Mono', monospace; font-size: 1rem; transition: all 0.3s ease;
        }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); background: var(--dark); }
        .form-input[type="number"] { -moz-appearance: textfield; }
        .form-input[type="number"]::-webkit-outer-spin-button,
        .form-input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .radio-group { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .radio-option { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .radio-option input[type="radio"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        .radio-option label { cursor: pointer; color: var(--text); }
        .file-upload-area {
            border: 2px dashed var(--dark-lighter); border-radius: 12px; padding: 2rem;
            text-align: center; background: var(--dark-lighter); transition: all 0.3s ease; cursor: pointer; margin-top: 0.5rem;
        }
        .file-upload-area:hover { border-color: var(--primary); background: var(--dark); }
        .file-upload-icon { font-size: 3rem; margin-bottom: 0.5rem; }
        .file-upload-text { color: var(--text-dim); font-size: 0.9rem; }
        .file-upload-input { display: none; }
        .uploaded-files { margin-top: 1rem; display: grid; gap: 0.75rem; }
        .uploaded-file {
            background: var(--dark); padding: 1rem; border-radius: 8px;
            display: flex; align-items: center; justify-content: space-between;
            border: 2px solid var(--dark-lighter); gap: 1rem;
        }
        .file-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .file-details { flex: 1; min-width: 0; }
        .file-name { color: var(--text); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-size { color: var(--text-dim); font-size: 0.8rem; }
        .remove-file-btn { padding: 0.5rem 1rem; background: var(--error); color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.85rem; }
        .remove-file-btn:hover { background: #ff4444; }
        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: none; }
        .alert.show { display: block; animation: slideDown 0.3s ease; }
        .alert.error { background: rgba(255, 107, 107, 0.2); color: var(--error); border: 2px solid var(--error); }
        .alert.success { background: rgba(78, 204, 163, 0.2); color: var(--success); border: 2px solid var(--success); }
        .submit-btn {
            padding: 1.2rem 2rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; border: none; border-radius: 12px;
            font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; transition: all 0.3s ease; width: 100%; margin-top: 2rem;
        }
        .submit-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 30px var(--shadow); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .job-info-card {
            background: var(--dark-lighter); padding: 1.5rem; border-radius: 12px;
            margin-bottom: 2rem; border: 2px solid var(--success); display: none;
        }
        .job-info-card.show { display: block; animation: fadeInUp 0.5s ease; }
        .job-info-header { font-family: 'Syne', sans-serif; font-size: 1.3rem; color: var(--success); margin-bottom: 1rem; }
        .job-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .job-info-item { display: flex; flex-direction: column; gap: 0.3rem; }
        .job-info-label { color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; }
        .job-info-value { color: var(--text); font-size: 1rem; font-weight: 500; }
        .loading-spinner { display: none; text-align: center; padding: 2rem; color: var(--text-dim); }
        .loading-spinner.active { display: block; }
        .conditional-field {
            margin-top: 1rem; padding: 1rem; background: var(--dark);
            border-radius: 8px; border-left: 4px solid var(--warning); display: none;
        }
        .conditional-field.show { display: block; animation: fadeInUp 0.3s ease; }
        .help-text { color: var(--text-dim); font-size: 0.85rem; margin-top: 0.3rem; font-style: italic; }
        .survey-section { display: none; }
        .survey-section.active { display: block; }
        .btn-secondary { background: var(--dark-lighter) !important; color: var(--text) !important; }
        .btn-secondary:hover { background: var(--dark) !important; }

        /* ‚îÄ‚îÄ PICKLIST PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .picklist-panel {
            display: none;
            margin-bottom: 2rem;
            padding: 1.8rem;
            background: var(--dark-lighter);
            border-radius: 14px;
            border: 2px solid rgba(255,200,87,0.35);
            animation: fadeInUp 0.6s ease-out;
        }
        .picklist-panel.show { display: block; }

        .picklist-panel-header {
            font-family: 'Syne', sans-serif;
            font-size: 1.3rem;
            color: var(--secondary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(255,200,87,0.25);
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .picklist-panel-header .pl-job-ref {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            margin-left: auto;
        }

        .pl-section-title {
            font-family: 'Syne', sans-serif;
            font-size: 0.82rem; font-weight: 700;
            color: var(--secondary); text-transform: uppercase;
            letter-spacing: 0.08em; margin: 1.4rem 0 0.7rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid rgba(255,200,87,0.18);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .pl-section-title:first-child { margin-top: 0; }

        .pl-specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
            gap: 0.65rem;
        }

        .pl-spec-item {
            background: var(--dark);
            border-radius: 9px;
            padding: 0.75rem 0.9rem 0.75rem 1rem;
            border-left: 3px solid rgba(0,217,255,0.4);
            position: relative;
        }
        .pl-spec-item.no-value { opacity: 0.38; border-left-color: transparent; }
        .pl-spec-item.cost-saving { border-left-color: var(--success); }

        .pl-spec-ref {
            position: absolute; top: 0.4rem; right: 0.55rem;
            font-size: 0.6rem; color: rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.04); padding: 0.08rem 0.3rem;
            border-radius: 3px; font-family: 'JetBrains Mono', monospace;
        }
        .pl-spec-label { font-size: 0.67rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem; }
        .pl-spec-note { font-size: 0.62rem; color: var(--text-dim); font-style: italic; }
        .pl-spec-value { font-size: 0.92rem; color: var(--text); font-weight: 500; }
        .pl-spec-value.empty { font-style: italic; color: var(--text-dim); font-size: 0.78rem; font-weight: 400; }
        .pl-spec-unit { font-size: 0.67rem; color: var(--text-dim); margin-left: 0.2rem; }

        /* Roof map inside survey */
        .pl-roof-wrap {
            margin-top: 1.4rem; padding: 1.2rem;
            background: var(--dark); border-radius: 12px;
            border: 2px solid rgba(0,217,255,0.18);
        }
        .pl-roof-hdr {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1rem; flex-wrap: wrap; gap: 0.6rem;
        }
        .pl-roof-hdr h4 { font-family: 'Syne', sans-serif; font-size: 0.95rem; color: var(--accent); display: flex; align-items: center; gap: 0.4rem; }
        .pl-legend { display: flex; gap: 1rem; flex-wrap: wrap; }
        .pl-legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.73rem; color: var(--text-dim); }
        .pl-swatch { width: 22px; height: 15px; border-radius: 3px; }
        .pl-swatch.p { background: linear-gradient(135deg,#FF6B35,#FF9559); border:1px solid rgba(255,107,53,0.6); }
        .pl-swatch.l { background: linear-gradient(135deg,#00D9FF,#00A8CC); border:1px solid rgba(0,217,255,0.6); width:28px; height:13px; }
        .pl-swatch.e { background: var(--dark-lighter); border: 1px dashed rgba(255,255,255,0.1); }
        .pl-roof-grid-wrap { overflow-x: auto; padding-bottom: 0.3rem; }
        .pl-roof-grid {
            display: inline-grid; gap: 3px; padding: 0.8rem;
            background: rgba(255,255,255,0.02); border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.04); min-width: 100%;
        }
        .pl-cell {
            width: 26px; height: 26px; border-radius: 3px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.57rem; font-weight: 700; position: relative;
            transition: transform 0.12s; cursor: default;
        }
        .pl-cell:hover { transform: scale(1.3); z-index: 5; }
        .pl-cell.e { background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.07); }
        .pl-cell.p { background: linear-gradient(135deg,#FF6B35,#FF9559); border:1px solid rgba(255,149,89,0.8); color:rgba(255,255,255,0.9); box-shadow:0 1px 5px rgba(255,107,53,0.35); }
        .pl-cell.l { background: linear-gradient(135deg,#00D9FF,#00A8CC); border:1px solid rgba(0,217,255,0.8); color:rgba(0,30,50,0.9); box-shadow:0 1px 5px rgba(0,217,255,0.3); }
        .pl-cell.p::after,.pl-cell.l::after { content:''; position:absolute; inset:3px; border:1px solid rgba(255,255,255,0.3); border-radius:1px; }
        .pl-roof-stats { display:flex; gap:1.2rem; margin-top:0.8rem; flex-wrap:wrap; }
        .pl-roof-stat { font-size:0.78rem; color:var(--text-dim); }
        .pl-roof-stat strong { color:var(--text); }

        .pl-no-picklist {
            padding: 1rem 1.2rem; background: var(--dark); border-radius: 9px;
            color: var(--text-dim); font-size: 0.85rem;
            border-left: 3px solid var(--text-dim);
        }

        .pl-loading {
            padding: 1rem; text-align: center; color: var(--text-dim);
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .survey-form { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            .section-header { font-size: 1.3rem; }
            .uploaded-file { flex-direction: column; align-items: flex-start; }
            .pl-specs-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <a href="teamview.html" class="logo">Pingu - Solar</a>
                <a href="teamview.html" class="back-btn">‚Üê Back to Dashboard</a>
            </div>
            <h1>Conduct Site Survey</h1>
            <p class="subtitle">Complete comprehensive site survey for solar installation</p>
        </header>

        <div class="survey-form">
            <div class="alert" id="alert-message"></div>

            <!-- Job Number Verification -->
            <div class="section-header">üìã Job Information</div>

            <div class="form-group">
                <label for="job-number" class="form-label required">Job Number</label>
                <input type="text" id="job-number" class="form-input" placeholder="Enter job number..." required />
            </div>
            <div class="form-group">
                <label for="survey-type" class="form-label required">Survey Type</label>
                <select id="survey-type" class="form-select" required>
                    <option value="">Select survey type...</option>
                    <option value="battery">Battery</option>
                    <option value="battery-and-solar">Battery and Solar</option>
                </select>
            </div>

            <button type="button" class="submit-btn" id="verify-btn">Verify Job Number</button>

            <div class="loading-spinner" id="loading-spinner">Loading job details...</div>

            <div class="job-info-card" id="job-info-card">
                <div class="job-info-header">‚úì Job Verified</div>
                <div class="job-info-grid" id="job-info-grid"></div>
            </div>

            <!-- ‚ïê‚ïê PICKLIST PANEL ‚Äî injected after job verified ‚ïê‚ïê -->
            <div class="picklist-panel" id="picklist-panel">
                <div class="picklist-panel-header">
                    üì¶ Picklist
                    <span class="pl-job-ref" id="pl-job-ref"></span>
                </div>
                <div id="picklist-panel-body">
                    <div class="pl-loading">Loading picklist data‚Ä¶</div>
                </div>
            </div>

            <!-- Survey Form (hidden until job verified) -->
            <form id="survey-form" style="display: none;">

                <!-- Battery Survey Section -->
                <div id="battery-survey" class="survey-section">
                    <div class="section-header">üîã Battery Survey Details</div>
                    <div class="form-group">
                        <label for="battery-survey-date" class="form-label required">Date</label>
                        <input type="date" id="battery-survey-date" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label for="battery-survey-time" class="form-label required">Time</label>
                        <input type="time" id="battery-survey-time" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label for="battery-surveyor-name" class="form-label required">Name</label>
                        <input type="text" id="battery-surveyor-name" class="form-input" placeholder="Enter your name..." required />
                    </div>
                </div>

                <!-- Battery and Solar Survey Section -->
                <div id="battery-and-solar-survey" class="survey-section">
                    <div class="section-header">üìÖ Survey Details</div>
                    <div class="form-group">
                        <label for="conducted-on" class="form-label required">Conducted On (Date and Time)</label>
                        <input type="datetime-local" id="conducted-on" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label for="surveyor" class="form-label required">Surveyor</label>
                        <input type="text" id="surveyor" class="form-input" placeholder="Enter surveyor name..." required />
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Customer Present During Survey?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="customer-yes" name="customer-present" value="Yes" required><label for="customer-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="customer-no" name="customer-present" value="No"><label for="customer-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="customer-na" name="customer-present" value="N/A"><label for="customer-na">N/A</label></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="additional-notes-customer-present" class="form-label">Additional Notes</label>
                        <textarea id="additional-notes-customer-present" class="form-textarea" placeholder="Any additional information..."></textarea>
                    </div>

                    <div class="section-header">‚ö†Ô∏è Personal Risk Assessment</div>
                    <div class="form-group">
                        <label class="form-label required">Has a Risk Assessment Been Carried Out in Accordance with the Octopus Energy Site Survey Assessment Document?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="risk-assessment-yes" name="risk-assessment" value="Yes" required><label for="risk-assessment-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="risk-assessment-no" name="risk-assessment" value="No"><label for="risk-assessment-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="risk-assessment-na" name="risk-assessment" value="N/A"><label for="risk-assessment-na">N/A</label></div>
                        </div>
                    </div>

                    <div class="section-header">‚ö° Electrical System</div>
                    <div class="form-group">
                        <label for="meter-position" class="form-label required">Position of Meter Cupboard or Incoming Supply</label>
                        <input type="text" id="meter-position" class="form-input" placeholder="Describe location..." required />
                        <div class="conditional-field show" id="meter-position-upload">
                            <label class="form-label required">Upload Photo(s) of Meter Position</label>
                            <div class="file-upload-area" onclick="document.getElementById('meter-position-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="meter-position-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="meter-position-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="meter-installation" class="form-label required">Does work need to be carried out on the meter?</label>
                        <input type="text" id="meter-work-needed" class="form-input" placeholder="Yes / No" required />
                    </div>
                    <div class="conditional-field" id="meter-installation" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">What work is required on the meter?</label>
                            <textarea id="meter-work-details" class="form-input" rows="3" placeholder="Please describe the work required..."></textarea>
                        </div>
                        <label class="form-label required">Upload Photo(s) of Meter</label>
                        <div class="file-upload-area" onclick="document.getElementById('meter-installation-files').click()">
                            <div class="file-upload-icon">üì∏</div>
                            <div class="file-upload-text">Click to upload or drag and drop photos</div>
                        </div>
                        <input type="file" id="meter-installation-files" class="file-upload-input" multiple accept="image/*">
                        <div class="uploaded-files" id="meter-installation-uploaded"></div>
                    </div>
                    <div class="form-group">
                        <label for="fuse-rating" class="form-label required">What is the Fuse Rating?</label>
                        <input type="text" id="fuse-rating" class="form-input" placeholder="e.g., 100A..." required />
                    </div>
                    <div class="form-group">
                        <label for="earthing-system" class="form-label required">Type of Earthing System</label>
                        <input type="text" id="earthing-system" class="form-input" placeholder="Describe earthing system..." required />
                        <div class="conditional-field show" id="earthing-system-upload">
                            <label class="form-label required">Upload Photo(s) of Earthing System</label>
                            <div class="file-upload-area" onclick="document.getElementById('earthing-system-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="earthing-system-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="earthing-system-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Is Gas Bonded?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="gas-bonded-yes" name="gas-bonded" value="Yes" required><label for="gas-bonded-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="gas-bonded-no" name="gas-bonded" value="No"><label for="gas-bonded-no">No</label></div>
                        </div>
                        <div class="conditional-field" id="gas-bonding-required">
                            <label for="gas-bonding-equipment" class="form-label">Equipment and Location of Bonding Required</label>
                            <input type="text" id="gas-bonding-equipment" class="form-input" placeholder="Describe equipment and location needed..." />
                        </div>
                        <label class="form-label required" style="margin-top: 1rem;">Upload Photo(s) of Gas Bonded</label>
                        <div class="file-upload-area" onclick="document.getElementById('gas-bonded-files').click()">
                            <div class="file-upload-icon">üì∏</div>
                            <div class="file-upload-text">Click to upload or drag and drop photos</div>
                        </div>
                        <input type="file" id="gas-bonded-files" class="file-upload-input" multiple accept="image/*">
                        <div class="uploaded-files" id="gas-bonded-uploaded"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Is Water Bonded?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="water-bonded-yes" name="water-bonded" value="Yes" required><label for="water-bonded-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="water-bonded-no" name="water-bonded" value="No"><label for="water-bonded-no">No</label></div>
                        </div>
                        <div class="conditional-field" id="water-bonding-required">
                            <label for="water-bonding-equipment" class="form-label">Equipment and Location of Bonding Required</label>
                            <input type="text" id="water-bonding-equipment" class="form-input" placeholder="Describe equipment and location needed..." />
                        </div>
                        <label class="form-label required" style="margin-top: 1rem;">Upload Photo(s) of Water Bonded</label>
                        <div class="file-upload-area" onclick="document.getElementById('water-bonded-files').click()">
                            <div class="file-upload-icon">üì∏</div>
                            <div class="file-upload-text">Click to upload or drag and drop photos</div>
                        </div>
                        <input type="file" id="water-bonded-files" class="file-upload-input" multiple accept="image/*">
                        <div class="uploaded-files" id="water-bonded-uploaded"></div>
                    </div>
                    <div class="form-group">
                        <label for="cable-run" class="form-label required">Describe the Cable Run(s)</label>
                        <textarea id="cable-run" class="form-textarea" placeholder="Describe the cable run(s)..." required></textarea>
                        <div class="conditional-field show" id="battery-gateway-upload">
                            <label class="form-label required">Upload Photo(s) of Cable Run</label>
                            <div class="file-upload-area" onclick="document.getElementById('cable-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="cable-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="cable-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="battery-location" class="form-label required">Battery and Inverter Location</label>
                        <input type="text" id="battery-location" class="form-input" placeholder="Describe the location..." required />
                        <div class="conditional-field show" id="battery-location-upload">
                            <label class="form-label required">Upload Photo(s) of Battery Location</label>
                            <div class="file-upload-area" onclick="document.getElementById('battery-location-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="battery-location-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="battery-location-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="surface-type" class="form-label required">Type of Surface at Battery Location</label>
                        <input type="text" id="surface-type" class="form-input" placeholder="e.g., Concrete, Wood, Brick..." required />
                        <label class="form-label required">Upload Photo(s) of Battery Surface Location</label>
                        <div class="file-upload-area" onclick="document.getElementById('surface-files').click()">
                            <div class="file-upload-icon">üì∏</div>
                            <div class="file-upload-text">Click to upload or drag and drop photos</div>
                        </div>
                        <input type="file" id="surface-files" class="file-upload-input" multiple accept="image/*">
                        <div class="uploaded-files" id="surface-uploaded"></div>
                    </div>
                    <div class="form-group">
                        <label for="battery-width" class="form-label required">Width (mm)</label>
                        <input type="number" id="battery-width" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label for="battery-depth" class="form-label required">Depth (mm)</label>
                        <input type="number" id="battery-depth" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label for="battery-length" class="form-label required">Length (mm)</label>
                        <input type="number" id="battery-length" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label for="additional-notes-battery" class="form-label">Additional Notes</label>
                        <textarea id="additional-notes-battery" class="form-textarea" placeholder="Any additional information about the battery location..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="render-cladding" class="form-label required">Any Signs of Render or Cladding?</label>
                        <input type="text" id="render-cladding" class="form-input" placeholder="Describe any render or cladding..." required />
                    </div>
                    <div class="form-group">
                        <label for="wifi-signal" class="form-label required">Is there WiFi Signal at the Proposed Inverter Location?</label>
                        <input type="text" id="wifi-signal" class="form-input" placeholder="e.g., Yes - strong signal, No - weak signal..." required />
                    </div>

                    <div class="section-header">üèöÔ∏è Property (Internal)</div>
                    <div class="form-group">
                        <label class="form-label required">Is the Loft Accessible?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="loft-accessible-yes" name="loft-accessible" value="Yes" required><label for="loft-accessible-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="loft-accessible-no" name="loft-accessible" value="No"><label for="loft-accessible-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="loft-accessible-na" name="loft-accessible" value="N/A"><label for="loft-accessible-na">N/A</label></div>
                        </div>
                        <div class="conditional-field" id="loft-accessible-upload">
                            <label class="form-label required">Upload Photo(s) of Loft Access</label>
                            <div class="file-upload-area" onclick="document.getElementById('loft-accessible-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="loft-accessible-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="loft-accessible-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Is a Loft Ladder Installed?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="loft-ladder-yes" name="loft-ladder" value="Yes" required><label for="loft-ladder-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="loft-ladder-no" name="loft-ladder" value="No"><label for="loft-ladder-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="loft-ladder-na" name="loft-ladder" value="N/A"><label for="loft-ladder-na">N/A</label></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Is the Loft Boarded?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="loft-boarded-yes" name="loft-boarded" value="Yes" required><label for="loft-boarded-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="loft-boarded-no" name="loft-boarded" value="No"><label for="loft-boarded-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="loft-boarded-na" name="loft-boarded" value="N/A"><label for="loft-boarded-na">N/A</label></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Are there any Signs of Asbestos?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="asbestos-yes" name="asbestos" value="Yes" required><label for="asbestos-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="asbestos-no" name="asbestos" value="No"><label for="asbestos-no">No</label></div>
                        </div>
                        <div class="conditional-field" id="asbestos-upload">
                            <label class="form-label required">Upload Photo(s) of Asbestos</label>
                            <div class="file-upload-area" onclick="document.getElementById('asbestos-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="asbestos-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="asbestos-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="loft-space-photos" class="form-label required">Wide Angle Inside the Loft Space</label>
                        <div class="file-upload-area" onclick="document.getElementById('loft-space-files').click()">
                            <div class="file-upload-icon">üì∏</div>
                            <div class="file-upload-text">Click to upload or drag and drop photos</div>
                        </div>
                        <input type="file" id="loft-space-files" class="file-upload-input" multiple accept="image/*">
                        <div class="uploaded-files" id="loft-space-uploaded"></div>
                    </div>
                    <div class="form-group">
                        <label for="rafter-width" class="form-label required">Rafter Width (mm)</label>
                        <input type="number" id="rafter-width" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label for="rafter-depth" class="form-label required">Rafter Depth (mm)</label>
                        <input type="number" id="rafter-depth" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label for="web-width" class="form-label required">Web Width (mm)</label>
                        <input type="number" id="web-width" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label for="web-depth" class="form-label required">Web Depth (mm)</label>
                        <input type="number" id="web-depth" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label for="web-length" class="form-label required">Web Length (mm)</label>
                        <input type="number" id="web-length" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label for="truss-spacing" class="form-label required">Truss Spacing (mm)</label>
                        <input type="number" id="truss-spacing" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Are there any Signs of Deflection to the Existing Roof Slopes?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="deflection-yes" name="roof-deflection" value="Yes" required><label for="deflection-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="deflection-no" name="roof-deflection" value="No"><label for="deflection-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="deflection-na" name="roof-deflection" value="N/A"><label for="deflection-na">N/A</label></div>
                        </div>
                        <div class="conditional-field" id="deflection-upload">
                            <label class="form-label required">Upload Photo(s) of Roof Deflection</label>
                            <div class="file-upload-area" onclick="document.getElementById('deflection-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="deflection-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="deflection-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Are there any Signs of Rot/Damage to the Internal Roof Structure?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="rot-damage-yes" name="rot-damage" value="Yes" required><label for="rot-damage-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="rot-damage-no" name="rot-damage" value="No"><label for="rot-damage-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="rot-damage-na" name="rot-damage" value="N/A"><label for="rot-damage-na">N/A</label></div>
                        </div>
                        <div class="conditional-field" id="rot-damage-upload">
                            <label class="form-label required">Upload Photo(s) of Rot/Damage</label>
                            <div class="file-upload-area" onclick="document.getElementById('rot-damage-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="rot-damage-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="rot-damage-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Are there any Signs of Anything Which Would Cause for Concern When Fitting Panels to the Roof?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="roof-concern-yes" name="roof-concern" value="Yes" required><label for="roof-concern-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="roof-concern-no" name="roof-concern" value="No"><label for="roof-concern-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="roof-concern-na" name="roof-concern" value="N/A"><label for="roof-concern-na">N/A</label></div>
                        </div>
                        <div class="conditional-field" id="roof-concern-upload">
                            <label class="form-label required">Upload Photo(s) of Concerns</label>
                            <div class="file-upload-area" onclick="document.getElementById('roof-concern-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="roof-concern-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="roof-concern-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Are there any Dwarf Walls/Props Which Support the Purlins?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="dwarf-walls-yes" name="dwarf-walls" value="Yes" required><label for="dwarf-walls-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="dwarf-walls-no" name="dwarf-walls" value="No"><label for="dwarf-walls-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="dwarf-walls-na" name="dwarf-walls" value="N/A"><label for="dwarf-walls-na">N/A</label></div>
                        </div>
                        <div class="conditional-field" id="dwarf-walls-upload">
                            <label class="form-label required">Upload Photo(s) of Dwarf Walls/Props</label>
                            <div class="file-upload-area" onclick="document.getElementById('dwarf-walls-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="dwarf-walls-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="dwarf-walls-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Is there any Signs of Structural Work Which Has Been Carried Out to the Roof Structure Before?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="structural-work-yes" name="structural-work" value="Yes" required><label for="structural-work-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="structural-work-no" name="structural-work" value="No"><label for="structural-work-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="structural-work-na" name="structural-work" value="N/A"><label for="structural-work-na">N/A</label></div>
                        </div>
                        <div class="conditional-field" id="structural-work-upload">
                            <label class="form-label required">Upload Photo(s) of Structural Work</label>
                            <div class="file-upload-area" onclick="document.getElementById('structural-work-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="structural-work-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="structural-work-uploaded"></div>
                        </div>
                    </div>

                    <div class="section-header">üèöÔ∏è Property (External)</div>
                    <div class="form-group">
                        <label class="form-label required">Does the Proposed Design Fit?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="proposed-design-yes" name="proposed-design" value="Yes" required><label for="proposed-design-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="proposed-design-no" name="proposed-design" value="No"><label for="proposed-design-no">No</label></div>
                        </div>
                        <div class="conditional-field" id="proposed-design-reason">
                            <label for="proposed-design-reason-text" class="form-label">Why Doesn't the Proposed Design Fit?</label>
                            <textarea id="proposed-design-reason-text" class="form-textarea" placeholder="Please explain why the proposed design doesn't fit..."></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="property-photos" class="form-label required">Wide Angle Shots of the Property Including All Property Faces</label>
                        <div class="file-upload-area" onclick="document.getElementById('property-photos-files').click()">
                            <div class="file-upload-icon">üì∏</div>
                            <div class="file-upload-text">Click to upload or drag and drop photos</div>
                        </div>
                        <input type="file" id="property-photos-files" class="file-upload-input" multiple accept="image/*">
                        <div class="uploaded-files" id="property-photos-uploaded"></div>
                    </div>
                    <div class="form-group">
                        <label for="roof-covering" class="form-label required">What is the Roof Covering Type?</label>
                        <input type="text" id="roof-covering" class="form-input" placeholder="e.g., Tiles, Slate, Metal..." required />
                        <div class="conditional-field show" id="roof-covering-upload">
                            <label class="form-label required">Upload Photo(s) of Roof Covering</label>
                            <div class="file-upload-area" onclick="document.getElementById('roof-covering-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="roof-covering-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="roof-covering-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="number-stories" class="form-label required">Number of Stories</label>
                        <input type="number" id="number-stories" class="form-input" placeholder="0" step="1" min="1" required />
                    </div>
                    <div class="form-group">
                        <label for="roof-condition" class="form-label required">Condition of Roof?</label>
                        <input type="text" id="roof-condition" class="form-input" placeholder="Good, Poor..." required />
                        <div class="conditional-field show">
                            <label class="form-label required">Upload Photo(s) of Roof Condition</label>
                            <div class="file-upload-area" onclick="document.getElementById('roof-condition-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="roof-condition-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="roof-condition-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="roof-work-age" class="form-label required">How Many Years Ago was the Last Work Carried Out on the Roof?</label>
                        <input type="number" id="roof-work-age" class="form-input" placeholder="0" step="1" min="0" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Are there any Obstructions on the Roof?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="obstructions-yes" name="roof-obstructions" value="Yes" required><label for="obstructions-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="obstructions-no" name="roof-obstructions" value="No"><label for="obstructions-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="obstructions-na" name="roof-obstructions" value="N/A"><label for="obstructions-na">N/A</label></div>
                        </div>
                        <div class="conditional-field" id="obstructions-upload">
                            <div class="form-group" style="margin: 0 0 1rem 0;">
                                <label for="obstructions-description" class="form-label">What Obstructions Are There?</label>
                                <input type="text" id="obstructions-description" class="form-input" placeholder="Describe the obstructions on the roof..." />
                            </div>
                            <label class="form-label required">Upload Photo(s) of Roof Obstructions</label>
                            <div class="file-upload-area" onclick="document.getElementById('obstructions-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="obstructions-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="obstructions-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Is there any Form of Shading?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="shading-yes" name="roof-shading" value="Yes" required><label for="shading-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="shading-no" name="roof-shading" value="No"><label for="shading-no">No</label></div>
                            <div class="radio-option"><input type="radio" id="shading-na" name="roof-shading" value="N/A"><label for="shading-na">N/A</label></div>
                        </div>
                        <div class="conditional-field" id="shading-upload">
                            <label class="form-label required">Upload Photo(s) of Shading</label>
                            <div class="file-upload-area" onclick="document.getElementById('shading-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="shading-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="shading-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="additional-notes-property" class="form-label">Additional Notes</label>
                        <textarea id="additional-notes-property" class="form-textarea" placeholder="Any additional information about the property..."></textarea>
                    </div>

                    <div class="section-header">üèóÔ∏è Scaffolding</div>
                    <div class="form-group">
                        <label for="access-type" class="form-label required">Type of Access to Property</label>
                        <select id="access-type" class="form-select" required>
                            <option value="">Select access type...</option>
                            <option value="Drive">Drive</option>
                            <option value="Path">Path</option>
                            <option value="On Road">On Road</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Parking Available?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="parking-yes" name="parking-available" value="Yes" required><label for="parking-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="parking-no" name="parking-available" value="No"><label for="parking-no">No</label></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Are there any Overhead Powerlines Close to the Property?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="powerlines-yes" name="overhead-powerlines" value="Yes" required><label for="powerlines-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="powerlines-no" name="overhead-powerlines" value="No"><label for="powerlines-no">No</label></div>
                        </div>
                        <div class="conditional-field" id="powerlines-upload">
                            <label class="form-label required">Upload Photo(s) of Overhead Powerlines</label>
                            <div class="file-upload-area" onclick="document.getElementById('powerlines-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="powerlines-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="powerlines-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Is the Property on a Pavement or Main Highway?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="pavement-yes" name="property-location" value="Yes" required><label for="pavement-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="pavement-no" name="property-location" value="No"><label for="pavement-no">No</label></div>
                        </div>
                        <div class="conditional-field" id="pavement-upload">
                            <label class="form-label required">Upload Photo(s) of Property Location</label>
                            <div class="file-upload-area" onclick="document.getElementById('pavement-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="pavement-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="pavement-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ground-type" class="form-label required">Type of Ground Around for Scaffolding</label>
                        <input type="text" id="ground-type" class="form-input" placeholder="e.g., Concrete, Grass, Paving..." required />
                        <label class="form-label required" style="margin-top: 1rem;">Upload Photo(s) of Ground Type</label>
                        <p class="help-text">Please upload a minimum of 3 photos</p>
                        <div class="file-upload-area" onclick="document.getElementById('ground-type-files').click()">
                            <div class="file-upload-icon">üì∏</div>
                            <div class="file-upload-text">Click to upload or drag and drop photos</div>
                        </div>
                        <input type="file" id="ground-type-files" class="file-upload-input" multiple accept="image/*">
                        <div class="uploaded-files" id="ground-type-uploaded"></div>
                    </div>
                    <div class="form-group">
                        <label for="access-issues" class="form-label required">Any Access Issues?</label>
                        <textarea id="access-issues" class="form-textarea" placeholder="Describe any access issues..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Any Obstacles Below the Gutter Line?</label>
                        <div class="radio-group">
                            <div class="radio-option"><input type="radio" id="gutter-obstacles-yes" name="gutter-obstacles" value="Yes" required><label for="gutter-obstacles-yes">Yes</label></div>
                            <div class="radio-option"><input type="radio" id="gutter-obstacles-no" name="gutter-obstacles" value="No"><label for="gutter-obstacles-no">No</label></div>
                        </div>
                        <div class="conditional-field" id="gutter-obstacles-upload">
                            <div class="form-group" style="margin: 0 0 1rem 0;">
                                <label for="gutter-obstacles-description" class="form-label">What Obstacles Are There?</label>
                                <input type="text" id="gutter-obstacles-description" class="form-input" placeholder="Describe the obstacles below the gutter line..." />
                            </div>
                            <label class="form-label required">Upload Photo(s) of Obstacles</label>
                            <div class="file-upload-area" onclick="document.getElementById('gutter-obstacles-files').click()">
                                <div class="file-upload-icon">üì∏</div>
                                <div class="file-upload-text">Click to upload or drag and drop photos</div>
                            </div>
                            <input type="file" id="gutter-obstacles-files" class="file-upload-input" multiple accept="image/*">
                            <div class="uploaded-files" id="gutter-obstacles-uploaded"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="lower-roofs" class="form-label">Lower Roofs - Are They Weight Bearing or To Be Avoided?</label>
                        <textarea id="lower-roofs" class="form-textarea" placeholder="Describe lower roofs..."></textarea>
                        <label class="form-label required" style="margin-top: 1rem;">Upload Photo(s) of Lower Roofs</label>
                        <div class="file-upload-area" onclick="document.getElementById('lower-roofs-files').click()">
                            <div class="file-upload-icon">üì∏</div>
                            <div class="file-upload-text">Click to upload or drag and drop photos</div>
                        </div>
                        <input type="file" id="lower-roofs-files" class="file-upload-input" multiple accept="image/*">
                        <div class="uploaded-files" id="lower-roofs-uploaded"></div>
                    </div>
                    <div class="form-group">
                        <label for="scaffolding-additional-notes" class="form-label">Scaffolding Additional Notes</label>
                        <textarea id="scaffolding-additional-notes" class="form-textarea" placeholder="Any additional information about scaffolding..."></textarea>
                    </div>

                    <div class="section-header">‚úçÔ∏è Customer Sign-off</div>
                    <div class="form-group">
                        <label for="signoff-date" class="form-label required">Date</label>
                        <input type="date" id="signoff-date" class="form-input" required />
                    </div>
                    <div class="form-group">
                        <label for="signoff-name" class="form-label required">Customer Name</label>
                        <input type="text" id="signoff-name" class="form-input" placeholder="Enter customer name..." required />
                    </div>

                    <button type="submit" class="submit-btn" id="submit-btn">Submit Survey</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, doc, setDoc, orderBy, limit }
            from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL }
            from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAc_yJQ_rkzuOBh-Yxg0Q4eooXtB-tQjm0",
            authDomain: "pingu-solar.firebaseapp.com",
            projectId: "pingu-solar",
            storageBucket: "pingu-solar.firebasestorage.app",
            messagingSenderId: "232764952866",
            appId: "1:232764952866:web:5923b7f419de6355d6157b",
            measurementId: "G-PFH059DZ64"
        };

        const app = initializeApp(firebaseConfig);
        const db  = getFirestore(app);
        const storage = getStorage(app);
        window.db = db;
        window.storage = storage;
        window.firebaseModules = { collection, getDocs, query, where, doc, setDoc, ref, uploadBytesResumable, getDownloadURL, orderBy, limit };
    </script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){ emailjs.init("ziLnha91scpGjFABh"); })();
    </script>

    <script>
        let verifiedJob = null;
        let uploadedFiles = {};
        let selectedSurveyType = null;
        const PROGRESS_KEY_PREFIX = 'survey_progress_';

        // ‚îÄ‚îÄ Spec definitions (mirrors picklist generator) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const SPECS = {
            system: [
                {label:'Type of System',     col:'AO', row:2},
                {label:'Inverter Size',      col:'AO', row:4,  note:'Fox & Tesla'},
                {label:'No. of Batteries',   col:'AO', row:6},
                {label:'Battery',            col:'AO', row:7},
                {label:'Retrofit',           col:'AO', row:8,  note:'Fox only'},
                {label:'Enphase Pedestal',   col:'AO', row:17},
                {label:'Enphase Branches',   col:'AO', row:12},
                {label:'DC Expansion',       col:'AO', row:21, note:'Tesla'},
            ],
            mounting: [
                {label:'Mounting System',    col:'AS', row:2},
                {label:'Hook Type',          col:'AS', row:4},
                {label:'Ave Hook Spacing',   col:'AS', row:6,  unit:'mm'},
                {label:'Hook Spacing',       col:'AS', row:7,  unit:'mm'},
                {label:'Min. Roof Anchors',  col:'AS', row:12},
                {label:'Bird Mesh',          col:'AS', row:14},
                {label:'Roof Type',          col:'AS', row:16},
                {label:'Rafter Spacing',     col:'AS', row:17},
            ],
            electrical: [
                {label:'Supply Cables',      col:'AO', row:10},
                {label:'Submain Location',   col:'AO', row:15},
                {label:'Trenching',          col:'AO', row:19},
            ]
        };
        const MOUNT_CHECK_CELLS = [
            {label:'# Portrait Panels',        col:'I', row:23},
            {label:'# Landscape Panels',       col:'I', row:24},
            {label:'Total Panels',             col:'I', row:25},
            {label:'Total Perimeter',          col:'I', row:26},
            {label:'End Clamps',               col:'S', row:23},
            {label:'Mid Clamps',               col:'S', row:24},
            {label:'Rail Length',              col:'S', row:25},
            {label:'# Roof Anchors',           col:'S', row:26},
            {label:'New Picklist Cost Saving', col:'R', row:28, highlight:true},
        ];

        // ‚îÄ‚îÄ Picklist panel renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function esc(t){ const d=document.createElement('div'); d.textContent=String(t||''); return d.innerHTML; }

        function plSpecCard(label, value, ref, note, unit, highlight) {
            const hasVal = !!value;
            const noteH  = note ? `<span class="pl-spec-note"> (${note})</span>` : '';
            const unitH  = (value && unit) ? `<span class="pl-spec-unit">${unit}</span>` : '';
            const extra  = highlight ? ' cost-saving' : '';
            return `<div class="pl-spec-item${hasVal ? '' : ' no-value'}${extra}">
                <div class="pl-spec-ref">${esc(ref)}</div>
                <div class="pl-spec-label">${esc(label)}${noteH}</div>
                <div class="pl-spec-value${hasVal ? '' : ' empty'}">${hasVal ? esc(value) + unitH : '‚Äî'}</div>
            </div>`;
        }

        function renderPicklistPanel(d) {
            const body = document.getElementById('picklist-panel-body');
            const savedDate = d.savedAt ? new Date(d.savedAt).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : '';
            document.getElementById('pl-job-ref').textContent = savedDate ? `Saved ${savedDate}` : '';

            let html = '';

            // System config
            if (d.specs) {
                const grp = (defs) => defs.map(def => {
                    const v = d.specs[def.label] || '';
                    return plSpecCard(def.label, v, `${def.col}${def.row}`, def.note, def.unit, def.highlight);
                }).join('');

                html += `<div class="pl-section-title">‚ö° System Configuration</div>
                         <div class="pl-specs-grid">${grp(SPECS.system)}</div>`;
                html += `<div class="pl-section-title">üî© Mounting &amp; Hardware</div>
                         <div class="pl-specs-grid">${grp(SPECS.mounting)}</div>`;
                html += `<div class="pl-section-title">üîå Electrical &amp; Supply</div>
                         <div class="pl-specs-grid">${grp(SPECS.electrical)}</div>`;
            }

            // Mount check
            if (d.mountCheck) {
                const mcCards = MOUNT_CHECK_CELLS.map(def => {
                    const v = d.mountCheck[def.label] || '';
                    return plSpecCard(def.label, v, `${def.col}${def.row}`, def.note, def.unit, def.highlight);
                }).join('');
                html += `<div class="pl-section-title">‚úÖ Mount System Sense Check</div>
                         <div class="pl-specs-grid">${mcCards}</div>`;
            }

            // Panel map
            const flatArr = d.panelFlat || (d.panelGrid ? d.panelGrid.flat() : null);
            const cols = d.panelCols || (d.panelGrid?.[0]?.length) || 0;
            if (flatArr && cols) {
                let pC=0, lC=0, cells='';
                flatArr.forEach(v => {
                    if(v==='P') pC++; if(v==='L') lC++;
                    const cls = v==='P'?'p': v==='L'?'l':'e';
                    cells += `<div class="pl-cell ${cls}" title="${v==='P'?'Portrait':v==='L'?'Landscape':'Empty'}">${v==='P'?'P':v==='L'?'L':''}</div>`;
                });
                if (pC || lC) {
                    html += `<div class="pl-roof-wrap">
                        <div class="pl-roof-hdr">
                            <h4>üè† Roof Panel Layout <span style="color:var(--text-dim);font-size:0.72rem;font-family:'JetBrains Mono'">(B3:AI18)</span></h4>
                            <div class="pl-legend">
                                <div class="pl-legend-item"><div class="pl-swatch p"></div>Portrait</div>
                                <div class="pl-legend-item"><div class="pl-swatch l"></div>Landscape</div>
                                <div class="pl-legend-item"><div class="pl-swatch e"></div>Empty</div>
                            </div>
                        </div>
                        <div class="pl-roof-grid-wrap">
                            <div class="pl-roof-grid" style="grid-template-columns:repeat(${cols},26px)">${cells}</div>
                        </div>
                        <div class="pl-roof-stats">
                            <div class="pl-roof-stat">üüß Portrait: <strong>${pC}</strong></div>
                            <div class="pl-roof-stat">üü¶ Landscape: <strong>${lC}</strong></div>
                            <div class="pl-roof-stat">üìê Total: <strong>${pC+lC}</strong></div>
                        </div>
                    </div>`;
                }
            }

            body.innerHTML = html || '<div class="pl-no-picklist">Picklist found but contains no data.</div>';
        }

        async function loadPicklistForJob(jobNumber) {
            const panel = document.getElementById('picklist-panel');
            const body  = document.getElementById('picklist-panel-body');
            panel.classList.add('show');
            body.innerHTML = '<div class="pl-loading">Loading picklist data‚Ä¶</div>';

            try {
                const { collection, query, where, getDocs, orderBy, limit } = window.firebaseModules;
                // Get the most recent picklist for this job number
                const q = query(
                    collection(window.db, 'picklists'),
                    where('jobNumber', '==', jobNumber),
                    orderBy('savedAt', 'desc'),
                    limit(1)
                );
                const snap = await getDocs(q);

                if (snap.empty) {
                    body.innerHTML = '<div class="pl-no-picklist">üì≠ No picklist found for this job. Upload one via the Picklist Generator.</div>';
                    return;
                }

                renderPicklistPanel(snap.docs[0].data());

            } catch (err) {
                console.error('Picklist load error:', err);
                body.innerHTML = `<div class="pl-no-picklist" style="border-color:var(--error);color:var(--error)">Failed to load picklist: ${esc(err.message)}</div>`;
            }
        }

        // ‚îÄ‚îÄ Progress helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getProgressKey() { return verifiedJob ? PROGRESS_KEY_PREFIX + verifiedJob['Job Number'] : null; }
        function saveProgress() {
            const key = getProgressKey(); if (!key) return;
            const form = document.getElementById('survey-form');
            const data = { surveyType: selectedSurveyType };
            form.querySelectorAll('input[type="text"],input[type="number"],input[type="datetime-local"],input[type="date"],input[type="time"],textarea,select').forEach(el => { if(el.id) data[el.id]=el.value; });
            form.querySelectorAll('input[type="radio"]:checked').forEach(el => { data[el.name]=el.value; });
            localStorage.setItem(key, JSON.stringify(data));
        }
        function loadProgress() {
            const key = getProgressKey(); if (!key) return;
            const saved = localStorage.getItem(key); if (!saved) return;
            const data = JSON.parse(saved);
            const form = document.getElementById('survey-form');
            Object.keys(data).forEach(k => {
                const el = form.querySelector('#'+k) || form.querySelector('input[name="'+k+'"]');
                if (el) { if(el.type==='radio') { const r=form.querySelector('input[name="'+k+'"][value="'+data[k]+'"]'); if(r)r.checked=true; } else { el.value=data[k]; } }
            });
        }
        function clearProgress() { const key=getProgressKey(); if(key)localStorage.removeItem(key); }

        function escapeHtml(text) { const div=document.createElement('div'); div.textContent=text||'N/A'; return div.innerHTML; }
        function showAlert(message, type='error') {
            const alert=document.getElementById('alert-message');
            alert.textContent=message; alert.className='alert '+type+' show';
            setTimeout(()=>alert.classList.remove('show'),5000);
            window.scrollTo({top:0,behavior:'smooth'});
        }
        function addFilePreview(file,fieldId,uploadedDiv) {
            const reader=new FileReader();
            reader.onload=function(e){
                const fileDiv=document.createElement('div'); fileDiv.className='uploaded-file';
                fileDiv.innerHTML='<img src="'+e.target.result+'" class="file-preview" alt="Photo preview"><div class="file-details"><div class="file-name">'+escapeHtml(file.name)+'</div><div class="file-size">'+(file.size/1024/1024).toFixed(2)+' MB</div></div><button type="button" class="remove-file-btn">Remove</button>';
                fileDiv.querySelector('.remove-file-btn').addEventListener('click',()=>{ uploadedFiles[fieldId]=uploadedFiles[fieldId].filter(f=>f.name!==file.name||f.size!==file.size||f.lastModified!==file.lastModified); fileDiv.remove(); });
                uploadedDiv.appendChild(fileDiv);
            };
            reader.readAsDataURL(file);
        }
        function setupFileUploads() {
            const uploadFields=['meter-position-files','meter-installation-files','earthing-system-files','gas-bonded-files','water-bonded-files','cable-files','battery-location-files','surface-files','loft-accessible-files','asbestos-files','deflection-files','rot-damage-files','roof-concern-files','dwarf-walls-files','structural-work-files','loft-space-files','property-photos-files','roof-covering-files','roof-condition-files','obstructions-files','shading-files','powerlines-files','pavement-files','ground-type-files','gutter-obstacles-files','lower-roofs-files'];
            uploadFields.forEach(fieldId => {
                const input=document.getElementById(fieldId);
                const uploadedDiv=document.getElementById(fieldId.replace('-files','-uploaded'));
                if(!input||!uploadedDiv)return;
                uploadedFiles[fieldId]=[];
                input.addEventListener('change',(e)=>{ Array.from(e.target.files).forEach(file=>{ if(file.type.startsWith('image/')){ uploadedFiles[fieldId].push(file); addFilePreview(file,fieldId,uploadedDiv); } }); input.value=''; });
            });
        }
        async function sendMeterWorkEmail() {
            const meterWorkDetails=document.getElementById('meter-work-details')?document.getElementById('meter-work-details').value:'';
            const meterWorkNeeded=document.getElementById('meter-work-needed')?document.getElementById('meter-work-needed').value:'';
            if(meterWorkNeeded.trim().toLowerCase()!=='yes'||!meterWorkDetails.trim())return;
            if(!verifiedJob){showAlert('Please verify job number first','error');return;}
            const meterFiles=uploadedFiles['meter-installation-files']||[];
            let photoLinks='No photos uploaded yet';
            if(meterFiles.length>0){try{const uploadPromises=meterFiles.map(async(file,i)=>{const path='meter-work/'+verifiedJob['Job Number']+'/'+Date.now()+'_'+i+'_'+file.name;const url=await uploadFileToStorage(file,path);return'Photo '+(i+1)+': '+url;});const urls=await Promise.all(uploadPromises);photoLinks=urls.join('\n');}catch(error){photoLinks='Error uploading photos';}}
            const emailData={job_number:verifiedJob['Job Number']||'N/A',customer_name:verifiedJob['Name']||'N/A',address:verifiedJob['1st line of address']||'N/A',postcode:verifiedJob['Postcode']||'N/A',install_date:verifiedJob['Install Date']||'TBD',meter_work_details:meterWorkDetails,photo_links:photoLinks};
            try{await emailjs.send('service_o75fskf','template_ijhp8qj',emailData);showAlert('Meter work notification sent successfully!','success');}catch(error){showAlert('Warning: Could not send meter work notification email','error');}
        }
        function setupConditionalFields() {
            const radioFieldsWithPhotos=[
                {name:'roof-obstructions',value:'Yes',upload:'obstructions-upload'},
                {name:'roof-shading',value:'Yes',upload:'shading-upload'},
                {name:'loft-accessible',values:['Yes','No'],upload:'loft-accessible-upload'},
                {name:'asbestos',value:'Yes',upload:'asbestos-upload'},
                {name:'roof-deflection',value:'Yes',upload:'deflection-upload'},
                {name:'rot-damage',value:'Yes',upload:'rot-damage-upload'},
                {name:'roof-concern',value:'Yes',upload:'roof-concern-upload'},
                {name:'dwarf-walls',value:'Yes',upload:'dwarf-walls-upload'},
                {name:'structural-work',value:'Yes',upload:'structural-work-upload'},
                {name:'gas-bonded',value:'No',upload:'gas-bonding-required'},
                {name:'water-bonded',value:'No',upload:'water-bonding-required'},
                {name:'overhead-powerlines',value:'Yes',upload:'powerlines-upload'},
                {name:'property-location',value:'Yes',upload:'pavement-upload'},
                {name:'gutter-obstacles',value:'Yes',upload:'gutter-obstacles-upload'},
                {name:'proposed-design',value:'No',upload:'proposed-design-reason'}
            ];
            radioFieldsWithPhotos.forEach(field=>{
                const radios=document.querySelectorAll('input[name="'+field.name+'"]');
                const upload=document.getElementById(field.upload);
                if(upload){radios.forEach(radio=>{radio.addEventListener('change',()=>{const values=Array.isArray(field.values)?field.values:[field.value];upload.classList.toggle('show',values.includes(radio.value));});});}
            });
            const meterWorkInput=document.getElementById('meter-work-needed');
            const meterSection=document.getElementById('meter-installation');
            const meterWorkDetails=document.getElementById('meter-work-details');
            if(meterWorkInput&&meterSection){
                meterWorkInput.addEventListener('input',function(e){const answer=e.target.value.trim().toLowerCase();if(answer==='yes'){meterSection.style.display='block';}else if(answer==='no'){meterSection.style.display='none';}});
                if(meterWorkDetails){meterWorkDetails.addEventListener('blur',async function(){if(meterWorkInput.value.trim().toLowerCase()==='yes'&&this.value.trim()){setTimeout(()=>sendMeterWorkEmail(),2000);}});}
            }
        }
        function showSurveySection(surveyType) {
            selectedSurveyType=surveyType;
            const batterySection=document.getElementById('battery-survey');
            const batterySolarSection=document.getElementById('battery-and-solar-survey');
            batterySection.classList.remove('active'); batterySolarSection.classList.remove('active');
            batterySection.querySelectorAll('[required]').forEach(field=>{field.removeAttribute('required');field.dataset.wasRequired='true';});
            batterySolarSection.querySelectorAll('[required]').forEach(field=>{field.removeAttribute('required');field.dataset.wasRequired='true';});
            if(surveyType==='battery'){batterySection.classList.add('active');batterySection.querySelectorAll('[data-was-required="true"]').forEach(field=>{field.setAttribute('required','required');});}
            else if(surveyType==='battery-and-solar'){batterySolarSection.classList.add('active');batterySolarSection.querySelectorAll('[data-was-required="true"]').forEach(field=>{if(field.id!=='meter-work-details'){field.setAttribute('required','required');}});}
        }

        async function verifyJobNumber() {
            const jobNumber=document.getElementById('job-number').value.trim();
            const surveyType=document.getElementById('survey-type').value;
            if(!jobNumber){showAlert('Please enter a job number','error');return;}
            if(!surveyType){showAlert('Please select a survey type','error');return;}
            const verifyBtn=document.getElementById('verify-btn');
            const loadingSpinner=document.getElementById('loading-spinner');
            verifyBtn.disabled=true; verifyBtn.textContent='Verifying...';
            loadingSpinner.classList.add('active');
            try{
                const{collection,getDocs,query,where}=window.firebaseModules;
                const jobsQuery=query(collection(window.db,'jobs'),where('Job Number','==',jobNumber));
                const snapshot=await getDocs(jobsQuery);
                if(snapshot.empty){showAlert('Job number not found in database.','error');verifyBtn.disabled=false;verifyBtn.textContent='Verify Job Number';loadingSpinner.classList.remove('active');return;}
                snapshot.forEach(doc=>{verifiedJob={id:doc.id,...doc.data()};});
                const grid=document.getElementById('job-info-grid');
                const surveyTypeDisplay=surveyType==='battery-and-solar'?'Battery and Solar':surveyType.charAt(0).toUpperCase()+surveyType.slice(1);
                grid.innerHTML=
                    '<div class="job-info-item"><div class="job-info-label">Job Number</div><div class="job-info-value">'+escapeHtml(verifiedJob['Job Number'])+'</div></div>'+
                    '<div class="job-info-item"><div class="job-info-label">Customer</div><div class="job-info-value">'+escapeHtml(verifiedJob['Name'])+'</div></div>'+
                    '<div class="job-info-item"><div class="job-info-label">Address</div><div class="job-info-value">'+escapeHtml(verifiedJob['1st line of address'])+'</div></div>'+
                    '<div class="job-info-item"><div class="job-info-label">Postcode</div><div class="job-info-value">'+escapeHtml(verifiedJob['Postcode'])+'</div></div>'+
                    '<div class="job-info-item"><div class="job-info-label">Install Date</div><div class="job-info-value">'+escapeHtml(verifiedJob['Install Date']||'TBD')+'</div></div>'+
                    '<div class="job-info-item"><div class="job-info-label">Lead Engineer</div><div class="job-info-value">'+escapeHtml(verifiedJob['Lead Engineer']||'Unassigned')+'</div></div>'+
                    '<div class="job-info-item"><div class="job-info-label">Survey Type</div><div class="job-info-value">'+escapeHtml(surveyTypeDisplay)+'</div></div>';
                document.getElementById('job-info-card').classList.add('show');

                // ‚îÄ‚îÄ Load picklist for this job ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                await loadPicklistForJob(jobNumber);

                document.getElementById('survey-form').style.display='block';
                showSurveySection(surveyType);
                verifyBtn.style.display='none';
                document.getElementById('job-number').disabled=true;
                document.getElementById('survey-type').disabled=true;
                loadingSpinner.classList.remove('active');
                loadProgress();
                showAlert('Job verified successfully! Review the picklist above, then continue the survey.','success');
            }catch(error){
                console.error(error);
                showAlert('Error verifying job number.','error');
                verifyBtn.disabled=false; verifyBtn.textContent='Verify Job Number';
                loadingSpinner.classList.remove('active');
            }
        }

        async function uploadFileToStorage(file,path){
            const{ref,uploadBytesResumable,getDownloadURL}=window.firebaseModules;
            const storageRef=ref(window.storage,path);
            const uploadTask=uploadBytesResumable(storageRef,file);
            return new Promise((resolve,reject)=>{uploadTask.on('state_changed',null,reject,async()=>{const url=await getDownloadURL(uploadTask.snapshot.ref);resolve(url);});});
        }

        async function submitSurvey(event){
            event.preventDefault();
            const form=document.getElementById('survey-form');
            if(!form.checkValidity()){showAlert('Please fill in all required fields','error');form.reportValidity();return;}
            const submitBtn=document.getElementById('submit-btn');
            submitBtn.disabled=true; submitBtn.textContent='Submitting...';
            try{
                let surveyData={jobNumber:verifiedJob['Job Number'],jobId:verifiedJob.id,submittedAt:new Date().toISOString(),status:'completed',surveyType:selectedSurveyType};
                if(selectedSurveyType==='battery'){
                    surveyData.sections={batteryDetails:{date:document.getElementById('battery-survey-date')?document.getElementById('battery-survey-date').value:'',time:document.getElementById('battery-survey-time')?document.getElementById('battery-survey-time').value:'',name:document.getElementById('battery-surveyor-name')?document.getElementById('battery-surveyor-name').value:''}};
                }else if(selectedSurveyType==='battery-and-solar'){
                    const photoUrls={};
                    for(const[fieldId,files]of Object.entries(uploadedFiles)){if(files.length>0){const promises=files.map(async(file,i)=>{const path='surveys/'+verifiedJob['Job Number']+'/'+fieldId+'/'+Date.now()+'_'+i+'_'+file.name;return await uploadFileToStorage(file,path);});photoUrls[fieldId]=await Promise.all(promises);}else{photoUrls[fieldId]=[];}}
                    const getVal=id=>{const el=document.getElementById(id);return el?el.value:'';};
                    const getRadio=name=>{const el=document.querySelector('input[name="'+name+'"]:checked');return el?el.value:'';};
                    surveyData.sections={
                        surveyDetails:{conductedOn:getVal('conducted-on'),surveyor:getVal('surveyor'),customerPresent:getRadio('customer-present'),additionalNotesCustomerPresent:getVal('additional-notes-customer-present')},
                        riskAssessment:{riskAssessmentDone:getRadio('risk-assessment')},
                        electricalSystem:{meterPosition:getVal('meter-position'),meterPositionPhotos:photoUrls['meter-position-files']||[],meterWorkNeeded:getVal('meter-work-needed'),meterWorkDetails:getVal('meter-work-details'),meterWorkPhotos:photoUrls['meter-installation-files']||[],fuseRating:getVal('fuse-rating'),earthingSystem:getVal('earthing-system'),earthingSystemPhotos:photoUrls['earthing-system-files']||[],gasBonded:getRadio('gas-bonded'),gasBondingEquipment:getVal('gas-bonding-equipment'),gasBondedPhotos:photoUrls['gas-bonded-files']||[],waterBonded:getRadio('water-bonded'),waterBondingEquipment:getVal('water-bonding-equipment'),waterBondedPhotos:photoUrls['water-bonded-files']||[],cableRun:getVal('cable-run'),cableRunPhotos:photoUrls['cable-files']||[],batteryLocation:getVal('battery-location'),batteryLocationPhotos:photoUrls['battery-location-files']||[],surfaceType:getVal('surface-type'),surfacePhotos:photoUrls['surface-files']||[],batteryWidth:parseInt(getVal('battery-width'))||0,batteryDepth:parseInt(getVal('battery-depth'))||0,batteryLength:parseInt(getVal('battery-length'))||0,additionalNotesBattery:getVal('additional-notes-battery'),renderCladding:getVal('render-cladding'),wifiSignal:getVal('wifi-signal')},
                        propertyInternal:{loftAccessible:getRadio('loft-accessible'),loftAccessiblePhotos:photoUrls['loft-accessible-files']||[],loftLadder:getRadio('loft-ladder'),loftBoarded:getRadio('loft-boarded'),asbestos:getRadio('asbestos'),asbestosPhotos:photoUrls['asbestos-files']||[],loftSpacePhotos:photoUrls['loft-space-files']||[],rafterWidth:parseInt(getVal('rafter-width'))||0,rafterDepth:parseInt(getVal('rafter-depth'))||0,webWidth:parseInt(getVal('web-width'))||0,webDepth:parseInt(getVal('web-depth'))||0,webLength:parseInt(getVal('web-length'))||0,trussSpacing:parseInt(getVal('truss-spacing'))||0,deflection:getRadio('roof-deflection'),deflectionPhotos:photoUrls['deflection-files']||[],rotDamage:getRadio('rot-damage'),rotDamagePhotos:photoUrls['rot-damage-files']||[],roofConcern:getRadio('roof-concern'),roofConcernPhotos:photoUrls['roof-concern-files']||[],dwarfWalls:getRadio('dwarf-walls'),dwarfWallsPhotos:photoUrls['dwarf-walls-files']||[],structuralWork:getRadio('structural-work'),structuralWorkPhotos:photoUrls['structural-work-files']||[]},
                        propertyExternal:{proposedDesignFit:getRadio('proposed-design'),proposedDesignReasonWhyNot:getVal('proposed-design-reason-text'),propertyPhotos:photoUrls['property-photos-files']||[],roofCovering:getVal('roof-covering'),roofCoveringPhotos:photoUrls['roof-covering-files']||[],numberStories:parseInt(getVal('number-stories'))||0,roofCondition:getVal('roof-condition'),roofConditionPhotos:photoUrls['roof-condition-files']||[],roofWorkAge:parseInt(getVal('roof-work-age'))||0,roofObstructions:getRadio('roof-obstructions'),obstructionsDescription:getVal('obstructions-description'),obstructionsPhotos:photoUrls['obstructions-files']||[],roofShading:getRadio('roof-shading'),shadingPhotos:photoUrls['shading-files']||[],additionalNotesProperty:getVal('additional-notes-property')},
                        scaffolding:{accessType:getVal('access-type'),parkingAvailable:getRadio('parking-available'),overheadPowerlines:getRadio('overhead-powerlines'),powerlinesPhotos:photoUrls['powerlines-files']||[],propertyOnPavement:getRadio('property-location'),pavementPhotos:photoUrls['pavement-files']||[],groundType:getVal('ground-type'),groundTypePhotos:photoUrls['ground-type-files']||[],accessIssues:getVal('access-issues'),gutterObstacles:getRadio('gutter-obstacles'),gutterObstaclesDescription:getVal('gutter-obstacles-description'),gutterObstaclesPhotos:photoUrls['gutter-obstacles-files']||[],lowerRoofs:getVal('lower-roofs'),lowerRoofsPhotos:photoUrls['lower-roofs-files']||[],additionalNotes:getVal('scaffolding-additional-notes')},
                        customerSignOff:{date:getVal('signoff-date'),name:getVal('signoff-name')}
                    };
                }
                const{doc,setDoc}=window.firebaseModules;
                const surveyRef=doc(window.db,'site-surveys',verifiedJob['Job Number']+'_'+selectedSurveyType+'_'+Date.now());
                await setDoc(surveyRef,surveyData);
                clearProgress();
                showAlert('Survey submitted successfully!','success');
                setTimeout(()=>window.location.href='teamview.html',2000);
            }catch(error){
                console.error('Survey submission error:',error);
                showAlert('Error submitting survey: '+(error.message||'Please try again'),'error');
                const submitBtn=document.getElementById('submit-btn');
                submitBtn.disabled=false; submitBtn.textContent='Submit Survey';
            }
        }

        document.addEventListener('DOMContentLoaded',()=>{
            setupConditionalFields();
            setupFileUploads();
            const form=document.getElementById('survey-form');
            form.addEventListener('submit',submitSurvey);
            form.addEventListener('change',saveProgress);
            form.addEventListener('input',saveProgress);
            document.getElementById('verify-btn').onclick=verifyJobNumber;
        });
    </script>
</body>
</html>
