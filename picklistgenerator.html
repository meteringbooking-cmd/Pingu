<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picklist Generator | Pingu - Solar</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #FFC857;
            --accent: #00D9FF;
            --dark: #1A1A2E;
            --dark-light: #252541;
            --dark-lighter: #2F2F4A;
            --text: #EAEAEA;
            --text-dim: #9A9AB0;
            --success: #4ECCA3;
            --error: #FF6B6B;
            --shadow: rgba(255, 107, 53, 0.3);
            --warning: #FFC857;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--dark); color: var(--text);
            line-height: 1.6; min-height: 100vh; overflow-x: hidden;
        }
        body::before {
            content: ''; position: fixed; top:-50%; left:-50%;
            width:200%; height:200%;
            background:
                radial-gradient(circle at 20% 50%, rgba(255,107,53,0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0,217,255,0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255,200,87,0.06) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite; pointer-events:none; z-index:-1;
        }
        @keyframes float {
            0%,100%{transform:translate(0,0) rotate(0deg)}
            33%{transform:translate(30px,-30px) rotate(120deg)}
            66%{transform:translate(-20px,20px) rotate(240deg)}
        }
        @keyframes slideDown { from{opacity:0;transform:translateY(-30px)} to{opacity:1;transform:translateY(0)} }
        @keyframes fadeInUp  { from{opacity:0;transform:translateY(30px)}  to{opacity:1;transform:translateY(0)} }
        @keyframes slideInRight { from{opacity:0;transform:translateX(100px)} to{opacity:1;transform:translateX(0)} }
        @keyframes slideUp { from{opacity:0;transform:translateY(50px)} to{opacity:1;transform:translateY(0)} }
        @keyframes spin { to{transform:rotate(360deg)} }

        .container { max-width:1200px; margin:0 auto; padding:2rem; }
        header { margin-bottom:2rem; animation:slideDown 0.8s ease-out; }

        .header-content { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; }
        .logo {
            font-family:'Syne',sans-serif; font-size:2rem; font-weight:800;
            background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 50%,var(--accent) 100%);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; text-decoration:none;
        }
        .back-btn {
            background:var(--dark-light); color:var(--text); text-decoration:none;
            padding:0.7rem 1.5rem; border-radius:8px; font-size:0.9rem;
            transition:all 0.3s ease; border:2px solid transparent; font-family:'JetBrains Mono',monospace;
        }
        .back-btn:hover { background:var(--dark-lighter); border-color:var(--primary); transform:translateX(-5px); }
        h1 { font-family:'Syne',sans-serif; font-size:2.5rem; margin-bottom:0.5rem; }
        .subtitle { color:var(--text-dim); font-size:0.95rem; }

        .card {
            background:var(--dark-light); border-radius:16px; padding:2.5rem;
            border:2px solid transparent; margin-bottom:2rem;
            transition:border-color 0.3s ease; animation:fadeInUp 0.6s ease-out;
        }
        .card:hover { border-color:rgba(255,107,53,0.2); }
        .card.active { border-color:rgba(0,217,255,0.4); }
        .card h2 { font-family:'Syne',sans-serif; font-size:1.5rem; margin-bottom:1.5rem; }
        .card h2.accent   { color:var(--accent); }
        .card h2.secondary{ color:var(--secondary); }
        .card h2.primary  { color:var(--primary); }

        .search-row { display:flex; gap:1rem; align-items:flex-end; }
        .input-group { flex:1; display:flex; flex-direction:column; gap:0.5rem; }
        .input-group label { font-size:0.85rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.05em; }
        .job-input {
            background:var(--dark-lighter); border:2px solid var(--dark-lighter);
            color:var(--text); padding:0.9rem 1.2rem; border-radius:10px;
            font-family:'JetBrains Mono',monospace; font-size:1.1rem;
            transition:all 0.3s ease; width:100%;
        }
        .job-input:focus { outline:none; border-color:var(--primary); background:rgba(255,107,53,0.05); }
        .job-input.match    { border-color:var(--success); background:rgba(78,204,163,0.07); }
        .job-input.no-match { border-color:var(--error);   background:rgba(255,107,107,0.07); }

        .btn {
            padding:0.9rem 2rem; border:none; border-radius:10px;
            font-family:'Syne',sans-serif; font-size:0.95rem; font-weight:700;
            cursor:pointer; transition:all 0.3s ease; white-space:nowrap;
        }
        .btn-primary  { background:linear-gradient(135deg,var(--primary),var(--accent)); color:white; }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 10px 30px var(--shadow); }
        .btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }
        .btn-secondary{ background:var(--dark-lighter); color:var(--text); border:2px solid var(--text-dim); }
        .btn-secondary:hover { border-color:var(--primary); }
        .btn-success  { background:var(--success); color:var(--dark); font-weight:700; }
        .btn-success:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(78,204,163,0.3); }
        .btn-success:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }

        .job-result { display:none; margin-top:1.5rem; padding:1.5rem; border-radius:12px; border:2px solid transparent; }
        .job-result.found    { display:block; background:rgba(78,204,163,0.08);   border-color:var(--success); }
        .job-result.not-found{ display:block; background:rgba(255,107,107,0.08); border-color:var(--error); }
        .result-header { display:flex; align-items:center; gap:1rem; margin-bottom:1rem; }
        .result-icon  { font-size:1.8rem; }
        .result-title { font-family:'Syne',sans-serif; font-size:1.2rem; font-weight:700; }
        .job-result.found     .result-title { color:var(--success); }
        .job-result.not-found .result-title { color:var(--error); }
        .job-details-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-top:1rem; }
        .detail-item { background:var(--dark-lighter); padding:0.8rem 1rem; border-radius:8px; }
        .detail-label { font-size:0.75rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.05em; }
        .detail-value { font-size:0.95rem; color:var(--text); margin-top:0.2rem; }

        .paste-hint {
            text-align:center; color:var(--text-dim); font-size:0.85rem;
            margin-bottom:0.8rem; display:flex; align-items:center; justify-content:center; gap:0.5rem;
        }
        .paste-hint .key {
            background:var(--dark-lighter); padding:0.2rem 0.6rem;
            border-radius:4px; border:1px solid var(--text-dim); font-size:0.8rem;
        }
        .paste-area {
            width:100%; min-height:120px; background:var(--dark-lighter);
            border:2px dashed var(--dark-lighter); border-radius:12px; padding:1.2rem;
            color:var(--text); font-family:'JetBrains Mono',monospace; font-size:0.85rem;
            resize:vertical; transition:all 0.3s ease; line-height:1.5;
        }
        .paste-area:focus { outline:none; border-color:var(--accent); background:rgba(0,217,255,0.03); }
        .paste-area.has-data { border-color:var(--secondary); border-style:solid; }

        .action-row { display:flex; gap:1rem; margin-top:1.5rem; flex-wrap:wrap; align-items:center; }
        .lock-notice {
            display:inline-flex; align-items:center; gap:0.5rem;
            padding:0.5rem 1rem; background:rgba(255,200,87,0.1);
            border:1px solid rgba(255,200,87,0.4); border-radius:8px;
            font-size:0.8rem; color:var(--secondary);
        }

        /* â”€â”€ SPECS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .specs-panel { display:none; margin-top:2rem; animation:fadeInUp 0.5s ease-out; }
        .specs-panel.show { display:block; }

        .specs-section-title {
            font-family:'Syne',sans-serif; font-size:0.9rem; font-weight:700;
            color:var(--secondary); text-transform:uppercase; letter-spacing:0.08em;
            margin:1.6rem 0 0.8rem; padding-bottom:0.4rem;
            border-bottom:1px solid rgba(255,200,87,0.2);
            display:flex; align-items:center; gap:0.5rem;
        }
        .specs-section-title:first-child { margin-top:0; }

        .specs-grid {
            display:grid;
            grid-template-columns:repeat(auto-fill, minmax(250px,1fr));
            gap:0.75rem;
        }
        .spec-item {
            background:var(--dark-lighter); border-radius:10px; padding:0.85rem 1rem 0.85rem 1.1rem;
            border-left:3px solid transparent; transition:border-color 0.2s, transform 0.2s;
            position:relative;
        }
        .spec-item:hover          { border-left-color:var(--primary); transform:translateX(3px); }
        .spec-item.has-value      { border-left-color:rgba(0,217,255,0.5); }
        .spec-item.no-value       { opacity:0.42; }
        .spec-ref {
            position:absolute; top:0.45rem; right:0.65rem;
            font-size:0.62rem; color:var(--dark-lighter); background:var(--dark);
            padding:0.1rem 0.35rem; border-radius:3px; font-family:'JetBrains Mono',monospace;
        }
        .spec-label  { font-size:0.7rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:0.25rem; }
        .spec-note   { font-size:0.65rem; color:var(--text-dim); font-style:italic; }
        .spec-value  { font-size:0.98rem; color:var(--text); font-weight:500; }
        .spec-value.empty-val { font-style:italic; color:var(--text-dim); font-size:0.82rem; font-weight:400; }
        .spec-unit   { font-size:0.7rem; color:var(--text-dim); margin-left:0.25rem; }

        /* â”€â”€ MOUNT CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .mount-check-wrap { overflow-x:auto; margin-top:0.8rem; }
        .mount-grid {
            display:inline-grid; gap:3px; padding:1rem;
            background:rgba(255,255,255,0.02); border-radius:12px;
            border:1px solid rgba(255,255,255,0.05); min-width:100%;
        }
        .mc {
            min-width:38px; height:32px; border-radius:4px;
            display:flex; align-items:center; justify-content:center;
            font-size:0.68rem; font-family:'JetBrains Mono',monospace;
            padding:0 4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
            transition:transform 0.15s; cursor:default;
        }
        .mc:hover { transform:scale(1.18); z-index:5; position:relative; }
        .mc.empty  { background:rgba(255,255,255,0.03); border:1px dashed rgba(255,255,255,0.07); }
        .mc.filled {
            background:linear-gradient(135deg,rgba(255,200,87,0.15),rgba(255,200,87,0.07));
            border:1px solid rgba(255,200,87,0.35); color:var(--secondary); font-weight:500;
        }

        /* â”€â”€ ROOF MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .roof-map-wrap {
            margin-top:2rem; padding:1.5rem; background:var(--dark);
            border-radius:16px; border:2px solid rgba(0,217,255,0.25);
        }
        .roof-map-hdr {
            display:flex; align-items:center; justify-content:space-between;
            margin-bottom:1.2rem; flex-wrap:wrap; gap:0.8rem;
        }
        .roof-map-hdr h4 { font-family:'Syne',sans-serif; font-size:1.1rem; color:var(--accent); display:flex; align-items:center; gap:0.5rem; }
        .legend { display:flex; gap:1.2rem; flex-wrap:wrap; }
        .legend-item { display:flex; align-items:center; gap:0.5rem; font-size:0.78rem; color:var(--text-dim); }
        .swatch { width:28px; height:18px; border-radius:3px; }
        .swatch.p { background:linear-gradient(135deg,#FF6B35,#FF9559); border:1px solid rgba(255,107,53,0.6); }
        .swatch.l { background:linear-gradient(135deg,#00D9FF,#00A8CC); border:1px solid rgba(0,217,255,0.6); width:36px; height:16px; }
        .swatch.e { background:var(--dark-lighter); border:1px dashed rgba(255,255,255,0.1); }

        .roof-grid-wrap { overflow-x:auto; padding-bottom:0.5rem; }
        .roof-grid {
            display:inline-grid; gap:3px; padding:1rem;
            background:rgba(255,255,255,0.02); border-radius:12px;
            border:1px solid rgba(255,255,255,0.05); min-width:100%;
        }
        .cell {
            width:28px; height:28px; border-radius:3px;
            display:flex; align-items:center; justify-content:center;
            font-size:0.6rem; font-weight:700; position:relative;
            transition:transform 0.15s, box-shadow 0.15s; cursor:default;
        }
        .cell:hover { transform:scale(1.3); z-index:10; }
        .cell.e { background:rgba(255,255,255,0.03); border:1px dashed rgba(255,255,255,0.07); }
        .cell.p { background:linear-gradient(135deg,#FF6B35,#FF9559); border:1px solid rgba(255,149,89,0.8); color:rgba(255,255,255,0.9); box-shadow:0 2px 6px rgba(255,107,53,0.4); }
        .cell.l { background:linear-gradient(135deg,#00D9FF,#00A8CC); border:1px solid rgba(0,217,255,0.8); color:rgba(0,30,50,0.9); box-shadow:0 2px 6px rgba(0,217,255,0.35); }
        .cell.p::after,.cell.l::after { content:''; position:absolute; inset:3px; border:1px solid rgba(255,255,255,0.3); border-radius:1px; }

        .roof-stats { display:flex; gap:1.5rem; margin-top:1rem; flex-wrap:wrap; }
        .roof-stat  { display:flex; align-items:center; gap:0.4rem; font-size:0.82rem; color:var(--text-dim); }
        .roof-stat strong { color:var(--text); }

        /* â”€â”€ SAVED LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .picklist-item {
            background:var(--dark-lighter); border-radius:12px; padding:1.2rem 1.5rem;
            margin-bottom:1rem; border:2px solid transparent;
            transition:all 0.3s ease; cursor:pointer;
            display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem;
        }
        .picklist-item:hover { border-color:var(--primary); transform:translateX(4px); }
        .picklist-left { display:flex; flex-direction:column; gap:0.3rem; }
        .picklist-job {
            font-family:'Syne',sans-serif; font-size:1.1rem; font-weight:700;
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
        }
        .picklist-meta { font-size:0.8rem; color:var(--text-dim); }
        .picklist-badge {
            background:var(--dark); color:var(--accent);
            padding:0.3rem 0.8rem; border-radius:20px; font-size:0.75rem;
            font-weight:600; border:1px solid rgba(0,217,255,0.3);
        }

        /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal {
            display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.85); backdrop-filter:blur(12px);
            z-index:1000; align-items:center; justify-content:center;
        }
        .modal.show { display:flex; }
        .modal-content {
            background:var(--dark-light); border-radius:16px; padding:2.5rem;
            max-width:1100px; width:95%; max-height:90vh; overflow-y:auto;
            border:2px solid var(--accent); animation:slideUp 0.4s ease;
        }
        .modal-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; }
        .modal-hdr h2 { font-family:'Syne',sans-serif; font-size:1.6rem; }
        .close-btn { background:none; border:none; color:var(--text-dim); font-size:2rem; cursor:pointer; line-height:1; transition:color 0.3s; }
        .close-btn:hover { color:var(--error); }

        /* â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .status-msg {
            position:fixed; top:2rem; right:2rem; padding:1rem 1.5rem;
            border-radius:8px; font-size:0.9rem; z-index:1001;
            display:none; max-width:400px; animation:slideInRight 0.4s ease;
        }
        .status-msg.show    { display:block; }
        .status-msg.success { background:var(--success); color:var(--dark); }
        .status-msg.error   { background:var(--error);   color:white; }
        .status-msg.warning { background:var(--warning); color:var(--dark); }

        .spinner {
            display:inline-block; width:14px; height:14px;
            border:2px solid rgba(255,255,255,0.3); border-radius:50%;
            border-top-color:white; animation:spin 0.6s linear infinite;
            margin-left:0.5rem; vertical-align:middle;
        }
        .empty-state { text-align:center; padding:3rem; color:var(--text-dim); }
        .empty-state .ei { font-size:3rem; margin-bottom:1rem; }
        .empty-state p { font-size:0.9rem; }

        @media(max-width:768px){
            .container{padding:1rem}
            .search-row{flex-direction:column}
            h1{font-size:1.8rem}
            .specs-grid{grid-template-columns:1fr 1fr}
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">Pingu - Solar</a>
            <a href="index.html" class="back-btn">â† Back to Home</a>
        </div>
        <h1>Picklist Generator</h1>
        <p class="subtitle">Search for a job, paste your Excel picklist, and save it to the job record.</p>
    </header>

    <!-- Job Search -->
    <div class="card">
        <h2 class="accent">ğŸ” Find Job</h2>
        <div class="search-row">
            <div class="input-group">
                <label>Job Number</label>
                <input type="text" class="job-input" id="job-number-input"
                    placeholder="e.g. JOB-001" autocomplete="off" oninput="onJobInputChange()" />
            </div>
            <button class="btn btn-primary" id="search-btn" onclick="searchJob()">Search</button>
        </div>
        <div class="job-result" id="job-result">
            <div class="result-header">
                <div class="result-icon" id="result-icon"></div>
                <div class="result-title" id="result-title"></div>
            </div>
            <div class="job-details-grid" id="job-details-grid"></div>
        </div>
    </div>

    <!-- Paste -->
    <div class="card" id="paste-card">
        <h2 class="secondary">ğŸ“‹ Paste Picklist Data</h2>
        <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:1.2rem;">
            Copy your full Excel sheet (<span style="color:var(--text)">Ctrl+A â†’ Ctrl+C</span>), then paste below. The roof layout and all specs are extracted automatically.
        </p>

        <div class="paste-hint">
            In Excel: <span class="key">Ctrl+A</span> â†’ <span class="key">Ctrl+C</span> â†’ paste here
        </div>

        <textarea class="paste-area" id="paste-area"
            placeholder="Paste your Excel data here..."
            oninput="onPasteData()" onpaste="setTimeout(onPasteData,50)"></textarea>

        <!-- Specs + maps injected here -->
        <div class="specs-panel" id="specs-panel">
            <div class="specs-section-title">âš¡ System Configuration</div>
            <div class="specs-grid" id="sg-system"></div>

            <div class="specs-section-title">ğŸ”© Mounting &amp; Hardware</div>
            <div class="specs-grid" id="sg-mounting"></div>

            <div class="specs-section-title">ğŸ”Œ Electrical &amp; Supply</div>
            <div class="specs-grid" id="sg-electrical"></div>

            <div class="specs-section-title">âœ… Mount System Sense Check
                <span style="color:var(--text-dim);font-size:0.72rem;font-family:'JetBrains Mono'">&nbsp;B22:U28</span>
            </div>
            <div class="mount-check-wrap"><div class="mount-grid" id="mount-grid"></div></div>

            <!-- Roof map appended dynamically -->
        </div>

        <div class="action-row">
            <button class="btn btn-success" id="save-btn" onclick="savePicklist()" disabled>ğŸ’¾ Save Picklist to Job</button>
            <button class="btn btn-secondary" onclick="clearPaste()">Clear</button>
            <div class="lock-notice" id="lock-notice" style="display:none;">âš ï¸ Select a matching job first to save</div>
        </div>
    </div>

    <!-- Saved Picklists -->
    <div class="card" style="animation-delay:0.2s">
        <h2 class="primary">ğŸ“ Saved Picklists</h2>
        <div id="saved-list">
            <div class="empty-state"><div class="ei">ğŸ”„</div><p>Loading saved picklists...</p></div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal" id="view-modal">
    <div class="modal-content">
        <div class="modal-hdr">
            <h2 id="modal-title">Picklist</h2>
            <button class="close-btn" onclick="closeModal()">Ã—</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<div class="status-msg" id="status-msg"></div>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, query, where, getDocs, addDoc, orderBy }
        from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const cfg = {
        apiKey:"AIzaSyAc_yJQ_rkzuOBh-Yxg0Q4eooXtB-tQjm0",
        authDomain:"pingu-solar.firebaseapp.com",
        projectId:"pingu-solar",
        storageBucket:"pingu-solar.firebasestorage.app",
        messagingSenderId:"232764952866",
        appId:"1:232764952866:web:5923b7f419de6355d6157b",
        measurementId:"G-PFH059DZ64"
    };
    try {
        const app = initializeApp(cfg);
        window.db = getFirestore(app);
        window.fb = { collection, query, where, getDocs, addDoc, orderBy };
        loadSavedPicklists();
    } catch(e) { showStatus('Firebase error: '+e.message,'error'); }
</script>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentJob = null;
let parsedData  = { allLines:[] };

// â”€â”€ Cell helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function colIdx(s) {
    s = s.toUpperCase(); let n=0;
    for(let i=0;i<s.length;i++) n=n*26+(s.charCodeAt(i)-64);
    return n-1; // 0-based
}
function cv(allLines, col, row) { // row = 1-based Excel row
    const r = allLines[row-1]||[];
    return (r[colIdx(col)]||'').trim();
}

// â”€â”€ Spec definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SPECS = {
    system: [
        {label:'Type of System',     col:'AO', row:2},
        {label:'Inverter Size',      col:'AO', row:4,  note:'Fox & Tesla'},
        {label:'No. of Batteries',   col:'AO', row:6},
        {label:'Battery',            col:'AO', row:7},
        {label:'Retrofit',           col:'AO', row:8,  note:'Fox only'},
        {label:'Enphase Pedestal',   col:'AO', row:17},
        {label:'Enphase Branches',   col:'AO', row:12},
        {label:'DC Expansion',       col:'AO', row:21, note:'Tesla'},
    ],
    mounting: [
        {label:'Mounting System',    col:'AS', row:2},
        {label:'Hook Type',          col:'AS', row:4},
        {label:'Ave Hook Spacing',   col:'AS', row:6,  unit:'mm'},
        {label:'Hook Spacing',       col:'AS', row:7,  unit:'mm'},
        {label:'Min. Roof Anchors',  col:'AS', row:12},
        {label:'Bird Mesh',          col:'AS', row:14},
        {label:'Roof Type',          col:'AS', row:16},
        {label:'Rafter Spacing',     col:'AS', row:17},
    ],
    electrical: [
        {label:'Supply Cables',      col:'AO', row:10},
        {label:'Submain Location',   col:'AO', row:15},
        {label:'Trenching',          col:'AO', row:19},
    ]
};

// Panel map B3:AI18  â†’ allLines rows 2..17, cols 1..34
const PM = {cs:1,ce:34,rs:2,re:17};
// Mount check B22:U28 â†’ allLines rows 21..27, cols 1..20
const MC = {cs:1,ce:20,rs:21,re:27};

// â”€â”€ Job search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onJobInputChange(){
    document.getElementById('job-number-input').classList.remove('match','no-match');
    document.getElementById('job-result').className='job-result';
    currentJob=null; updateSaveBtn();
}

async function searchJob(){
    const jn=document.getElementById('job-number-input').value.trim();
    if(!jn){showStatus('Enter a job number','warning');return;}
    const btn=document.getElementById('search-btn');
    btn.disabled=true; btn.innerHTML='Searchingâ€¦ <span class="spinner"></span>';
    try{
        const {collection,query,where,getDocs}=window.fb;
        const snap=await getDocs(query(collection(window.db,'jobs'),where('Job Number','==',jn)));
        const inp=document.getElementById('job-number-input');
        const res=document.getElementById('job-result');
        if(!snap.empty){
            const d=snap.docs[0].data();
            currentJob={id:snap.docs[0].id,...d};
            inp.classList.add('match'); res.className='job-result found';
            document.getElementById('result-icon').textContent='âœ…';
            document.getElementById('result-title').textContent=`Job Found: #${jn}`;
            const flds=['Name','Phone Number','Email Address','1st line of address','Postcode','Install Date','Lead Engineer','Job Length'];
            document.getElementById('job-details-grid').innerHTML=flds.map(f=>`
                <div class="detail-item">
                    <div class="detail-label">${f}</div>
                    <div class="detail-value">${esc(d[f]||'â€”')}</div>
                </div>`).join('');
            showStatus(`âœ… Job #${jn} found!`,'success');
        } else {
            currentJob=null; inp.classList.add('no-match'); res.className='job-result not-found';
            document.getElementById('result-icon').textContent='âŒ';
            document.getElementById('result-title').textContent=`No job found: "${jn}"`;
            document.getElementById('job-details-grid').innerHTML=`<p style="color:var(--text-dim);font-size:0.9rem;margin-top:0.5rem">Double-check the job number â€” make sure the Job CSV has been uploaded first.</p>`;
            showStatus(`No match for "${jn}"`,'error');
        }
    } catch(e){ showStatus('Search failed: '+e.message,'error'); }
    finally{ btn.disabled=false; btn.textContent='Search'; updateSaveBtn(); }
}
document.getElementById('job-number-input').addEventListener('keydown',e=>{if(e.key==='Enter')searchJob();});

// â”€â”€ Paste â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onPasteData(){
    const raw=document.getElementById('paste-area').value;
    if(!raw.trim()){clearPasteOutput();return;}
    document.getElementById('paste-area').classList.add('has-data');
    parsedData=parseSheet(raw);
    renderSpecs(parsedData.allLines);
    renderMountCheck(parsedData.allLines);
    renderRoofMap(parsedData.allLines);
    updateSaveBtn();
}

function parseSheet(raw){
    const lines=raw.split(/\r?\n/);
    while(lines.length&&!lines[lines.length-1].trim())lines.pop();
    if(!lines.length)return{allLines:[]};
    const delim=lines[0].includes('\t')?'\t':',';
    const split=line=>{
        if(delim==='\t')return line.split('\t').map(c=>c.trim());
        const r=[];let cur='',q=false;
        for(let i=0;i<line.length;i++){
            if(line[i]==='"')q=!q;
            else if(line[i]===','&&!q){r.push(cur.trim());cur='';}
            else cur+=line[i];
        }
        r.push(cur.trim());return r;
    };
    return{allLines:lines.map(split)};
}

// â”€â”€ Render specs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function specCard(d,allLines){
    const val=cv(allLines,d.col,d.row);
    const ref=`${d.col}${d.row}`;
    const hasVal=!!val;
    const noteH=d.note?`<span class="spec-note"> (${d.note})</span>`:'';
    const unitH=(val&&d.unit)?`<span class="spec-unit">${d.unit}</span>`:'';
    return `<div class="spec-item ${hasVal?'has-value':'no-value'}">
        <div class="spec-ref">${ref}</div>
        <div class="spec-label">${d.label}${noteH}</div>
        <div class="spec-value ${hasVal?'':'empty-val'}">${hasVal?esc(val)+''+unitH:'â€”'}</div>
    </div>`;
}

function renderSpecs(al){
    document.getElementById('sg-system').innerHTML    =SPECS.system.map(d=>specCard(d,al)).join('');
    document.getElementById('sg-mounting').innerHTML  =SPECS.mounting.map(d=>specCard(d,al)).join('');
    document.getElementById('sg-electrical').innerHTML=SPECS.electrical.map(d=>specCard(d,al)).join('');
    document.getElementById('specs-panel').classList.add('show');
}

// â”€â”€ Mount check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMountCheck(al){
    const g=document.getElementById('mount-grid');
    const cols=MC.ce-MC.cs+1;
    g.style.gridTemplateColumns=`repeat(${cols},minmax(38px,1fr))`;
    let html='',hasData=false;
    for(let r=MC.rs;r<=MC.re;r++){
        const line=al[r]||[];
        for(let c=MC.cs;c<=MC.ce;c++){
            const v=(line[c]||'').trim();
            if(v)hasData=true;
            const disp=v.length>9?v.slice(0,8)+'â€¦':v;
            html+=v?`<div class="mc filled" title="${esc(v)}">${esc(disp)}</div>`
                   :`<div class="mc empty"></div>`;
        }
    }
    g.innerHTML=hasData?html:`<div style="color:var(--text-dim);font-size:0.82rem;padding:0.5rem">No data in B22:U28</div>`;
}

// â”€â”€ Roof map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRoofMap(al){
    const old=document.getElementById('roof-map-el');
    if(old)old.remove();
    if(al.length<=PM.re)return;
    const cols=PM.ce-PM.cs+1;
    let pC=0,lC=0,cells='';
    for(let r=PM.rs;r<=PM.re;r++){
        const line=al[r]||[];
        for(let c=PM.cs;c<=PM.ce;c++){
            const v=(line[c]||'').trim().toUpperCase();
            if(v==='P')pC++; if(v==='L')lC++;
            const cls=v==='P'?'p':v==='L'?'l':'e';
            const lbl=v==='P'?'P':v==='L'?'L':'';
            cells+=`<div class="cell ${cls}" title="${v==='P'?'Portrait':v==='L'?'Landscape':'Empty'}">${lbl}</div>`;
        }
    }
    if(!pC&&!lC)return;
    const div=document.createElement('div');
    div.id='roof-map-el';
    div.innerHTML=`
    <div class="roof-map-wrap">
        <div class="roof-map-hdr">
            <h4>ğŸ  Roof Panel Layout
                <span style="color:var(--text-dim);font-size:0.75rem;font-family:'JetBrains Mono'">(B3:AI18)</span>
            </h4>
            <div class="legend">
                <div class="legend-item"><div class="swatch p"></div>Portrait (P)</div>
                <div class="legend-item"><div class="swatch l"></div>Landscape (L)</div>
                <div class="legend-item"><div class="swatch e"></div>Empty</div>
            </div>
        </div>
        <div class="roof-grid-wrap">
            <div class="roof-grid" style="grid-template-columns:repeat(${cols},28px)">${cells}</div>
        </div>
        <div class="roof-stats">
            <div class="roof-stat">ğŸŸ§ Portrait: <strong>${pC}</strong></div>
            <div class="roof-stat">ğŸŸ¦ Landscape: <strong>${lC}</strong></div>
            <div class="roof-stat">ğŸ“ Total panels: <strong>${pC+lC}</strong></div>
            <div class="roof-stat">ğŸ“ Grid: <strong>${cols}Ã—${PM.re-PM.rs+1}</strong></div>
        </div>
    </div>`;
    document.getElementById('specs-panel').appendChild(div);
}

function clearPasteOutput(){
    document.getElementById('specs-panel').classList.remove('show');
    const rm=document.getElementById('roof-map-el');
    if(rm)rm.remove();
    parsedData={allLines:[]}; updateSaveBtn();
}
function clearPaste(){
    document.getElementById('paste-area').value='';
    document.getElementById('paste-area').classList.remove('has-data');
    clearPasteOutput();
}

// â”€â”€ Save btn â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSaveBtn(){
    const ok=!!currentJob&&parsedData.allLines.length>0;
    document.getElementById('save-btn').disabled=!ok;
    document.getElementById('lock-notice').style.display=(!currentJob&&parsedData.allLines.length)?'inline-flex':'none';
    document.getElementById('paste-card').classList.toggle('active',!!currentJob);
}

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function savePicklist(){
    if(!currentJob||!parsedData.allLines.length)return;
    const btn=document.getElementById('save-btn');
    btn.disabled=true; btn.innerHTML='Savingâ€¦ <span class="spinner"></span>';
    try{
        const al=parsedData.allLines;
        const specs={};
        [...SPECS.system,...SPECS.mounting,...SPECS.electrical].forEach(d=>specs[d.label]=cv(al,d.col,d.row));

        const panelGrid=[];
        for(let r=PM.rs;r<=PM.re;r++){
            const line=al[r]||[], row=[];
            for(let c=PM.cs;c<=PM.ce;c++) row.push((line[c]||'').trim().toUpperCase());
            panelGrid.push(row);
        }
        const mountGrid=[];
        for(let r=MC.rs;r<=MC.re;r++){
            const line=al[r]||[], row=[];
            for(let c=MC.cs;c<=MC.ce;c++) row.push((line[c]||'').trim());
            mountGrid.push(row);
        }

        await window.fb.addDoc(window.fb.collection(window.db,'picklists'),{
            jobNumber:    currentJob['Job Number'],
            jobId:        currentJob.id,
            customerName: currentJob['Name']||'',
            installDate:  currentJob['Install Date']||'',
            specs, panelGrid, mountGrid,
            rawLines:     al,
            savedAt:      new Date().toISOString()
        });
        showStatus(`âœ… Picklist saved for Job #${currentJob['Job Number']}!`,'success');
        clearPaste(); loadSavedPicklists();
    } catch(e){ showStatus('Save failed: '+e.message,'error'); }
    finally{ btn.disabled=false; btn.innerHTML='ğŸ’¾ Save Picklist to Job'; updateSaveBtn(); }
}

// â”€â”€ Load list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSavedPicklists(){
    if(!window.db)return;
    const el=document.getElementById('saved-list');
    try{
        const {collection,query,orderBy,getDocs}=window.fb;
        const snap=await getDocs(query(collection(window.db,'picklists'),orderBy('savedAt','desc')));
        if(snap.empty){el.innerHTML=`<div class="empty-state"><div class="ei">ğŸ“­</div><p>No picklists saved yet.</p></div>`;return;}
        window._docs={};
        snap.docs.forEach(d=>window._docs[d.id]=d.data());
        el.innerHTML=snap.docs.map(doc=>{
            const d=doc.data();
            const dt=d.savedAt?new Date(d.savedAt).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}):'â€”';
            const sys=d.specs?.['Type of System']||'';
            const mnt=d.specs?.['Mounting System']||'';
            return `<div class="picklist-item" onclick="viewPicklist('${doc.id}')">
                <div class="picklist-left">
                    <div class="picklist-job">Job #${esc(d.jobNumber||'â€”')}</div>
                    <div class="picklist-meta">${esc(d.customerName||'')} Â· ${esc(d.installDate||'')} Â· Saved ${dt}</div>
                    ${sys||mnt?`<div class="picklist-meta" style="margin-top:0.15rem;color:var(--accent)">${esc(sys)}${mnt?' Â· '+esc(mnt):''}</div>`:''}
                </div>
                <div class="picklist-badge">View â†’</div>
            </div>`;
        }).join('');
    } catch(e){ el.innerHTML=`<div class="empty-state"><p style="color:var(--error)">Failed: ${e.message}</p></div>`; }
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewPicklist(id){
    const d=window._docs?.[id]; if(!d)return;
    document.getElementById('modal-title').textContent=`Picklist â€” Job #${d.jobNumber}`;
    const dt=d.savedAt?new Date(d.savedAt).toLocaleString('en-GB'):'';
    let html=`<p style="color:var(--text-dim);font-size:0.82rem;margin-bottom:1.5rem">${esc(d.customerName||'')} Â· Install: ${esc(d.installDate||'')} Â· Saved ${dt}</p>`;

    if(d.specs){
        const grp=defs=>defs.map(def=>{
            const v=d.specs[def.label]||'';
            const noteH=def.note?`<span class="spec-note"> (${def.note})</span>`:'';
            const unitH=(v&&def.unit)?`<span class="spec-unit">${def.unit}</span>`:'';
            return `<div class="spec-item ${v?'has-value':'no-value'}">
                <div class="spec-ref">${def.col}${def.row}</div>
                <div class="spec-label">${def.label}${noteH}</div>
                <div class="spec-value ${v?'':'empty-val'}">${v?esc(v)+''+unitH:'â€”'}</div>
            </div>`;
        }).join('');
        html+=`<div class="specs-section-title">âš¡ System Configuration</div><div class="specs-grid">${grp(SPECS.system)}</div>`;
        html+=`<div class="specs-section-title">ğŸ”© Mounting &amp; Hardware</div><div class="specs-grid">${grp(SPECS.mounting)}</div>`;
        html+=`<div class="specs-section-title">ğŸ”Œ Electrical &amp; Supply</div><div class="specs-grid">${grp(SPECS.electrical)}</div>`;
    }

    if(d.panelGrid){
        const cols=d.panelGrid[0]?.length||0;
        let pC=0,lC=0,cells='';
        d.panelGrid.forEach(row=>row.forEach(v=>{
            if(v==='P')pC++; if(v==='L')lC++;
            const cls=v==='P'?'p':v==='L'?'l':'e';
            cells+=`<div class="cell ${cls}">${v==='P'?'P':v==='L'?'L':''}</div>`;
        }));
        if(pC||lC) html+=`
        <div class="roof-map-wrap" style="margin-top:1.5rem">
            <div class="roof-map-hdr">
                <h4>ğŸ  Roof Panel Layout</h4>
                <div class="legend">
                    <div class="legend-item"><div class="swatch p"></div>Portrait</div>
                    <div class="legend-item"><div class="swatch l"></div>Landscape</div>
                </div>
            </div>
            <div class="roof-grid-wrap">
                <div class="roof-grid" style="grid-template-columns:repeat(${cols},28px)">${cells}</div>
            </div>
            <div class="roof-stats">
                <div class="roof-stat">ğŸŸ§ Portrait: <strong>${pC}</strong></div>
                <div class="roof-stat">ğŸŸ¦ Landscape: <strong>${lC}</strong></div>
                <div class="roof-stat">ğŸ“ Total: <strong>${pC+lC}</strong></div>
            </div>
        </div>`;
    }

    if(d.mountGrid){
        const cols=d.mountGrid[0]?.length||0;
        let has=false,mc='';
        d.mountGrid.forEach(row=>row.forEach(v=>{
            if(v)has=true;
            const disp=v.length>9?v.slice(0,8)+'â€¦':v;
            mc+=v?`<div class="mc filled" title="${esc(v)}">${esc(disp)}</div>`:`<div class="mc empty"></div>`;
        }));
        if(has) html+=`
        <div class="specs-section-title" style="margin-top:1.5rem">âœ… Mount System Sense Check</div>
        <div class="mount-check-wrap">
            <div class="mount-grid" style="grid-template-columns:repeat(${cols},minmax(38px,1fr))">${mc}</div>
        </div>`;
    }

    document.getElementById('modal-body').innerHTML=html;
    document.getElementById('view-modal').classList.add('show');
}

function closeModal(){ document.getElementById('view-modal').classList.remove('show'); }
document.getElementById('view-modal').addEventListener('click',e=>{
    if(e.target===document.getElementById('view-modal'))closeModal();
});

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(t){ const d=document.createElement('div'); d.textContent=String(t); return d.innerHTML; }

function showStatus(msg,type){
    const el=document.getElementById('status-msg');
    el.textContent=msg; el.className=`status-msg ${type} show`;
    clearTimeout(window._st); window._st=setTimeout(()=>el.classList.remove('show'),5000);
}

window.searchJob=searchJob; window.onJobInputChange=onJobInputChange;
window.onPasteData=onPasteData; window.clearPaste=clearPaste;
window.savePicklist=savePicklist; window.loadSavedPicklists=loadSavedPicklists;
window.viewPicklist=viewPicklist; window.closeModal=closeModal;
window.showStatus=showStatus;
</script>
</body>
</html>
