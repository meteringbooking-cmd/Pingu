<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Survey | Pingu - Solar</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B35; --primary-dark: #E55A2B; --secondary: #FFC857;
            --accent: #00D9FF; --dark: #1A1A2E; --dark-light: #252541;
            --dark-lighter: #2F2F4A; --text: #EAEAEA; --text-dim: #9A9AB0;
            --success: #4ECCA3; --error: #FF6B6B;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'JetBrains Mono',monospace; background:var(--dark); color:var(--text); line-height:1.6; overflow-x:hidden; min-height:100vh; }
        .container { max-width:1000px; margin:0 auto; padding:2rem; }
        header { margin-bottom:2rem; }
        .logo { font-family:'Syne',sans-serif; font-size:2rem; font-weight:800; background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 50%,var(--accent) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; text-decoration:none; }
        h1 { font-family:'Syne',sans-serif; font-size:2.5rem; margin:1rem 0 0.5rem; color:var(--text); }
        .controls { background:var(--dark-light); padding:2rem; border-radius:16px; margin-bottom:2rem; }
        .input-group { display:flex; gap:1rem; margin-bottom:1rem; }
        .form-input { flex:1; background:var(--dark-lighter); border:2px solid var(--dark-lighter); color:var(--text); padding:1rem 1.2rem; border-radius:12px; font-family:'JetBrains Mono',monospace; font-size:1rem; }
        .btn { padding:1rem 2rem; background:linear-gradient(135deg,var(--primary),var(--accent)); color:white; border:none; border-radius:12px; font-family:'Syne',sans-serif; font-size:1rem; font-weight:700; cursor:pointer; transition:all 0.3s ease; }
        .btn:hover:not(:disabled) { transform:translateY(-2px); }
        .btn:disabled { opacity:0.5; cursor:not-allowed; }
        .btn-secondary { background:var(--dark-lighter); color:var(--text); }
        .btn-scaffold  { background:linear-gradient(135deg,#FFC857,#FF6B35); color:white; }

        /* â”€â”€ Picklist Panel â”€â”€ */
        .picklist-panel { background:var(--dark-lighter); border-radius:12px; border:2px solid rgba(0,217,255,0.3); padding:1.5rem; margin-bottom:2rem; }
        .picklist-panel-header { display:flex; align-items:center; gap:0.75rem; margin-bottom:1.2rem; padding-bottom:0.8rem; border-bottom:2px solid rgba(0,217,255,0.2); flex-wrap:wrap; }
        .picklist-panel-header h3 { font-family:'Syne',sans-serif; font-size:1.2rem; color:var(--accent); }
        .picklist-badge { background:var(--dark); color:var(--accent); padding:0.2rem 0.7rem; border-radius:20px; font-size:0.72rem; font-weight:600; border:1px solid rgba(0,217,255,0.3); }
        .picklist-meta-line { color:var(--text-dim); font-size:0.8rem; margin-left:auto; }
        .specs-section-title { font-family:'Syne',sans-serif; font-size:0.85rem; font-weight:700; color:var(--secondary); text-transform:uppercase; letter-spacing:0.08em; margin:1.2rem 0 0.6rem; padding-bottom:0.3rem; border-bottom:1px solid rgba(255,200,87,0.2); }
        .specs-section-title:first-child { margin-top:0; }
        .specs-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:0.65rem; }
        .spec-item { background:var(--dark); border-radius:8px; padding:0.7rem 0.9rem 0.7rem 1rem; border-left:3px solid transparent; position:relative; }
        .spec-item.has-value { border-left-color:rgba(0,217,255,0.5); }
        .spec-item.no-value  { opacity:0.4; }
        .spec-item.highlight { border-left-color:var(--success) !important; }
        .spec-ref   { position:absolute; top:0.35rem; right:0.55rem; font-size:0.6rem; color:var(--text-dim); background:var(--dark-lighter); padding:0.05rem 0.3rem; border-radius:3px; }
        .spec-label { font-size:0.68rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.2rem; }
        .spec-note  { font-size:0.62rem; color:var(--text-dim); font-style:italic; }
        .spec-value { font-size:0.95rem; color:var(--text); font-weight:500; }
        .spec-value.empty-val { font-style:italic; color:var(--text-dim); font-size:0.8rem; font-weight:400; }
        .spec-unit  { font-size:0.68rem; color:var(--text-dim); margin-left:0.2rem; }

        /* Roof map */
        .roof-map-wrap { margin-top:1.2rem; padding:1.2rem; background:var(--dark); border-radius:12px; border:1px solid rgba(0,217,255,0.15); }
        .roof-map-hdr  { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.8rem; flex-wrap:wrap; gap:0.5rem; }
        .roof-map-hdr h4 { font-family:'Syne',sans-serif; font-size:1rem; color:var(--accent); }
        .legend      { display:flex; gap:1rem; flex-wrap:wrap; }
        .legend-item { display:flex; align-items:center; gap:0.4rem; font-size:0.75rem; color:var(--text-dim); }
        .swatch { width:24px; height:16px; border-radius:3px; }
        .swatch.p { background:linear-gradient(135deg,#FF6B35,#FF9559); border:1px solid rgba(255,107,53,0.6); }
        .swatch.l { background:linear-gradient(135deg,#00D9FF,#00A8CC); border:1px solid rgba(0,217,255,0.6); width:30px; height:14px; }
        .swatch.e { background:var(--dark-lighter); border:1px dashed rgba(255,255,255,0.1); }
        .roof-grid-wrap { overflow-x:auto; padding-bottom:0.3rem; }
        .roof-grid { display:inline-grid; gap:3px; padding:0.8rem; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.05); min-width:100%; }
        .cell { width:24px; height:24px; border-radius:3px; display:flex; align-items:center; justify-content:center; font-size:0.55rem; font-weight:700; transition:transform 0.15s; cursor:default; }
        .cell:hover { transform:scale(1.35); z-index:10; }
        .cell.e { background:rgba(255,255,255,0.03); border:1px dashed rgba(255,255,255,0.07); }
        .cell.p { background:linear-gradient(135deg,#FF6B35,#FF9559); border:1px solid rgba(255,149,89,0.8); color:rgba(255,255,255,0.9); box-shadow:0 2px 4px rgba(255,107,53,0.4); }
        .cell.l { background:linear-gradient(135deg,#00D9FF,#00A8CC); border:1px solid rgba(0,217,255,0.8); color:rgba(0,30,50,0.9); box-shadow:0 2px 4px rgba(0,217,255,0.35); }
        .roof-stats { display:flex; gap:1.2rem; margin-top:0.8rem; flex-wrap:wrap; }
        .roof-stat  { display:flex; align-items:center; gap:0.3rem; font-size:0.8rem; color:var(--text-dim); }
        .roof-stat strong { color:var(--text); }

        /* Survey viewer */
        .survey-list { background:var(--dark-light); padding:2rem; border-radius:16px; margin-bottom:2rem; }
        .survey-item { background:var(--dark-lighter); padding:1.5rem; border-radius:12px; margin-bottom:1rem; cursor:pointer; transition:all 0.3s ease; border:2px solid transparent; }
        .survey-item:hover { border-color:var(--accent); transform:translateX(5px); }
        .survey-item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; }
        .survey-item-title { font-family:'Syne',sans-serif; font-size:1.2rem; color:var(--accent); }
        .survey-item-date  { color:var(--text-dim); font-size:0.9rem; }
        .survey-viewer { background:var(--dark-light); padding:2rem; border-radius:16px; display:none; }
        .survey-viewer.active { display:block; }
        .report-header { border-bottom:3px solid var(--primary); padding-bottom:1.5rem; margin-bottom:2rem; }
        .metadata { background:var(--dark-lighter); padding:1.5rem; border-radius:12px; margin-top:1rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; }
        .metadata-item { display:flex; flex-direction:column; gap:0.3rem; }
        .metadata-label { color:var(--text-dim); font-size:0.85rem; text-transform:uppercase; }
        .metadata-value { color:var(--text); font-size:1rem; font-weight:500; }
        .section { margin-bottom:2rem; }
        .section-title { font-family:'Syne',sans-serif; font-size:1.8rem; color:var(--accent); margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:2px solid var(--dark-lighter); }
        .field-row { background:var(--dark-lighter); padding:1rem; border-radius:12px; margin-bottom:0.75rem; border-left:4px solid var(--primary); page-break-inside:avoid; }
        .field-question { font-weight:600; color:var(--text); margin-bottom:0.3rem; font-size:0.95rem; }
        .field-answer   { color:var(--text-dim); padding-left:1rem; font-size:0.9rem; word-wrap:break-word; overflow-wrap:break-word; }
        .field-photos   { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:0.75rem; margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid var(--dark); }
        .photo-container { background:var(--dark); padding:0.5rem; border-radius:8px; border:2px solid var(--dark-lighter); display:flex; flex-direction:column; align-items:center; }
        .survey-photo { width:100%; max-width:100%; height:auto; border-radius:8px; border:2px solid var(--dark); display:block; }
        .action-buttons { display:flex; gap:1rem; margin-bottom:2rem; flex-wrap:wrap; }
        .loading { text-align:center; padding:3rem; color:var(--text-dim); }
        .alert { padding:1rem; border-radius:8px; margin-bottom:1rem; }
        .alert.error   { background:rgba(255,107,107,0.2); color:var(--error);   border:2px solid var(--error); }
        .alert.success { background:rgba(78,204,163,0.2);  color:var(--success); border:2px solid var(--success); }

        @media print {
            body { background:white; color:black; }
            .controls,.action-buttons,.btn,.survey-list { display:none !important; }
            header h1, header .logo { display:none !important; }
            .pdf-logo { display:block !important; }
            .survey-viewer { background:white; display:block !important; }
            .report-header { border-bottom-color:#333; margin-bottom:1.5rem; }
            .section { margin-bottom:1.5rem; }
            .section-title { color:#333; border-bottom-color:#ccc; font-size:1.5rem; margin-bottom:0.75rem; }
            .field-row { background:#f9f9f9; border-left-color:#FF6B35; page-break-inside:avoid; padding:0.75rem; margin-bottom:0.5rem; }
            .field-question { color:#000; font-size:0.9rem; }
            .field-answer { color:#333; font-size:0.85rem; }
            .metadata { background:#f9f9f9; }
            .metadata-label { color:#666; font-size:0.75rem; }
            .metadata-value { color:#000; font-size:0.9rem; }
            .photo-container { background:white; border-color:#ccc; }
            .survey-photo { max-width:100%; height:auto; border-color:#ccc; }
            .field-photos { grid-template-columns:repeat(2,1fr); gap:0.5rem; }
            .picklist-panel { background:#f5f5fa; border-color:#ccc; }
            .spec-item { background:#eee; }
            .spec-label { color:#666; }
            .spec-value { color:#000; }
            .roof-map-wrap { background:#f5f5fa; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <a href="teamview.html" class="logo">Pingu - Solar</a>
        <h1>Survey Viewer</h1>
        <img src="https://www.dropbox.com/scl/fi/kkujm1u6y7vvnp7luq8d7/ngu-main-white.png?rlkey=kgq2uh48qh4xssh4vlbz868lr&st=107e50hs&dl=1"
             alt="Logo" class="pdf-logo" style="display:none;max-width:250px;height:auto;margin:1rem 0;">
    </header>

    <div class="controls">
        <div class="input-group">
            <input type="text" id="job-number-input" class="form-input" placeholder="Enter Job Number (e.g., OE123456)"/>
            <button class="btn" onclick="loadSurveysForJob()">Load Surveys</button>
        </div>
        <div id="alert-container"></div>
    </div>

    <div id="survey-list" class="survey-list" style="display:none;">
        <h2 style="font-family:'Syne',sans-serif;margin-bottom:1rem;">Available Documents</h2>
        <div id="survey-list-items"></div>
    </div>

    <div id="survey-viewer" class="survey-viewer">
        <div class="action-buttons">
            <button class="btn"              onclick="downloadPhotoPack()">ğŸ“· Download Photo Pack</button>
            <button class="btn btn-scaffold" onclick="downloadScaffoldPack()">ğŸ—ï¸ Scaffold Pack</button>
            <button class="btn btn-secondary" onclick="printSurvey()">Print/PDF</button>
            <button class="btn btn-secondary" onclick="backToList()">â† Back to List</button>
        </div>
        <div id="picklist-display"></div>
        <div id="survey-content"></div>
    </div>

    <div id="loading" class="loading" style="display:none;">Loading data...</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, getDocs, query, where, orderBy }
    from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

const cfg = {
    apiKey:"AIzaSyAc_yJQ_rkzuOBh-Yxg0Q4eooXtB-tQjm0",
    authDomain:"pingu-solar.firebaseapp.com", projectId:"pingu-solar",
    storageBucket:"pingu-solar.firebasestorage.app",
    messagingSenderId:"232764952866",
    appId:"1:232764952866:web:5923b7f419de6355d6157b",
    measurementId:"G-PFH059DZ64"
};
const app = initializeApp(cfg);
window.db  = getFirestore(app);
window.storage = getStorage(app);
window.firebaseModules = { collection, getDocs, query, where, orderBy };
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allDocuments    = [];
let currentDocument = null;
let currentPicklist = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PICKLIST SPEC CONFIG  (mirrors picklist generator)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPECS = {
    system: [
        {label:'Type of System',      col:'AO', row:2},
        {label:'Inverter Size',       col:'AO', row:4, note:'Fox & Tesla'},
        {label:'No. of Batteries',    col:'AO', row:6},
        {label:'Battery',             col:'AO', row:7},
        {label:'Retrofit',            col:'AO', row:8, note:'Fox only'},
        {label:'Enphase Pedestal',    col:'AO', row:17},
        {label:'Enphase Branches',    col:'AO', row:12},
        {label:'DC Expansion',        col:'AO', row:21, note:'Tesla'},
    ],
    mounting: [
        {label:'Mounting System',     col:'AS', row:2},
        {label:'Hook Type',           col:'AS', row:4},
        {label:'Ave Hook Spacing',    col:'AS', row:6, unit:'mm'},
        {label:'Hook Spacing',        col:'AS', row:7, unit:'mm'},
        {label:'Min. Roof Anchors',   col:'AS', row:12},
        {label:'Bird Mesh',           col:'AS', row:14},
        {label:'Roof Type',           col:'AS', row:16},
        {label:'Rafter Spacing',      col:'AS', row:17},
    ],
    electrical: [
        {label:'Supply Cables',       col:'AO', row:10},
        {label:'Submain Location',    col:'AO', row:15},
        {label:'Trenching',           col:'AO', row:19},
    ]
};
const MOUNT_CHECK_CELLS = [
    {label:'# Portrait Panels',        col:'I', row:23},
    {label:'# Landscape Panels',       col:'I', row:24},
    {label:'Total Panels',             col:'I', row:25},
    {label:'Total Perimeter',          col:'I', row:26},
    {label:'End Clamps',               col:'S', row:23},
    {label:'Mid Clamps',               col:'S', row:24},
    {label:'Rail Length',              col:'S', row:25},
    {label:'# Roof Anchors',           col:'S', row:26},
    {label:'New Picklist Cost Saving', col:'R', row:28, highlight:true},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SURVEY SECTION CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SECTION_ORDER = [
    'surveyDetails','riskAssessment','electricalSystem',
    'propertyInternal','propertyExternal','scaffolding',
    'customerSignOff','batteryDetails'
];
const FIELD_ORDER = {
    surveyDetails:   ['conductedOn','surveyor','customerPresent','additionalNotesCustomerPresent'],
    riskAssessment:  ['riskAssessmentDone'],
    electricalSystem:['meterPosition','meterPositionPhotos','meterWorkNeeded','meterWorkDetails','meterWorkPhotos','fuseRating','earthingSystem','earthingSystemPhotos','gasBonded','gasBondingEquipment','gasBondedPhotos','waterBonded','waterBondingEquipment','waterBondedPhotos','cableRun','cableRunPhotos','batteryLocation','batteryLocationPhotos','surfaceType','surfacePhotos','batteryWidth','batteryDepth','batteryLength','additionalNotesBattery','renderCladding','wifiSignal'],
    propertyInternal:['loftAccessible','loftAccessiblePhotos','loftLadder','loftBoarded','asbestos','asbestosPhotos','loftSpacePhotos','rafterWidth','rafterDepth','webWidth','webDepth','webLength','trussSpacing','deflection','deflectionPhotos','rotDamage','rotDamagePhotos','roofConcern','roofConcernPhotos','dwarfWalls','dwarfWallsPhotos','structuralWork','structuralWorkPhotos'],
    propertyExternal:['proposedDesignFit','propertyPhotos','roofCovering','roofCoveringPhotos','numberStories','roofCondition','roofConditionPhotos','roofWorkAge','roofObstructions','obstructionsPhotos','roofShading','shadingPhotos','additionalNotesProperty'],
    scaffolding:     ['accessType','parkingAvailable','overheadPowerlines','powerlinesPhotos','propertyOnPavement','pavementPhotos','groundType','groundTypePhotos','accessIssues','gutterObstacles','gutterObstaclesPhotos','lowerRoofs','lowerRoofsPhotos','additionalNotes'],
    customerSignOff: ['date','name','signature'],
    batteryDetails:  ['date','time','name']
};
const QT = {
    conductedOn:'Conducted On (Date and Time)',surveyor:'Surveyor',
    customerPresent:'Customer Present During Survey?',additionalNotesCustomerPresent:'Additional Notes',
    riskAssessmentDone:'Has a Risk Assessment Been Carried Out in Accordance with the Octopus Energy Site Survey Assessment Document?',
    meterPosition:'Position of Meter Cupboard or Incoming Supply',meterWorkNeeded:'Does work need to be carried out on the meter?',
    meterWorkDetails:'What work is required on the meter?',fuseRating:'What is the Fuse Rating?',
    earthingSystem:'Type of Earthing System',gasBonded:'Is Gas Bonded?',
    gasBondingEquipment:'Equipment and Location of Bonding Required',waterBonded:'Is Water Bonded?',
    waterBondingEquipment:'Equipment and Location of Bonding Required',cableRun:"Describe the Cable Run(s)",
    batteryLocation:'Battery and Inverter Location',surfaceType:'Type of Surface at Battery Location',
    batteryWidth:'Width (mm)',batteryDepth:'Depth (mm)',batteryLength:'Length (mm)',
    additionalNotesBattery:'Additional Notes',renderCladding:'Any Signs of Render or Cladding?',
    wifiSignal:'Is there WiFi Signal at the Proposed Inverter Location?',
    loftAccessible:'Is the Loft Accessible?',loftLadder:'Is a Loft Ladder Installed?',
    loftBoarded:'Is the Loft Boarded?',asbestos:'Are there any Signs of Asbestos?',
    rafterWidth:'Rafter Width (mm)',rafterDepth:'Rafter Depth (mm)',
    webWidth:'Web Width (mm)',webDepth:'Web Depth (mm)',webLength:'Web Length (mm)',
    trussSpacing:'Truss Spacing (mm)',
    deflection:'Are there any Signs of Deflection to the Existing Roof Slopes?',
    rotDamage:'Are there any Signs of Rot/Damage to the Internal Roof Structure?',
    roofConcern:'Are there any Signs of Anything Which Would Cause for Concern When Fitting Panels to the Roof?',
    dwarfWalls:'Are there any Dwarf Walls/Props Which Support the Purlins?',
    structuralWork:'Is there any Signs of Structural Work Which Has Been Carried Out to the Roof Structure Before?',
    proposedDesignFit:'Does the Proposed Design Fit?',roofCovering:'What is the Roof Covering Type?',
    numberStories:'Number of Stories',roofCondition:'Condition of Roof?',
    roofWorkAge:'How Many Years Ago was the Last Work Carried Out on the Roof?',
    roofObstructions:'Are there any Obstructions on the Roof?',roofShading:'Is there any Form of Shading?',
    additionalNotesProperty:'Additional Notes',accessType:'Type of Access to Property',
    parkingAvailable:'Parking Available?',
    overheadPowerlines:'Are there any Overhead Powerlines Close to the Property?',
    propertyOnPavement:'Is the Property on a Pavement or Main Highway?',
    groundType:'Type of Ground Around for Scaffolding',
    accessIssues:'Any Access Issues? (through the house or through a garage for example)',
    gutterObstacles:'Any Obstacles Below the Gutter Line?',
    lowerRoofs:'Lower Roofs - Are They Weight Bearing or To Be Avoided?',
    additionalNotes:'Scaffolding Additional Notes',
    date:'Date',name:'Customer Name',signature:'Customer Signature'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAlert(msg, type='error') {
    const c = document.getElementById('alert-container');
    c.innerHTML = `<div class="alert ${type}">${msg}</div>`;
    setTimeout(() => c.innerHTML = '', 6000);
}
function esc(t) { const d=document.createElement('div'); d.textContent=String(t||''); return d.innerHTML; }
function fmtVal(v) {
    if (v==null||v==='') return 'N/A';
    if (typeof v==='boolean') return v?'Yes':'No';
    if (Array.isArray(v)) return v.filter(i=>typeof i==='string'&&!i.startsWith('http')&&!i.startsWith('data:')).join(', ')||'N/A';
    if (typeof v==='object') return JSON.stringify(v);
    return String(v);
}

// Strip emoji/unicode so jsPDF (Helvetica) doesn't render garbage glyphs
function stripEmoji(str) {
    return str
        .replace(/[\u{1F000}-\u{1FFFF}]/gu, '')  // emoji blocks
        .replace(/[\u2600-\u27BF]/g, '')           // misc symbols
        .replace(/\s{2,}/g, ' ')
        .trim();
}

// Fetch image blob â†’ object URL â†’ canvas â†’ base64.
// Object URLs are same-origin so canvas.toDataURL() never throws a security error,
// regardless of where the original image was hosted (Firebase Storage, etc.)
async function imgToBase64(url) {
    try {
        const res  = await fetch(url);
        if (!res.ok) return null;
        const blob = await res.blob();
        const objURL = URL.createObjectURL(blob);
        return await new Promise(resolve => {
            const img = new Image();
            img.onload = () => {
                try {
                    const c = document.createElement('canvas');
                    c.width  = img.naturalWidth  || img.width  || 800;
                    c.height = img.naturalHeight || img.height || 600;
                    c.getContext('2d').drawImage(img, 0, 0);
                    const b64 = c.toDataURL('image/jpeg', 0.85);
                    URL.revokeObjectURL(objURL);
                    resolve({ b64, w: c.width, h: c.height });
                } catch(e) { URL.revokeObjectURL(objURL); resolve(null); }
            };
            img.onerror = () => { URL.revokeObjectURL(objURL); resolve(null); };
            img.src = objURL;
        });
    } catch(e) {
        console.warn('imgToBase64 fetch failed:', url, e.message);
        return null;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD SURVEYS + PICKLIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSurveysForJob() {
    const jobNumber = document.getElementById('job-number-input').value.trim();
    if (!jobNumber) return showAlert('Please enter a job number');

    document.getElementById('loading').style.display = 'block';
    document.getElementById('survey-list').style.display = 'none';
    document.getElementById('survey-viewer').classList.remove('active');

    try {
        const { collection, query, where, getDocs, orderBy } = window.firebaseModules;
        const cols = ['site-surveys','jobs','installations','customers','surveys',
                      'battery-surveys','solar-surveys','inspections','tasks','notes'];
        allDocuments = [];
        for (const col of cols) {
            try {
                const snap = await getDocs(query(collection(window.db, col), where('jobNumber','==',jobNumber)));
                snap.forEach(d => allDocuments.push({ id:d.id, source:col, data:d.data() }));
            } catch(e) {}
        }

        // Most-recent picklist for this job
        currentPicklist = null;
        try {
            const plSnap = await getDocs(query(
                collection(window.db,'picklists'),
                where('jobNumber','==',jobNumber),
                orderBy('savedAt','desc')
            ));
            if (!plSnap.empty) currentPicklist = plSnap.docs[0].data();
        } catch(e) { console.warn('Picklist query:', e.message); }

        if (!allDocuments.length) {
            showAlert('No data found for this job number');
            document.getElementById('loading').style.display = 'none';
            return;
        }

        allDocuments.sort((a,b) => {
            const da = a.data.submittedAt||a.data.createdAt||a.data.timestamp||0;
            const db2= b.data.submittedAt||b.data.createdAt||b.data.timestamp||0;
            return new Date(db2)-new Date(da);
        });

        displayDocumentList();
        const plMsg = currentPicklist ? ' Â· Picklist found âœ…' : '';
        showAlert(`Found ${allDocuments.length} document(s)${plMsg}`, 'success');
    } catch(e) {
        console.error(e);
        showAlert('Error loading data: '+e.message);
    } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('survey-list').style.display = 'block';
    }
}
window.loadSurveysForJob = loadSurveysForJob;
document.getElementById('job-number-input').addEventListener('keydown', e => { if(e.key==='Enter') loadSurveysForJob(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOCUMENT LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function displayDocumentList() {
    const container = document.getElementById('survey-list-items');
    container.innerHTML = allDocuments.map((doc,i) => {
        const d = doc.data.submittedAt||doc.data.createdAt||doc.data.timestamp;
        const date = d ? new Date(d).toLocaleDateString('en-GB') : 'Unknown';
        const time = d ? new Date(d).toLocaleTimeString('en-GB') : '';
        return `<div class="survey-item" onclick="viewDocument(${i})">
            <div class="survey-item-header">
                <div class="survey-item-title">${doc.source.replace(/-/g,' ').toUpperCase()}</div>
                <div class="survey-item-date">${date} ${time}</div>
            </div>
            <div style="color:var(--text-dim);font-size:0.9rem;">Job: ${doc.data.jobNumber||'N/A'} | ID: ${doc.id}</div>
        </div>`;
    }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEW DOCUMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function viewDocument(index) {
    currentDocument = allDocuments[index];
    const d = currentDocument.data.submittedAt||currentDocument.data.createdAt||currentDocument.data.timestamp;
    const date = d ? new Date(d).toLocaleDateString('en-GB') : 'N/A';
    const time = d ? new Date(d).toLocaleTimeString('en-GB') : 'N/A';

    // Picklist panel
    document.getElementById('picklist-display').innerHTML = currentPicklist
        ? buildPicklistHTML(currentPicklist)
        : '<div style="color:var(--text-dim);font-size:0.85rem;margin-bottom:1.5rem;padding:0.8rem 1rem;background:var(--dark-lighter);border-radius:8px;border-left:3px solid var(--text-dim);">â„¹ï¸ No saved picklist found for this job.</div>';

    // Survey content
    let html = `<div class="report-header">
        <h1>${currentDocument.source.replace(/-/g,' ').toUpperCase()}</h1>
        <div class="metadata">
            <div class="metadata-item"><div class="metadata-label">Collection</div><div class="metadata-value">${currentDocument.source}</div></div>
            <div class="metadata-item"><div class="metadata-label">Document ID</div><div class="metadata-value">${currentDocument.id}</div></div>
            <div class="metadata-item"><div class="metadata-label">Job Number</div><div class="metadata-value">${currentDocument.data.jobNumber||'N/A'}</div></div>
            <div class="metadata-item"><div class="metadata-label">Date</div><div class="metadata-value">${date}</div></div>
            <div class="metadata-item"><div class="metadata-label">Time</div><div class="metadata-value">${time}</div></div>
        </div>
    </div>`;

    if (currentDocument.data.sections) {
        SECTION_ORDER.forEach(secKey => {
            if (currentDocument.data.sections[secKey])
                html += renderSection(secKey, currentDocument.data.sections[secKey]);
        });
    } else {
        html += '<div class="section"><h2 class="section-title">All Fields</h2>';
        Object.keys(currentDocument.data).forEach(k => {
            if (k==='sections') return;
            const q = QT[k]||k.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase());
            html += `<div class="field-row"><div class="field-question">${q}</div><div class="field-answer">${smartFmt(currentDocument.data[k])}</div></div>`;
        });
        html += '</div>';
    }

    document.getElementById('survey-content').innerHTML = html;
    document.getElementById('survey-list').style.display = 'none';
    document.getElementById('survey-viewer').classList.add('active');
    window.scrollTo(0,0);
}
window.viewDocument = viewDocument;

function renderSection(secKey, data) {
    const title = secKey.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();
    const order = FIELD_ORDER[secKey] || Object.keys(data).sort();
    let html = `<div class="section"><h2 class="section-title">${title}</h2>`;
    order.forEach(key => {
        if (key.endsWith('Photos')) return;
        const val    = data[key];
        const photos = data[key+'Photos'] || [];
        if ((val==null||val==='') && !photos.length) return;
        const q = QT[key]||key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();
        html += `<div class="field-row"><div class="field-question">${q}</div><div class="field-answer">${smartFmt(val)}</div>`;
        if (photos.length) {
            html += '<div class="field-photos">';
            photos.forEach((p,i) => {
                const src = typeof p==='string'?p:'';
                html += `<div class="photo-container"><img src="${src}" class="survey-photo" alt="Photo ${i+1}" loading="lazy"/></div>`;
            });
            html += '</div>';
        }
        html += '</div>';
    });
    return html + '</div>';
}

function smartFmt(v) {
    if (v==null||v==='') return 'N/A';
    if (typeof v==='boolean') return v?'Yes':'No';
    if (typeof v==='number')  return v.toString();
    if (Array.isArray(v)) {
        if (v.length && typeof v[0]==='string' && (v[0].startsWith('data:image')||v[0].startsWith('http')))
            return `<span style="color:var(--accent)">${v.length} photo(s) attached</span>`;
        return v.join(', ')||'N/A';
    }
    if (typeof v==='object') {
        const ks = Object.keys(v);
        if (ks.length>3) return `<span style="color:var(--text-dim)">Object (${ks.length} properties)</span>`;
        return `<pre style="font-size:0.8rem;padding:0.5rem;background:var(--dark);border-radius:4px;overflow-x:auto;white-space:pre-wrap">${JSON.stringify(v,null,2)}</pre>`;
    }
    if (typeof v==='string') {
        if (v.startsWith('data:image'))
            return `<img src="${v}" class="survey-photo" style="max-width:300px;border-radius:8px;margin-top:0.5rem" loading="lazy"/>`;
        if ((v.startsWith('http://')||v.startsWith('https://'))&&(v.includes('firebasestorage')||/\.(jpg|jpeg|png|gif|webp)$/i.test(v)))
            return `<img src="${v}" class="survey-photo" style="max-width:300px;border-radius:8px;margin-top:0.5rem" loading="lazy"/>`;
    }
    return esc(v);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PICKLIST PANEL HTML  (on-screen)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPicklistHTML(pl) {
    const dt = pl.savedAt ? new Date(pl.savedAt).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : '';

    const specCard = (d) => {
        const v   = pl.specs?.[d.label]||'';
        const noteH = d.note?`<span class="spec-note"> (${esc(d.note)})</span>`:'';
        const unitH = (v&&d.unit)?`<span class="spec-unit">${esc(d.unit)}</span>`:'';
        const hlCls = d.highlight?' highlight':'';
        return `<div class="spec-item ${v?'has-value':'no-value'}${hlCls}">
            <div class="spec-ref">${d.col}${d.row}</div>
            <div class="spec-label">${esc(d.label)}${noteH}</div>
            <div class="spec-value ${v?'':'empty-val'}">${v?esc(v)+unitH:'â€”'}</div>
        </div>`;
    };

    const mcCard = (d) => {
        const v   = pl.mountCheck?.[d.label]||'';
        const hlCls = d.highlight?' highlight':'';
        return `<div class="spec-item ${v?'has-value':'no-value'}${hlCls}">
            <div class="spec-ref">${d.col}${d.row}</div>
            <div class="spec-label">${esc(d.label)}</div>
            <div class="spec-value ${v?'':'empty-val'}">${v?esc(v):'â€”'}</div>
        </div>`;
    };

    const flatArr  = pl.panelFlat||(pl.panelGrid?pl.panelGrid.flat():null);
    const cols     = pl.panelCols||(pl.panelGrid?.[0]?.length)||0;
    let roofHTML   = '';
    if (flatArr && cols) {
        let pC=0,lC=0,cells='';
        flatArr.forEach(v => {
            if(v==='P')pC++; if(v==='L')lC++;
            const cls=v==='P'?'p':v==='L'?'l':'e';
            cells+=`<div class="cell ${cls}">${v==='P'?'P':v==='L'?'L':''}</div>`;
        });
        if (pC||lC) roofHTML=`
        <div class="roof-map-wrap">
            <div class="roof-map-hdr">
                <h4>ğŸ  Roof Panel Layout</h4>
                <div class="legend">
                    <div class="legend-item"><div class="swatch p"></div>Portrait (P)</div>
                    <div class="legend-item"><div class="swatch l"></div>Landscape (L)</div>
                    <div class="legend-item"><div class="swatch e"></div>Empty</div>
                </div>
            </div>
            <div class="roof-grid-wrap">
                <div class="roof-grid" style="grid-template-columns:repeat(${cols},24px)">${cells}</div>
            </div>
            <div class="roof-stats">
                <div class="roof-stat">ğŸŸ§ Portrait: <strong>${pC}</strong></div>
                <div class="roof-stat">ğŸŸ¦ Landscape: <strong>${lC}</strong></div>
                <div class="roof-stat">ğŸ“ Total: <strong>${pC+lC}</strong></div>
            </div>
        </div>`;
    }

    return `<div class="picklist-panel">
        <div class="picklist-panel-header">
            <h3>ğŸ“‹ Picklist</h3>
            <div class="picklist-badge">Job #${esc(pl.jobNumber||'')}</div>
            <div class="picklist-meta-line">${esc(pl.customerName||'')}${pl.installDate?' Â· Install: '+esc(pl.installDate):''} Â· Saved ${dt}</div>
        </div>
        <div class="specs-section-title">âš¡ System Configuration</div>
        <div class="specs-grid">${SPECS.system.map(specCard).join('')}</div>
        <div class="specs-section-title">ğŸ”© Mounting &amp; Hardware</div>
        <div class="specs-grid">${SPECS.mounting.map(specCard).join('')}</div>
        <div class="specs-section-title">ğŸ”Œ Electrical &amp; Supply</div>
        <div class="specs-grid">${SPECS.electrical.map(specCard).join('')}</div>
        <div class="specs-section-title">âœ… Mount System Sense Check</div>
        <div class="specs-grid">${MOUNT_CHECK_CELLS.map(mcCard).join('')}</div>
        ${roofHTML}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLLECT SCAFFOLD PHOTO URLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function collectScaffoldPhotos(data) {
    const urls  = [];
    const scData = data.sections?.scaffolding || {};
    FIELD_ORDER.scaffolding.filter(k=>k.endsWith('Photos')).forEach(pk => {
        (scData[pk]||[]).forEach(url => {
            if (typeof url==='string' && (url.startsWith('http')||url.startsWith('data:image')))
                urls.push({ url, key:pk });
        });
    });
    return urls;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FULL PHOTO PACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function downloadPhotoPack() {
    if (!currentDocument) return showAlert('No document loaded');
    showAlert('Preparing photo packâ€¦', 'success');
    try {
        const res = await fetch('https://us-central1-pingu-solar.cloudfunctions.net/downloadPhotosPack', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ collection:currentDocument.source, documentId:currentDocument.id })
        });
        if (!res.ok) throw new Error(await res.text()||'Failed');
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${currentDocument.data.jobNumber||'unknown'}_photos.zip`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        showAlert('Photo pack downloaded!', 'success');
    } catch(e) { showAlert('Error: '+e.message); }
}
window.downloadPhotoPack = downloadPhotoPack;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCAFFOLD PACK  (PDF + ZIP)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function downloadScaffoldPack() {
    if (!currentDocument) return showAlert('No document loaded');
    const data       = currentDocument.data;
    const jobNumber  = data.jobNumber || 'unknown';
    const scData     = data.sections?.scaffolding || {};
    const scFields   = FIELD_ORDER.scaffolding.filter(k=>!k.endsWith('Photos'));
    const hasScaffold= scFields.some(k => scData[k]!=null && scData[k]!=='');
    const photoUrls  = collectScaffoldPhotos(data);

    if (!hasScaffold && !photoUrls.length && !currentPicklist)
        return showAlert('No scaffolding data or picklist found in this document');

    showAlert('Building scaffold packâ€¦ please wait.', 'success');

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });
        const PW=210, PH=297, M=14, CW=PW-M*2;
        let y = M;

        // â”€â”€ Colour palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const ORANGE=[255,107,53], AMBER=[255,200,87], DARK=[26,26,46],
              DARKISH=[47,47,74],  GREY=[140,140,160],  BLACK=[30,30,30],
              CYAN=[0,180,210],    GREEN=[78,204,163],   WHITE=[255,255,255];

        // â”€â”€ Page utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function drawTopStripe() { doc.setFillColor(...ORANGE); doc.rect(0,0,PW,7,'F'); }
        function drawFooter() {
            doc.setFillColor(...ORANGE); doc.rect(0,PH-7,PW,7,'F');
            doc.setTextColor(...WHITE); doc.setFontSize(7); doc.setFont('helvetica','normal');
            const total = doc.getNumberOfPages();
            // footer text set after all pages added; store page ref
        }
        function checkY(need=10) { if (y+need > PH-10) { doc.addPage(); y=M; drawTopStripe(); } }

        function sectionBar(label, colour=ORANGE) {
            checkY(11);
            doc.setFillColor(...colour); doc.roundedRect(M,y,CW,8,1,1,'F');
            doc.setTextColor(...WHITE); doc.setFontSize(9); doc.setFont('helvetica','bold');
            doc.text(stripEmoji(label).toUpperCase(), M+4, y+5.5);
            y += 11;
        }

        function specRow(label, value, idx, highlightColour=null) {
            const safeLabel = stripEmoji(label);
            const lines = doc.splitTextToSize(String(value||'â€”'), CW-76);
            const rowH  = Math.max(10, 5 + lines.length*4.5);
            checkY(rowH+1);
            const bg = idx%2===0 ? [247,247,252] : [255,255,255];
            doc.setFillColor(...bg); doc.rect(M,y,CW,rowH,'F');
            doc.setFillColor(...(highlightColour||CYAN)); doc.rect(M,y,2,rowH,'F');
            doc.setTextColor(...GREY); doc.setFontSize(6.8); doc.setFont('helvetica','normal');
            const truncLabel = doc.splitTextToSize(safeLabel.toUpperCase(), 68);
            doc.text(truncLabel[0], M+4, y+4);
            doc.setTextColor(...(highlightColour||BLACK)); doc.setFontSize(8.5); doc.setFont('helvetica','bold');
            lines.forEach((ln,li) => doc.text(ln, M+4, y+8.5+li*4.5));
            y += rowH+1;
        }

        function twoColRow(l1,v1,l2,v2,idx) {
            const hw=(CW-4)/2, rowH=10;
            checkY(rowH+1);
            const bg=idx%2===0?[247,247,252]:[255,255,255];
            doc.setFillColor(...bg); doc.rect(M,y,CW,rowH,'F');
            doc.setTextColor(...GREY); doc.setFontSize(6.5); doc.setFont('helvetica','normal');
            doc.text(stripEmoji(l1).toUpperCase(), M+3, y+3.8);
            doc.setTextColor(...BLACK); doc.setFontSize(8.5); doc.setFont('helvetica','bold');
            doc.text(doc.splitTextToSize(v1||'â€”',hw-6)[0]||'â€”', M+3, y+8);
            if (l2) {
                doc.setTextColor(...GREY); doc.setFontSize(6.5); doc.setFont('helvetica','normal');
                doc.text(stripEmoji(l2).toUpperCase(), M+hw+7, y+3.8);
                doc.setTextColor(...BLACK); doc.setFontSize(8.5); doc.setFont('helvetica','bold');
                doc.text(doc.splitTextToSize(v2||'â€”',hw-6)[0]||'â€”', M+hw+7, y+8);
            }
            y += rowH+1;
        }

        // â”€â”€ PAGE 1 HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        drawTopStripe(); y=15;
        doc.setFillColor(...DARK); doc.roundedRect(M,y,CW,26,3,3,'F');
        doc.setTextColor(...WHITE); doc.setFontSize(17); doc.setFont('helvetica','bold');
        doc.text('SCAFFOLD INFORMATION PACK', M+6, y+12);
        doc.setFontSize(8.5); doc.setFont('helvetica','normal'); doc.setTextColor(...GREY);
        doc.text(`Job: ${jobNumber}   Â·   Generated: ${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB')}`, M+6, y+21);
        y += 32;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  PICKLIST SECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (currentPicklist) {
            const pl = currentPicklist;

            sectionBar('ğŸ“‹ Job Details', DARK);
            [['Job Number',pl.jobNumber||''], ['Customer Name',pl.customerName||''],
             ['Install Date',pl.installDate||''],
             ['Picklist Saved', pl.savedAt?new Date(pl.savedAt).toLocaleDateString('en-GB'):'']
            ].forEach(([l,v],i) => twoColRow(l,v,'','',i));
            y += 4;

            sectionBar('âš¡ System Configuration', DARKISH);
            SPECS.system.forEach((d,i) => {
                const v = pl.specs?.[d.label]||'';
                const lbl = d.label + (d.note?` (${d.note})`:d.unit?` (${d.unit})`:'');
                specRow(lbl, v||'â€”', i);
            });
            y += 3;

            sectionBar('Mounting & Hardware', DARKISH);
            SPECS.mounting.forEach((d,i) => {
                const v   = pl.specs?.[d.label]||'';
                const lbl = d.label + (d.unit?` (${d.unit})`:'');
                specRow(lbl, v||'â€”', i);
            });
            y += 3;

            sectionBar('ğŸ”Œ Electrical & Supply', DARKISH);
            SPECS.electrical.forEach((d,i) => specRow(d.label, pl.specs?.[d.label]||'â€”', i));
            y += 3;

            sectionBar('âœ… Mount System Sense Check', DARKISH);
            MOUNT_CHECK_CELLS.forEach((d,i) => {
                const v = pl.mountCheck?.[d.label]||'';
                specRow(d.label, v||'â€”', i, d.highlight?GREEN:null);
            });
            y += 3;

            // Roof grid
            const flatArr   = pl.panelFlat||(pl.panelGrid?pl.panelGrid.flat():null);
            const panelCols = pl.panelCols||(pl.panelGrid?.[0]?.length)||0;
            if (flatArr && panelCols) {
                let pC=0,lC=0;
                flatArr.forEach(v=>{if(v==='P')pC++;if(v==='L')lC++;});
                if (pC||lC) {
                    const rows = Math.ceil(flatArr.length/panelCols);
                    const CS   = Math.min(5, (CW-10)/panelCols); // cell size, max 5mm
                    const gridW = panelCols*CS, gridH = rows*CS;
                    sectionBar('ğŸ  Roof Panel Layout', DARKISH);
                    checkY(gridH+14);
                    for (let r=0;r<rows;r++) {
                        for (let c=0;c<panelCols;c++) {
                            const v = flatArr[r*panelCols+c]||'';
                            const cx = M+c*CS, cy=y+r*CS;
                            if      (v==='P') { doc.setFillColor(255,107,53); doc.setDrawColor(255,149,89); }
                            else if (v==='L') { doc.setFillColor(0,180,210);  doc.setDrawColor(0,217,255);  }
                            else              { doc.setFillColor(45,45,65);   doc.setDrawColor(55,55,75);   }
                            doc.rect(cx, cy, CS-0.4, CS-0.4, 'FD');
                        }
                    }
                    y += gridH+3;
                    doc.setFontSize(7.5); doc.setFont('helvetica','normal'); doc.setTextColor(...GREY);
                    doc.text(`Portrait: ${pC}   Landscape: ${lC}   Total: ${pC+lC}   Grid: ${panelCols}x${rows}`, M, y);
                    y += 8;
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  SCAFFOLDING SURVEY FIELDS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (hasScaffold) {
            sectionBar('ğŸ—ï¸ Scaffolding Survey', ORANGE);
            scFields.forEach((key, i) => {
                const val = scData[key];
                if (val==null||val==='') return;
                const q = QT[key]||key.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();
                specRow(q, fmtVal(val), i);
            });
            y += 3;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  FETCH ALL PHOTOS VIA CLOUD FUNCTION (same
        //  method as the working "Download Photo Pack")
        //  then filter to scaffold entries only.
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let scaffoldImageEntries = []; // { name, blob, b64, w, h, caption }

        if (photoUrls.length > 0) {
            showAlert('Fetching photos via serverâ€¦ please wait.', 'success');
            try {
                const cfRes = await fetch(
                    'https://us-central1-pingu-solar.cloudfunctions.net/downloadPhotosPack',
                    { method:'POST', headers:{'Content-Type':'application/json'},
                      body: JSON.stringify({ collection: currentDocument.source, documentId: currentDocument.id }) }
                );
                if (!cfRes.ok) throw new Error('Photo fetch failed: ' + await cfRes.text());

                const fullZipBlob = await cfRes.blob();
                const fullZip     = await JSZip.loadAsync(fullZipBlob);

                // Build a lookup: URL fragment â†’ caption label, for ordering
                // The ZIP filenames won't match URLs directly, so we extract ALL
                // images then match by order against photoUrls (same count).
                const allEntries = Object.values(fullZip.files)
                    .filter(f => !f.dir && /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name))
                    .sort((a,b) => a.name.localeCompare(b.name));

                // Try to match only scaffold-section files by filename keyword,
                // fall back to all images if none match.
                const scaffoldKeywords = ['scaffold','powerline','pavement','ground','gutter','lowerroof','lower_roof'];
                let filtered = allEntries.filter(f =>
                    scaffoldKeywords.some(kw => f.name.toLowerCase().includes(kw))
                );
                if (filtered.length === 0) filtered = allEntries; // fallback: use all

                // Convert each to base64 for jsPDF
                for (let idx=0; idx<filtered.length; idx++) {
                    const entry = filtered[idx];
                    const blob  = await entry.async('blob');
                    const b64   = await new Promise(res => {
                        const reader = new FileReader();
                        reader.onload = () => res(reader.result);
                        reader.readAsDataURL(blob);
                    });
                    // get dimensions
                    const { w, h } = await new Promise(res => {
                        const img = new Image();
                        img.onload = () => res({ w: img.naturalWidth||800, h: img.naturalHeight||600 });
                        img.onerror= () => res({ w:800, h:600 });
                        img.src = b64;
                    });
                    // Caption: use matching photoUrls entry if available, else derive from filename
                    const caption = (photoUrls[idx]?.key || entry.name)
                        .replace(/Photos$/,'').replace(/\.[^.]+$/,'')
                        .replace(/([A-Z])/g,' $1').replace(/_/g,' ').trim();
                    scaffoldImageEntries.push({ name: entry.name, blob, b64, w, h, caption });
                }
            } catch(fetchErr) {
                console.warn('Cloud function photo fetch failed:', fetchErr.message);
                showAlert('Warning: could not load photos â€” ' + fetchErr.message);
            }
        }

        // â”€â”€ Embed photos in PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (scaffoldImageEntries.length > 0) {
            sectionBar(`Scaffolding Photos (${scaffoldImageEntries.length})`, ORANGE);
            const IW = (CW-5)/2, MAX_H = 74;

            for (let i=0; i<scaffoldImageEntries.length; i+=2) {
                const imgL = scaffoldImageEntries[i];
                const imgR = scaffoldImageEntries[i+1] || null;

                const placeImg = (entry, xOff) => {
                    if (!entry) return 0;
                    const aspect = entry.w / entry.h;
                    let iw=IW, ih=iw/aspect;
                    if (ih>MAX_H) { ih=MAX_H; iw=ih*aspect; }
                    const xPos = M + xOff + (IW-iw)/2;
                    const fmt  = entry.b64.includes('image/png') ? 'PNG' : 'JPEG';
                    doc.addImage(entry.b64, fmt, xPos, y, iw, ih);
                    doc.setFontSize(6.5); doc.setFont('helvetica','normal'); doc.setTextColor(...GREY);
                    doc.text(`Photo ${i+(xOff===0?1:2)}: ${stripEmoji(entry.caption)}`, M+xOff, y+ih+4);
                    return ih+6;
                };

                checkY(MAX_H+14);
                const hL = placeImg(imgL, 0);
                const hR = placeImg(imgR, IW+5);
                const rowH = Math.max(hL, hR);
                if (rowH>0) y += rowH+3;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  FOOTERS on every page
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const total = doc.getNumberOfPages();
        for (let p=1; p<=total; p++) {
            doc.setPage(p);
            doc.setFillColor(...ORANGE); doc.rect(0,PH-7,PW,7,'F');
            doc.setTextColor(...WHITE); doc.setFontSize(7); doc.setFont('helvetica','normal');
            doc.text(`Pingu Solar  Â·  Job: ${jobNumber}  Â·  Scaffold Pack`, M, PH-2.5);
            doc.text(`Page ${p} of ${total}`, PW-M, PH-2.5, {align:'right'});
        }

        doc.save(`${jobNumber}_scaffold_pack.pdf`);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  ZIP â€” re-zip just the scaffold photos
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (scaffoldImageEntries.length > 0) {
            showAlert('PDF saved! Zipping scaffold photosâ€¦', 'success');
            const zip    = new JSZip();
            const folder = zip.folder('scaffold_photos');
            scaffoldImageEntries.forEach((entry, idx) => {
                const ext = entry.blob.type.includes('png') ? 'png' : 'jpg';
                const cap = entry.caption.replace(/\s+/g,'_').toLowerCase().replace(/[^a-z0-9_]/g,'');
                folder.file(`scaffold_${String(idx+1).padStart(2,'0')}_${cap}.${ext}`, entry.blob);
            });
            const zipBlob = await zip.generateAsync({type:'blob'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(zipBlob);
            a.download = `${jobNumber}_scaffold_photos.zip`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        showAlert('âœ… Scaffold pack complete!', 'success');
    } catch(err) {
        console.error('Scaffold pack error:', err);
        showAlert('Error generating scaffold pack: '+err.message);
    }
}
window.downloadScaffoldPack = downloadScaffoldPack;

function printSurvey() { window.print(); }
window.printSurvey = printSurvey;

function backToList() {
    document.getElementById('survey-viewer').classList.remove('active');
    document.getElementById('survey-list').style.display = 'block';
}
window.backToList = backToList;
</script>
</body>
</html>
