<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Timeline | Pingu - Solar</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Google Identity Services (replaces MSAL) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #FFC857;
            --accent: #00D9FF;
            --dark: #1A1A2E;
            --dark-light: #252541;
            --dark-lighter: #2F2F4A;
            --text: #EAEAEA;
            --text-dim: #9A9AB0;
            --success: #4ECCA3;
            --error: #FF6B6B;
            --warning: #FFC857;
            --shadow: rgba(255, 107, 53, 0.3);
            --in-progress: #00D9FF;
            --complete: #4ECCA3;
            --aborted: #FF6B6B;
            --cancelled: #9A9AB0;
            --short-notice: #90ee90;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--dark);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 217, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 200, 87, 0.06) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }
        .container { max-width: 100%; margin: 0 auto; padding: 2rem; }
        header {
            margin-bottom: 2rem;
            animation: slideDown 0.8s ease-out;
            max-width: 1600px;
            margin-left: auto; margin-right: auto;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .header-content { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        .logo {
            font-family: 'Syne', sans-serif;
            font-size: 2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            text-decoration: none;
        }
        .back-btn {
            background: var(--dark-light); color: var(--text); text-decoration: none;
            padding: 0.7rem 1.5rem; border-radius: 8px; font-size: 0.9rem;
            transition: all 0.3s ease; border: 2px solid transparent;
        }
        .back-btn:hover { background: var(--dark-lighter); border-color: var(--primary); transform: translateX(-5px); }
        h1 { font-family: 'Syne', sans-serif; font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--text); }
        .subtitle { color: var(--text-dim); font-size: 0.95rem; }
        .controls-card {
            background: var(--dark-light); border-radius: 16px; padding: 2rem;
            border: 2px solid transparent; animation: fadeInUp 0.6s ease-out;
            max-width: 1600px; margin-left: auto; margin-right: auto; margin-bottom: 2rem;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .controls-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .control-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .control-label { color: var(--text-dim); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; }
        .control-input {
            background: var(--dark-lighter); border: 2px solid var(--dark-lighter);
            color: var(--text); padding: 0.8rem 1rem; border-radius: 8px;
            font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; transition: all 0.3s ease;
        }
        .control-input:focus { outline: none; border-color: var(--primary); }
        .timeline-container {
            background: var(--dark-light); border-radius: 16px; padding: 1.5rem;
            border: 2px solid var(--dark-lighter); animation: fadeInUp 0.8s ease-out;
            overflow-x: auto; max-width: 100%;
        }
        .timeline-wrapper { min-width: 1200px; position: relative; }
        .timeline-header {
            display: grid; grid-template-columns: 200px 1fr; gap: 1rem; margin-bottom: 1rem;
            position: sticky; top: 0; background: var(--dark-light); z-index: 10;
            padding-bottom: 1rem; border-bottom: 2px solid var(--primary);
        }
        .engineer-header { font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--accent); display: flex; align-items: center; }
        .dates-header { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(120px, 1fr); gap: 1px; }
        .date-cell { background: var(--dark-lighter); padding: 0.8rem; text-align: center; border-radius: 8px; display: flex; flex-direction: column; gap: 0.2rem; }
        .date-day { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; }
        .date-number { font-family: 'Syne', sans-serif; font-size: 1.3rem; font-weight: 700; color: var(--text); }
        .date-month { font-size: 0.75rem; color: var(--text-dim); }
        .date-cell.today { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; }
        .date-cell.today .date-day, .date-cell.today .date-number, .date-cell.today .date-month { color: white; }
        .timeline-body { display: flex; flex-direction: column; gap: 0.5rem; }
        .engineer-row { display: grid; grid-template-columns: 200px 1fr; gap: 1rem; min-height: 80px; }
        .engineer-name {
            background: var(--dark-lighter); padding: 1rem; border-radius: 8px;
            font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 0.5rem;
            position: sticky; left: 0; z-index: 5;
        }
        .engineer-icon { font-size: 1.3rem; }
        .timeline-grid { display: grid; gap: 1px; position: relative; }
        .day-column { background: var(--dark); border-radius: 4px; position: relative; transition: all 0.2s ease; }
        .job-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 0.4rem 0.3rem; border-radius: 6px; font-size: 0.75rem;
            cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;
            display: flex; flex-direction: column; justify-content: center; gap: 0.25rem;
            user-select: none; overflow: hidden; position: relative; height: 100%; width: 100%;
        }
        .job-card.dragging { opacity: 0.4; cursor: grabbing; }
        .job-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow); border-color: white; z-index: 2; }
        .job-card.status-in-progress { background: linear-gradient(135deg, var(--in-progress), #00B8D9); }
        .job-card.status-complete { background: linear-gradient(135deg, var(--complete), #3DB88E); }
        .job-card.status-aborted { background: linear-gradient(135deg, var(--aborted), #E55A5A); }
        .job-card.status-cancelled { background: linear-gradient(135deg, var(--cancelled), #7A7A8F); }
        .job-card.status-short-notice-cancellation { background: linear-gradient(135deg, var(--short-notice), #90ee90); }
        .job-card .completion-overlay {
            position: absolute; top: 0; left: 0; height: 100%;
            background: linear-gradient(135deg, var(--complete), #3DB88E);
            pointer-events: none; transition: width 0.3s ease;
        }
        .job-number { font-weight: 800; color: var(--dark); font-size: 0.85rem; line-height: 1.2; pointer-events: none; position: relative; z-index: 1; text-align: center; }
        .job-type { font-size: 0.7rem; color: var(--dark); opacity: 0.95; font-weight: 600; line-height: 1.2; pointer-events: none; position: relative; z-index: 1; text-align: center; }
        .job-postcode { font-size: 0.7rem; color: var(--dark); opacity: 0.9; line-height: 1.2; font-weight: 600; pointer-events: none; position: relative; z-index: 1; text-align: center; }
        .job-days { font-size: 0.6rem; color: var(--dark); opacity: 0.95; font-weight: 700; line-height: 1; pointer-events: none; position: absolute; bottom: 0.3rem; right: 0.3rem; z-index: 1; background: rgba(255,255,255,0.3); padding: 0.15rem 0.3rem; border-radius: 3px; }
        .job-card.multi-day { grid-column: span var(--span-days); }
        .job-arrow { position: relative; height: 4px; background: linear-gradient(90deg, var(--accent), var(--primary)); pointer-events: none; z-index: 3; display: flex; align-items: center; justify-content: flex-end; box-shadow: 0 2px 12px rgba(0, 217, 255, 0.6); }
        .job-arrow::after { content: '‚Üí'; color: var(--primary); font-size: 1.5rem; font-weight: 900; margin-right: -10px; text-shadow: 0 0 10px rgba(255, 107, 53, 1); animation: arrowPulse 2s ease-in-out infinite; }
        @keyframes arrowPulse { 0%, 100% { transform: translateX(0) scale(1); opacity: 1; } 50% { transform: translateX(8px) scale(1.1); opacity: 0.8; } }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-dim); }
        .loading { text-align: center; padding: 3rem; color: var(--text-dim); font-size: 1.1rem; }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--dark-lighter);
        }
        .stat-item {
            text-align: center;
            background: var(--dark-lighter);
            border-radius: 10px;
            padding: 0.75rem 0.5rem;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }
        .stat-item:hover { border-color: var(--primary); }
        .stat-label { color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.3rem; }
        .stat-value { font-family: 'Syne', sans-serif; font-size: 1.6rem; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .stat-value.complete    { background: linear-gradient(135deg, var(--complete), #3DB88E);  -webkit-background-clip: text; background-clip: text; }
        .stat-value.in-progress { background: linear-gradient(135deg, var(--in-progress), #00B8D9); -webkit-background-clip: text; background-clip: text; }
        .stat-value.aborted     { background: linear-gradient(135deg, var(--aborted), #E55A5A);   -webkit-background-clip: text; background-clip: text; }
        .stat-value.cancelled   { background: linear-gradient(135deg, var(--cancelled), #7A7A8F); -webkit-background-clip: text; background-clip: text; }
        .stat-value.snc         { background: linear-gradient(135deg, #90ee90, #5cb85c);          -webkit-background-clip: text; background-clip: text; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--dark-light); border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; border: 2px solid var(--primary); max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--dark-lighter); }
        .modal-title { font-family: 'Syne', sans-serif; font-size: 1.5rem; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .close-btn { background: none; border: none; color: var(--text-dim); font-size: 2rem; cursor: pointer; transition: color 0.3s ease; line-height: 1; }
        .close-btn:hover { color: var(--error); }
        .modal-body { display: grid; gap: 1rem; }
        .detail-row { display: grid; grid-template-columns: 120px 1fr; gap: 1rem; padding: 0.8rem; background: var(--dark-lighter); border-radius: 8px; }
        .detail-label { color: var(--text-dim); font-size: 0.85rem; }
        .detail-value { color: var(--text); font-weight: 500; }
        .status-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1.5rem; }
        .status-btn { padding: 1rem; border: 2px solid transparent; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; color: white; }
        .status-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .status-btn.in-progress { background: linear-gradient(135deg, var(--in-progress), #00B8D9); }
        .status-btn.complete { background: linear-gradient(135deg, var(--complete), #3DB88E); }
        .status-btn.aborted { background: linear-gradient(135deg, var(--aborted), #E55A5A); }
        .status-btn.cancelled { background: linear-gradient(135deg, #FF3B3B, #C92A2A); border: 2px solid #FF6B6B; }
        .status-btn.short-notice { background: linear-gradient(135deg, var(--short-notice), #90ee90); border: 2px solid #C77DFF; }
        .completion-selector { margin-top: 1.5rem; padding: 1.5rem; background: var(--dark-lighter); border-radius: 8px; }
        .completion-title { font-size: 0.9rem; color: var(--text-dim); margin-bottom: 1rem; text-align: center; }
        .day-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.5rem; }
        .day-btn { padding: 0.8rem; background: var(--dark); border: 2px solid var(--dark-lighter); border-radius: 6px; color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; cursor: pointer; transition: all 0.3s ease; }
        .day-btn:hover { border-color: var(--primary); }
        .day-btn.selected { background: linear-gradient(135deg, var(--primary), var(--accent)); border-color: white; color: white; font-weight: 700; }
        .completion-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
        .action-btn { padding: 0.8rem; border: none; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .action-btn.cancel { background: var(--dark); color: var(--text); border: 2px solid var(--dark-lighter); }
        .action-btn.confirm { background: linear-gradient(135deg, var(--success), #3DB88E); color: white; }
        .notes-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--dark-lighter); }
        .notes-label { color: var(--text-dim); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; display: block; }
        .notes-textarea { width: 100%; background: var(--dark-lighter); border: 2px solid var(--dark-lighter); color: var(--text); padding: 0.8rem; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; min-height: 100px; resize: vertical; transition: all 0.3s ease; }
        .notes-textarea:focus { outline: none; border-color: var(--primary); }
        .save-notes-btn { margin-top: 0.5rem; padding: 0.8rem 1.5rem; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%; }
        .save-notes-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4); }
        .po-timestamp { font-size: 0.75rem; color: var(--text-dim); margin-top: 0.3rem; font-style: italic; min-height: 1.1em; letter-spacing: 0.02em; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--dark-light); color: var(--text); padding: 1rem 1.5rem; border-radius: 8px; border: 2px solid var(--success); box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 2000; animation: slideIn 0.3s ease-out; display: none; }
        .toast.show { display: block; }
        .toast.error { border-color: var(--error); }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .debug-info { background: var(--dark-lighter); border-radius: 8px; padding: 1rem; margin-top: 1rem; font-size: 0.85rem; color: var(--text-dim); }
        .invoice-section { margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(78,236,163,0.1), rgba(0,217,255,0.1)); border-radius: 8px; border: 2px solid var(--success); }
        .invoice-section.short-notice-style { background: linear-gradient(135deg, rgba(199,125,255,0.1), rgba(182,94,255,0.1)); border: 2px solid var(--short-notice); }
        .invoice-section.short-notice-style .invoice-title { color: var(--short-notice); }
        .invoice-title { color: var(--success); margin: 0 0 1rem 0; font-family: 'Syne', sans-serif; font-size: 1.2rem; }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .timeline-wrapper { min-width: 800px; }
            .engineer-row { grid-template-columns: 150px 1fr; }
            .timeline-header { grid-template-columns: 150px 1fr; }
            .status-buttons { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <a href="index.html" class="logo">Pingu - Solar</a>
                <a href="admin.html" class="back-btn">‚Üê Back to Admin</a>
            </div>
            <h1>Job Timeline</h1>
            <p class="subtitle">Visual schedule with connected segments - Click jobs to update status</p>
        </header>

        <div class="controls-card">
            <div class="controls-row">
                <div class="control-group">
                    <label class="control-label" for="start-date">Start Date</label>
                    <input type="date" id="start-date" class="control-input">
                </div>
                <div class="control-group">
                    <label class="control-label" for="days-count">Days to Show</label>
                    <input type="number" id="days-count" class="control-input" value="14" min="7" max="60">
                </div>
                <div class="control-group" style="display: flex; align-items: flex-end;">
                    <button onclick="updateTimeline()" class="control-input" style="cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; font-weight: 700; border: none;">
                        Update Timeline
                    </button>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-label">Total Jobs</div>
                    <div class="stat-value" id="total-jobs">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Engineers</div>
                    <div class="stat-value" id="total-engineers">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Days Shown</div>
                    <div class="stat-value" id="date-range">14</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">‚úÖ Complete</div>
                    <div class="stat-value complete" id="total-complete">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">üîÑ In-Progress</div>
                    <div class="stat-value in-progress" id="total-in-progress">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">‚ö†Ô∏è Aborted</div>
                    <div class="stat-value aborted" id="total-aborted">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">‚ùå Cancelled</div>
                    <div class="stat-value cancelled" id="total-cancelled">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">üîî SNC</div>
                    <div class="stat-value snc" id="total-snc">0</div>
                </div>
            </div>

            <div class="debug-info" id="debug-info" style="display: none;"></div>
            <div class="debug-info" id="email-notifications" style="display: block; background: linear-gradient(135deg, rgba(78,236,163,0.1), rgba(0,217,255,0.1)); border: 2px solid var(--success);">
                <strong>üìß Email Notifications Active</strong><br>
                <span style="font-size: 0.8rem;">Automatic emails will be sent when jobs are marked as complete.</span>
            </div>
            <div class="debug-info" id="sheets-status" style="display: block; background: linear-gradient(135deg, rgba(0,217,255,0.1), rgba(255,200,87,0.1)); border: 2px solid var(--accent); margin-top: 1rem;">
                <strong>üìä Google Sheets Integration Active</strong><br>
                <span style="font-size: 0.8rem;">Delay data syncs to <strong>Delays and Postponements</strong> sheet. You'll be asked to sign in with your Google account on first use.</span>
            </div>
        </div>

        <div class="timeline-container">
            <div id="timeline-content">
                <div class="loading">Loading timeline from Firebase...</div>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div class="modal" id="status-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="status-modal-title">Update Job Status</h2>
                <button class="close-btn" onclick="closeStatusModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="detail-row"><div class="detail-label">Job Number</div><div class="detail-value" id="status-job-number"></div></div>
                <div class="detail-row"><div class="detail-label">Address</div><div class="detail-value" id="status-address"></div></div>
                <div class="detail-row"><div class="detail-label">Postcode</div><div class="detail-value" id="status-postcode"></div></div>
                <div class="detail-row"><div class="detail-label">Job Type</div><div class="detail-value" id="status-job-type"></div></div>
                <div class="detail-row"><div class="detail-label">Booked Date</div><div class="detail-value" id="status-booked-date"></div></div>
                <div class="detail-row"><div class="detail-label">Days</div><div class="detail-value" id="status-days"></div></div>
                <div class="detail-row"><div class="detail-label">Lead Engineer</div><div class="detail-value" id="status-lead"></div></div>
                <div class="detail-row"><div class="detail-label">Team Number</div><div class="detail-value" id="status-team"></div></div>
                <div class="detail-row"><div class="detail-label">Panel Number</div><div class="detail-value" id="status-panel"></div></div>
                <div class="detail-row"><div class="detail-label">Current Status</div><div class="detail-value" id="status-current"></div></div>

                <div class="status-buttons">
                    <button class="status-btn in-progress" onclick="updateJobStatus('In-Progress')">üîÑ In-Progress</button>
                    <button class="status-btn complete" onclick="updateJobStatus('Complete')">‚úÖ Complete</button>
                    <button class="status-btn aborted" onclick="updateJobStatus('Aborted')">‚ö†Ô∏è Aborted</button>
                    <button class="status-btn cancelled" onclick="updateJobStatus('Cancelled')">‚ùå Cancelled</button>
                    <button class="status-btn short-notice" onclick="updateJobStatus('Short Notice Cancellation')" style="grid-column: 1 / -1;">üîî Short Notice Cancellation</button>
                </div>

                <div class="completion-selector" id="completion-selector" style="display: none;">
                    <div class="completion-title">Which day(s) are complete?</div>
                    <div class="day-buttons" id="day-buttons"></div>
                    <div class="completion-actions">
                        <button class="action-btn cancel" onclick="hideCompletionSelector()">Cancel</button>
                        <button class="action-btn confirm" onclick="confirmPartialCompletion()">Confirm</button>
                    </div>
                </div>

                <div class="invoice-section" id="invoice-section" style="display: none;">
                    <h3 class="invoice-title" id="invoice-title">üè† Job Completion Details</h3>
                    <div style="margin-bottom: 1.5rem;">
                        <label class="notes-label" style="display: block; margin-bottom: 1rem;">Was the roof type slate?</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <button class="day-btn" id="slate-yes-btn" onclick="selectSlateOption(true)" style="padding: 1rem; font-size: 1rem;">‚úÖ Yes</button>
                            <button class="day-btn" id="slate-no-btn" onclick="selectSlateOption(false)" style="padding: 1rem; font-size: 1rem;">‚ùå No</button>
                        </div>
                    </div>
                    <button class="save-notes-btn" id="submit-invoice-btn" onclick="submitInlineInvoice()" style="background: linear-gradient(135deg, var(--success), #3DB88E);">
                        üíæ Submit & Mark Complete
                    </button>
                </div>

                <div class="notes-section">
                    <label class="notes-label" for="po-numbers">PO Numbers</label>
                    <textarea id="po-numbers" class="notes-textarea" placeholder="Enter PO numbers..." style="min-height: 60px;"></textarea>
                    <div class="po-timestamp" id="po-timestamp"></div>
                    <button class="save-notes-btn" onclick="savePONumbers()" style="margin-bottom: 1.5rem;">üíæ Save PO Numbers</button>

                    <label class="notes-label" for="job-notes">Job Notes</label>
                    <textarea id="job-notes" class="notes-textarea" placeholder="Add notes about this job..."></textarea>
                    <button class="save-notes-btn" onclick="saveJobNotes()" style="margin-bottom: 1.5rem;">üíæ Save Notes</button>

                    <label class="notes-label" for="job-delays">Were there any delays?</label>
                    <textarea id="job-delays" class="notes-textarea" placeholder="Describe any delays experienced during this job..." style="min-height: 80px;"></textarea>
                    <button class="save-notes-btn" onclick="saveJobDelays()" style="background: linear-gradient(135deg, var(--warning), var(--secondary));">‚è∞ Save Delays & Sync to Google Sheets</button>
                </div>

                <div class="additional-costs-section" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--dark-lighter);">
                    <button class="save-notes-btn" onclick="showAdditionalCostsModal()" style="background: linear-gradient(135deg, var(--warning), var(--secondary));">
                        üí∞ Add Additional Costs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Costs Modal -->
    <div class="modal" id="additional-costs-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∞ Additional Costs</h2>
                <button class="close-btn" onclick="closeAdditionalCostsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="detail-row" style="background: linear-gradient(135deg, rgba(255,200,87,0.1), rgba(255,107,53,0.1)); border: 2px solid var(--warning);">
                    <div class="detail-label">Job Number</div>
                    <div class="detail-value" id="additional-costs-job-number"></div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <label class="notes-label" for="materials-cost">Materials (¬£)</label>
                    <input type="number" id="materials-cost" class="control-input" placeholder="0.00" step="0.01" min="0" style="margin-top: 0.5rem;">
                </div>
                <div style="margin-top: 1rem;">
                    <label class="notes-label" for="materials-notes">Materials Notes (Optional)</label>
                    <textarea id="materials-notes" class="notes-textarea" placeholder="Describe materials purchased..." style="min-height: 80px; margin-top: 0.5rem;"></textarea>
                </div>
                <div class="completion-actions" style="margin-top: 2rem;">
                    <button class="action-btn cancel" onclick="closeAdditionalCostsModal()">Cancel</button>
                    <button class="action-btn confirm" onclick="submitAdditionalCosts()">üíæ Save Costs</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAc_yJQ_rkzuOBh-Yxg0Q4eooXtB-tQjm0",
            authDomain: "pingu-solar.firebaseapp.com",
            projectId: "pingu-solar",
            storageBucket: "pingu-solar.firebasestorage.app",
            messagingSenderId: "232764952866",
            appId: "1:232764952866:web:5923b7f419de6355d6157b",
            measurementId: "G-PFH059DZ64"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.firebaseModules = { collection, getDocs, query, orderBy, doc, updateDoc };
            console.log('‚úÖ Firebase initialized');
            emailjs.init("ziLnha91scpGjFABh");
            console.log('‚úÖ EmailJS initialized');
            window.addEventListener('DOMContentLoaded', () => { window.initializeTimeline(); });
        } catch (error) {
            console.error('‚ùå Firebase error:', error);
            document.getElementById('timeline-content').innerHTML = '<div class="empty-state">Firebase connection failed</div>';
        }
    </script>

    <script>
        let allJobs = [];
        let currentJob = null;
        let timelineDates = [];
        let selectedCompletionDays = [];
        let pendingStatusChange = null;
        let slateRoof = null;

        // ‚îÄ‚îÄ GOOGLE SHEETS CONFIG (replaces SharePoint) ‚îÄ‚îÄ
        const GOOGLE_SHEETS_CONFIG = {
            clientId: '278178669501-0n0jq9cl6vk8uhfq05dbb64p4bnqsoss.apps.googleusercontent.com',
            spreadsheetId: '1JuPikuR5vFNo_BPRZKAxTcFjUNHWVldeji7qaJp3Ng0',
            sheetName: 'Delays and Postponements',
            scope: 'https://www.googleapis.com/auth/spreadsheets'
        };

        let googleAccessToken = null;
        let tokenExpiryTime = null;

        // ‚îÄ‚îÄ Get Google OAuth token via popup ‚îÄ‚îÄ
        async function getGoogleAccessToken() {
            // Return cached token if still valid (with 60s buffer)
            if (googleAccessToken && tokenExpiryTime && Date.now() < tokenExpiryTime - 60000) {
                return googleAccessToken;
            }
            return new Promise((resolve, reject) => {
                // Wait for GSI library to be ready
                if (typeof google === 'undefined' || !google.accounts) {
                    reject(new Error('Google Identity Services not loaded yet. Please try again in a moment.'));
                    return;
                }
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_SHEETS_CONFIG.clientId,
                    scope: GOOGLE_SHEETS_CONFIG.scope,
                    callback: (response) => {
                        if (response.error) {
                            console.error('Google auth error:', response);
                            reject(new Error(response.error));
                            return;
                        }
                        googleAccessToken = response.access_token;
                        // expires_in is in seconds
                        tokenExpiryTime = Date.now() + (response.expires_in * 1000);
                        console.log('‚úÖ Google access token obtained');
                        resolve(googleAccessToken);
                    }
                });
                client.requestAccessToken();
            });
        }

        // ‚îÄ‚îÄ Write a row to Google Sheets ‚îÄ‚îÄ
        async function updateGoogleSheet(jobData) {
            try {
                const accessToken = await getGoogleAccessToken();
                if (!accessToken) return false;

                const { spreadsheetId, sheetName } = GOOGLE_SHEETS_CONFIG;
                const encodedSheet = encodeURIComponent(sheetName);

                // Find next empty row by reading column A
                const readRes = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodedSheet}!A:A`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );

                if (!readRes.ok) {
                    const errText = await readRes.text();
                    throw new Error(`Read failed ${readRes.status}: ${errText}`);
                }

                const readData = await readRes.json();
                const existingRows = readData.values ? readData.values.length : 0;
                const nextRow = existingRows + 1;
                console.log(`üìä Next empty row: ${nextRow}`);

                const today = new Date().toLocaleDateString('en-GB');

                const values = [[
                    today,           // A - Today's date
                    jobData.jobNumber, // B - Job Number
                    jobData.postcode,  // C - Postcode
                    '',              // D - empty
                    '',              // E - empty
                    jobData.delays   // F - Delays
                ]];

                const writeRes = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodedSheet}!A${nextRow}:F${nextRow}?valueInputOption=USER_ENTERED`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ values })
                    }
                );

                if (!writeRes.ok) {
                    const errText = await writeRes.text();
                    throw new Error(`Write failed ${writeRes.status}: ${errText}`);
                }

                console.log(`‚úÖ Row written to Google Sheets row ${nextRow}`);
                return true;

            } catch (error) {
                console.error('‚ùå Google Sheets error:', error);
                showToast('Google Sheets sync failed: ' + error.message, 'error');
                return false;
            }
        }

        // ‚îÄ‚îÄ Save delays to Firebase + sync to Google Sheets ‚îÄ‚îÄ
        window.saveJobDelays = async function() {
            if (!currentJob) return;
            const delays = document.getElementById('job-delays').value.trim();
            if (!delays) { showToast('Please enter a delay reason before saving', 'error'); return; }
            const jobNumber = currentJob['Job Number'] || 'N/A';
            try {
                const { doc, updateDoc } = window.firebaseModules;
                const jobRef = doc(window.db, 'Solar-jobs', currentJob.id);
                await updateDoc(jobRef, { delays, delaysUpdatedAt: new Date().toISOString() });
                const job = allJobs.find(j => j.id === currentJob.id);
                if (job) job.delays = delays;
                showToast('Saving to Google Sheets...', 'success');

                const shareData = {
                    jobNumber,
                    postcode: currentJob['Postcode'] || 'N/A',
                    startDate: currentJob['Booked Date'] || formatDate(currentJob.parsedDate),
                    finishDate: currentJob['Projected Completion Date'] || '',
                    delays
                };

                const success = await updateGoogleSheet(shareData);
                if (success) showToast('‚úÖ Delays saved & synced to Google Sheets!', 'success');
                else showToast('‚ö†Ô∏è Saved to Firebase ‚Äî Google Sheets sync failed (check popup blocker)', 'error');
            } catch (error) {
                console.error('Error saving delays:', error);
                showToast('Failed to save delays: ' + error.message, 'error');
            }
        }

        window.initializeTimeline = function() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysFromMonday = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;
            const previousMonday = new Date(today);
            previousMonday.setDate(today.getDate() - daysFromMonday - 7);
            previousMonday.setHours(0, 0, 0, 0);
            document.getElementById('start-date').valueAsDate = previousMonday;
            loadJobs();
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    const parsed = new Date(year, month, day);
                    if (!isNaN(parsed.getTime())) { parsed.setHours(0,0,0,0); return parsed; }
                }
            }
            const parsed = new Date(dateStr);
            if (!isNaN(parsed.getTime())) { parsed.setHours(0,0,0,0); return parsed; }
            return null;
        }

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatTimestamp(isoString) {
            if (!isoString) return '';
            const d = new Date(isoString);
            if (isNaN(d.getTime())) return '';
            return d.toLocaleString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        async function loadJobs() {
            try {
                const { collection, getDocs, query, orderBy: orderByFn } = window.firebaseModules;
                const jobsQuery = query(collection(window.db, 'Solar-jobs'), orderByFn('uploadDate', 'desc'));
                const querySnapshot = await getDocs(jobsQuery);
                allJobs = [];
                let debugInfo = [];

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const dateFields = ['Booked Date','Projected Completion Date','Install Date','installedDate','bookingDate'];
                    let jobDate = null, usedDateField = null;

                    for (const field of dateFields) {
                        if (data[field]) {
                            jobDate = parseDate(data[field]);
                            if (jobDate) { usedDateField = field; break; }
                        }
                    }

                    if (jobDate) {
                        let jobLength = 1;
                        const durationFields = ['Days','Job Length (days)','Job Length','jobLength','Duration','duration'];
                        for (const field of durationFields) {
                            if (data[field] !== undefined && data[field] !== '') {
                                const parsed = parseInt(data[field], 10);
                                if (!isNaN(parsed) && parsed > 0) { jobLength = parsed; break; }
                            }
                        }

                        const engineerFields = ['Lead','Lead Engineer','Engineer','engineer'];
                        let engineer = 'Unassigned';
                        for (const field of engineerFields) {
                            if (data[field] && data[field].trim()) { engineer = data[field]; break; }
                        }

                        const jobType = data['Job Type'] || 'Standard';
                        const status = data['Status Update'] || data['status'] || 'Scheduled';
                        const completedDays = data['completedDays'] || [];
                        let projectedCompletionDate = null;
                        if (data['Projected Completion Date']) projectedCompletionDate = parseDate(data['Projected Completion Date']);

                        allJobs.push({
                            id: docSnap.id, ...data,
                            parsedDate: jobDate, projectedCompletionDate,
                            usedDateField, jobLength, engineer, jobType, status, completedDays
                        });
                        debugInfo.push(`Job ${data['Job Number'] || docSnap.id}: ${jobType}, Date = ${formatDate(jobDate)}, Duration = ${jobLength} days`);
                    }
                });

                console.log(`‚úÖ Loaded ${allJobs.length} jobs`);
                const debugEl = document.getElementById('debug-info');
                if (allJobs.length > 0) {
                    debugEl.innerHTML = `<strong>Loaded ${allJobs.length} jobs:</strong><br>` +
                        debugInfo.slice(0, 5).join('<br>') +
                        (debugInfo.length > 5 ? `<br>... and ${debugInfo.length - 5} more` : '');
                    debugEl.style.display = 'block';
                    setTimeout(() => { debugEl.style.display = 'none'; }, 10000);
                }
                buildTimeline();
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('timeline-content').innerHTML =
                    `<div class="empty-state">Error loading jobs: ${error.message}</div>`;
            }
        }

        async function updateJobStatusInDB(jobId, newStatus, completedDays = null) {
            try {
                const { doc, updateDoc } = window.firebaseModules;
                const jobRef = doc(window.db, 'Solar-jobs', jobId);
                const updateData = { 'Status Update': newStatus };
                if (completedDays !== null) updateData.completedDays = completedDays;
                if (newStatus === 'Complete') updateData.completedTimestamp = new Date().toISOString();
                await updateDoc(jobRef, updateData);

                const job = allJobs.find(j => j.id === jobId);
                if (job) {
                    const previousStatus = job.status;
                    job.status = newStatus;
                    job['Status Update'] = newStatus;
                    if (completedDays !== null) job.completedDays = completedDays;
                    if (newStatus === 'Complete') job.completedTimestamp = new Date().toISOString();
                    if (newStatus === 'Complete' && previousStatus !== 'Complete') await sendJobCompletionEmail(job);
                }
                showToast(`Job status updated to: ${newStatus}`, 'success');
            } catch (error) {
                console.error('Error updating job status:', error);
                showToast('Failed to update job status', 'error');
            }
        }

        async function sendJobCompletionEmail(job) {
            try {
                const jobNumber = job['Job Number'] || 'N/A';
                const postcode = job['Postcode'] || 'N/A';
                const engineer = job.engineer || 'Unassigned';
                const jobType = job.jobType || 'Standard';
                const completionDate = new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const emailHTML = `<div style="font-family:Arial,sans-serif;padding:20px;background:#f5f5f5;"><div style="background:white;padding:30px;border-radius:8px;max-width:600px;margin:0 auto;border:3px solid #4ECCA3;"><div style="text-align:center;margin-bottom:30px;"><h1 style="color:#4ECCA3;margin:0;font-size:2rem;">‚úÖ Job Completed</h1></div><div style="background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:20px;"><h2 style="color:#FF6B35;margin-top:0;margin-bottom:20px;font-size:1.3rem;">Job Details</h2><table style="width:100%;border-collapse:collapse;"><tr><td style="padding:10px 0;color:#666;font-weight:600;">Job Number:</td><td style="padding:10px 0;color:#333;font-weight:bold;">${jobNumber}</td></tr><tr><td style="padding:10px 0;color:#666;font-weight:600;">Postcode:</td><td style="padding:10px 0;color:#333;">${postcode}</td></tr><tr><td style="padding:10px 0;color:#666;font-weight:600;">Lead Engineer:</td><td style="padding:10px 0;color:#333;">${engineer}</td></tr><tr><td style="padding:10px 0;color:#666;font-weight:600;">Job Type:</td><td style="padding:10px 0;color:#333;">${jobType}</td></tr><tr><td style="padding:10px 0;color:#666;font-weight:600;">Completion Date:</td><td style="padding:10px 0;color:#333;">${completionDate}</td></tr></table></div></div></div>`;
                await emailjs.send('service_w9v5gzh', 'template_rwob6j3', {
                    to_email: 'kevin.boyd@next-gen.uk, dean.bramwell@next-gen.uk, barry.dixon@next-gen.uk, liam.bannister@next-gen.uk',
                    job_number: jobNumber, postcode, engineer, job_type: jobType,
                    completion_date: completionDate, message_html: emailHTML
                });
                showToast(`Completion email sent for job #${jobNumber}`, 'success');
            } catch (error) {
                console.error('‚ùå Email failed:', error);
                showToast('Email notification failed: ' + error.message, 'error');
            }
        }

        window.selectSlateOption = function(isSlate) {
            slateRoof = isSlate;
            document.getElementById('slate-yes-btn').classList.toggle('selected', isSlate);
            document.getElementById('slate-no-btn').classList.toggle('selected', !isSlate);
        }

        window.showInlineInvoiceSection = function(isShortNotice = false) {
            if (!currentJob) return;
            document.querySelectorAll('.status-buttons').forEach(el => el.style.display = 'none');
            document.getElementById('completion-selector').style.display = 'none';
            slateRoof = currentJob.slateRoof !== undefined ? currentJob.slateRoof : null;
            const invoiceSection = document.getElementById('invoice-section');
            const invoiceTitle = document.getElementById('invoice-title');
            const submitBtn = document.getElementById('submit-invoice-btn');
            if (isShortNotice) {
                invoiceSection.classList.add('short-notice-style');
                invoiceTitle.textContent = 'üîî Short Notice Cancellation - Details';
                submitBtn.style.background = 'linear-gradient(135deg, var(--short-notice), #B65EFF)';
                submitBtn.textContent = 'üíæ Submit & Mark as Short Notice Cancellation';
            } else {
                invoiceSection.classList.remove('short-notice-style');
                invoiceTitle.textContent = 'üè† Job Completion Details';
                submitBtn.style.background = 'linear-gradient(135deg, var(--success), #3DB88E)';
                submitBtn.textContent = 'üíæ Submit & Mark Complete';
            }
            if (slateRoof === true) { document.getElementById('slate-yes-btn').classList.add('selected'); document.getElementById('slate-no-btn').classList.remove('selected'); }
            else if (slateRoof === false) { document.getElementById('slate-no-btn').classList.add('selected'); document.getElementById('slate-yes-btn').classList.remove('selected'); }
            else { document.getElementById('slate-yes-btn').classList.remove('selected'); document.getElementById('slate-no-btn').classList.remove('selected'); }
            invoiceSection.style.display = 'block';
            setTimeout(() => { invoiceSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
        }

        window.submitInlineInvoice = async function() {
            if (!currentJob) { showToast('Error: No job selected', 'error'); return; }
            if (slateRoof === null) { showToast('Please select whether the roof type was slate', 'error'); return; }
            const jobId = currentJob.id;
            const jobNumber = currentJob['Job Number'] || 'N/A';
            const jobLength = currentJob.jobLength || 1;
            const finalStatus = pendingStatusChange || 'Complete';
            try {
                const { doc, updateDoc } = window.firebaseModules;
                const jobRef = doc(window.db, 'Solar-jobs', jobId);
                let completedDays;
                if (currentJob._pendingCompletedDays && currentJob._pendingCompletedDays.length > 0) completedDays = [...currentJob._pendingCompletedDays];
                else if (selectedCompletionDays.length > 0) completedDays = [...selectedCompletionDays];
                else if (jobLength > 1) completedDays = Array.from({length: jobLength}, (_, i) => i + 1);
                else completedDays = [1];
                await updateDoc(jobRef, { 'Status Update': finalStatus, completedTimestamp: new Date().toISOString(), completedDays, slateRoof });
                const job = allJobs.find(j => j.id === jobId);
                if (job) {
                    Object.assign(job, { status: finalStatus, 'Status Update': finalStatus, completedTimestamp: new Date().toISOString(), slateRoof, completedDays });
                    if (finalStatus === 'Complete') await sendJobCompletionEmail(job);
                }
                const roofType = slateRoof ? 'Slate' : 'Non-slate';
                showToast(`‚úÖ Job #${jobNumber} marked as ${finalStatus}! Roof: ${roofType}`, 'success');
                pendingStatusChange = null; slateRoof = null;
                closeStatusModal();
                setTimeout(() => { buildTimeline(); }, 300);
            } catch (error) {
                console.error('‚ùå Error saving:', error);
                showToast('Failed to save: ' + error.message, 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type === 'error' ? 'error' : ''}`;
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function buildTimeline() {
            const startDateInput = document.getElementById('start-date').value;
            const startDate = startDateInput ? new Date(startDateInput) : new Date();
            startDate.setHours(0, 0, 0, 0);
            const daysCount = parseInt(document.getElementById('days-count').value) || 14;
            timelineDates = [];
            for (let i = 0; i < daysCount; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                timelineDates.push(date);
            }
            const endDate = new Date(timelineDates[timelineDates.length - 1]);
            endDate.setHours(23, 59, 59, 999);

            const filteredJobs = allJobs.filter(job => {
                const jobStart = new Date(job.parsedDate); jobStart.setHours(0,0,0,0);
                const jobEnd = new Date(jobStart); jobEnd.setDate(jobEnd.getDate() + (job.jobLength - 1)); jobEnd.setHours(23,59,59,999);
                return jobStart <= endDate && jobEnd >= startDate;
            });

            const engineerJobs = {};
            filteredJobs.forEach(job => {
                const engineer = job.engineer || 'Unassigned';
                if (!engineerJobs[engineer]) engineerJobs[engineer] = [];
                engineerJobs[engineer].push(job);
            });

            let countComplete = 0, countInProgress = 0, countAborted = 0, countCancelled = 0, countSNC = 0;
            filteredJobs.forEach(job => {
                const s = job.status || 'Scheduled';
                if (s === 'Complete') countComplete++;
                else if (s === 'In-Progress') countInProgress++;
                else if (s === 'Aborted') countAborted++;
                else if (s === 'Cancelled') countCancelled++;
                else if (s === 'Short Notice Cancellation') countSNC++;
            });

            document.getElementById('total-jobs').textContent = filteredJobs.length;
            document.getElementById('total-engineers').textContent = Object.keys(engineerJobs).length;
            document.getElementById('date-range').textContent = daysCount;
            document.getElementById('total-complete').textContent = countComplete;
            document.getElementById('total-in-progress').textContent = countInProgress;
            document.getElementById('total-aborted').textContent = countAborted;
            document.getElementById('total-cancelled').textContent = countCancelled;
            document.getElementById('total-snc').textContent = countSNC;

            if (Object.keys(engineerJobs).length === 0) {
                document.getElementById('timeline-content').innerHTML = `<div class="empty-state"><div style="font-size:3rem;margin-bottom:1rem;">üìÖ</div><h3 style="font-family:'Syne',sans-serif;font-size:1.5rem;margin-bottom:0.5rem;">No Jobs Scheduled</h3><p>No jobs found in this date range</p></div>`;
                return;
            }

            const html = `<div class="timeline-wrapper"><div class="timeline-header"><div class="engineer-header">üë∑ Engineer</div><div class="dates-header">${timelineDates.map(date => { const isToday = date.toDateString() === new Date().toDateString(); return `<div class="date-cell ${isToday ? 'today' : ''}"><div class="date-day">${formatDay(date)}</div><div class="date-number">${date.getDate()}</div><div class="date-month">${formatMonth(date)}</div></div>`; }).join('')}</div></div><div class="timeline-body">${Object.keys(engineerJobs).sort().map(engineer => `<div class="engineer-row"><div class="engineer-name"><span class="engineer-icon">üë§</span><span>${escapeHtml(engineer)}</span></div><div class="timeline-grid">${renderEngineerJobs(engineerJobs[engineer], timelineDates, startDate)}</div></div>`).join('')}</div></div>`;
            document.getElementById('timeline-content').innerHTML = html;
            setTimeout(initializeJobCards, 100);
        }

        function renderEngineerJobs(jobs, dates, startDate) {
            const numCols = dates.length;
            const sortedJobs = [...jobs].sort((a, b) => a.parsedDate.getTime() - b.parsedDate.getTime());
            const gridOccupancy = [];
            const jobPlacements = [];
            const arrows = [];

            sortedJobs.forEach(job => {
                const jobStart = new Date(job.parsedDate); jobStart.setHours(0,0,0,0);
                let startCol = -1;
                for (let i = 0; i < dates.length; i++) { if (dates[i].toDateString() === jobStart.toDateString()) { startCol = i; break; } }
                if (startCol === -1) return;
                const jobLength = job.jobLength || 1;
                let segments = [];
                if (job.projectedCompletionDate && jobLength > 1) {
                    const projectedEnd = new Date(job.projectedCompletionDate); projectedEnd.setHours(0,0,0,0);
                    const daysBetween = Math.floor((projectedEnd - jobStart) / (1000*60*60*24));
                    if (daysBetween >= jobLength) {
                        const daysPerSegment = Math.ceil(jobLength / 2);
                        segments.push({ startCol, span: daysPerSegment, isFirst: true });
                        let projectedCol = -1;
                        for (let i = 0; i < dates.length; i++) { if (dates[i].toDateString() === projectedEnd.toDateString()) { projectedCol = i; break; } }
                        if (projectedCol !== -1 && projectedCol < dates.length) segments.push({ startCol: projectedCol, span: jobLength - daysPerSegment, isLast: true });
                    } else {
                        segments.push({ startCol, span: Math.min(jobLength, dates.length - startCol), isFirst: true, isLast: true });
                    }
                } else {
                    segments.push({ startCol, span: Math.min(jobLength, dates.length - startCol), isFirst: true, isLast: true });
                }

                let targetRow = null;
                let rowIndex = 0;
                let foundRow = false;
                while (!foundRow) {
                    if (!gridOccupancy[rowIndex]) gridOccupancy[rowIndex] = new Array(numCols).fill(false);
                    let allFit = true;
                    for (const segment of segments) {
                        for (let col = segment.startCol; col < segment.startCol + segment.span; col++) {
                            if (col < numCols && gridOccupancy[rowIndex][col]) { allFit = false; break; }
                        }
                        if (!allFit) break;
                    }
                    if (allFit) {
                        targetRow = rowIndex; foundRow = true;
                        for (const segment of segments) {
                            for (let col = segment.startCol; col < segment.startCol + segment.span; col++) {
                                if (col < numCols) gridOccupancy[rowIndex][col] = true;
                            }
                        }
                    } else { rowIndex++; }
                }

                segments.forEach((segment, segmentIndex) => {
                    jobPlacements.push({ job, row: targetRow, col: segment.startCol, span: segment.span, isFirst: segment.isFirst, isLast: segment.isLast, segmentIndex });
                    if (!segment.isLast && segmentIndex < segments.length - 1) {
                        const nextSegment = segments[segmentIndex + 1];
                        arrows.push({ fromCol: segment.startCol + segment.span, toCol: nextSegment.startCol, row: targetRow, jobId: job.id });
                    }
                });
            });

            const totalRows = gridOccupancy.length || 1;
            let html = `<div class="timeline-grid" style="grid-template-columns: repeat(${numCols}, minmax(120px, 1fr)); grid-template-rows: repeat(${totalRows}, 70px);">`;

            jobPlacements.forEach(placement => {
                const { job, row, col, span } = placement;
                const status = job.status || 'Scheduled';
                let statusClass = '';
                if (status === 'In-Progress') statusClass = 'status-in-progress';
                else if (status === 'Complete') statusClass = 'status-complete';
                else if (status === 'Aborted') statusClass = 'status-aborted';
                else if (status === 'Cancelled') statusClass = 'status-cancelled';
                else if (status === 'Short Notice Cancellation') statusClass = 'status-short-notice-cancellation';
                const completedDays = job.completedDays || [];
                const jobLength = job.jobLength || 1;
                const completionPercent = jobLength > 1 && completedDays.length > 0 ? (completedDays.length / jobLength) * 100 : 0;
                const textStyle = span > 1 ? 'white-space: normal; word-wrap: break-word;' : '';
                html += `<div class="job-card ${statusClass}" data-job-id="${job.id}" style="grid-column: ${col + 1} / span ${span}; grid-row: ${row + 1};">${completionPercent > 0 && completionPercent < 100 ? `<div class="completion-overlay" style="width: ${completionPercent}%;"></div>` : ''}<div class="job-number">#${escapeHtml(job['Job Number'] || 'N/A')}</div><div class="job-type" style="${textStyle}">${escapeHtml(job.jobType)}</div><div class="job-postcode">${escapeHtml(job['Postcode'] || '')}</div>${jobLength > 1 ? `<div class="job-days">${completedDays.length > 0 ? `${completedDays.length}/` : ''}${jobLength}d</div>` : ''}</div>`;
            });

            arrows.forEach(arrow => {
                html += `<div class="job-arrow" style="grid-column: ${arrow.fromCol + 1} / ${arrow.toCol + 1}; grid-row: ${arrow.row + 1}; align-self: center; margin: 0 5px; height: 4px;"></div>`;
            });

            html += '</div>';
            return html;
        }

        function initializeJobCards() {
            document.querySelectorAll('.job-card').forEach(card => {
                card.addEventListener('click', () => { showStatusModal(card.getAttribute('data-job-id')); });
            });
        }

        function showStatusModal(jobId) {
            const job = allJobs.find(j => j.id === jobId);
            if (!job) return;
            currentJob = job;
            selectedCompletionDays = [...(job.completedDays || [])];
            pendingStatusChange = null; slateRoof = null;
            document.getElementById('status-job-number').textContent = job['Job Number'] || 'N/A';
            document.getElementById('status-address').textContent = job['Address'] || 'N/A';
            document.getElementById('status-postcode').textContent = job['Postcode'] || 'N/A';
            document.getElementById('status-job-type').textContent = job.jobType || 'Standard';
            document.getElementById('status-booked-date').textContent = formatDate(job.parsedDate) || 'N/A';
            document.getElementById('status-days').textContent = job.jobLength || '1';
            document.getElementById('status-lead').textContent = job.engineer || 'Unassigned';
            document.getElementById('status-team').textContent = job['Team Number'] || job['Team'] || 'N/A';
            document.getElementById('status-panel').textContent = job['Panel No.'] || job['Panel Number'] || 'N/A';
            document.getElementById('status-current').textContent = job.status || 'Scheduled';
            document.getElementById('job-notes').value = job.notes || '';
            document.getElementById('po-numbers').value = job.poNumbers || '';
            document.getElementById('job-delays').value = job.delays || '';

            const poTimestampEl = document.getElementById('po-timestamp');
            poTimestampEl.textContent = job.poNumbersUpdatedAt
                ? `Last saved: ${formatTimestamp(job.poNumbersUpdatedAt)}`
                : '';

            document.getElementById('completion-selector').style.display = 'none';
            document.getElementById('invoice-section').style.display = 'none';
            document.querySelectorAll('.status-buttons').forEach(el => el.style.display = 'grid');
            document.getElementById('status-modal').classList.add('show');
        }

        function closeStatusModal() {
            document.getElementById('status-modal').classList.remove('show');
            document.getElementById('invoice-section').style.display = 'none';
            document.getElementById('invoice-section').classList.remove('short-notice-style');
            document.querySelectorAll('.status-buttons').forEach(el => el.style.display = 'grid');
            currentJob = null; selectedCompletionDays = []; pendingStatusChange = null; slateRoof = null;
        }

        window.updateJobStatus = async function(newStatus) {
            if (!currentJob) return;
            pendingStatusChange = newStatus;
            if (newStatus === 'Complete' && currentJob.jobLength > 1) { showCompletionSelector(); return; }
            if (newStatus === 'Complete' && currentJob.jobLength === 1) { showInlineInvoiceSection(false); return; }
            if (newStatus === 'Short Notice Cancellation') { showInlineInvoiceSection(true); return; }
            const jobId = currentJob.id;
            closeStatusModal();
            await updateJobStatusInDB(jobId, newStatus, null);
            buildTimeline();
        }

        window.showCompletionSelector = function() {
            if (!currentJob) return;
            const jobLength = currentJob.jobLength || 1;
            if (jobLength === 1) { showInlineInvoiceSection(false); return; }
            const dayButtonsHtml = Array.from({length: jobLength}, (_, i) => {
                const dayNum = i + 1;
                const isSelected = selectedCompletionDays.includes(dayNum);
                return `<button class="day-btn ${isSelected ? 'selected' : ''}" onclick="toggleCompletionDay(${dayNum})">Day ${dayNum}</button>`;
            }).join('');
            document.getElementById('day-buttons').innerHTML = dayButtonsHtml;
            document.getElementById('completion-selector').style.display = 'block';
        }

        window.hideCompletionSelector = function() { document.getElementById('completion-selector').style.display = 'none'; }

        window.toggleCompletionDay = function(dayNum) {
            const index = selectedCompletionDays.indexOf(dayNum);
            if (index > -1) selectedCompletionDays.splice(index, 1);
            else selectedCompletionDays.push(dayNum);
            selectedCompletionDays.sort((a, b) => a - b);
            document.querySelectorAll('.day-btn').forEach(btn => {
                const num = parseInt(btn.textContent.replace('Day ', ''));
                btn.classList.toggle('selected', selectedCompletionDays.includes(num));
            });
        }

        window.confirmPartialCompletion = async function() {
            if (!currentJob) return;
            const jobLength = currentJob.jobLength || 1;
            const jobNumber = currentJob['Job Number'] || 'N/A';
            if (selectedCompletionDays.length === 0) { showToast('Please select at least one day to complete', 'error'); return; }
            currentJob._pendingCompletedDays = [...selectedCompletionDays];
            if (selectedCompletionDays.length === jobLength) { document.getElementById('completion-selector').style.display = 'none'; showInlineInvoiceSection(false); return; }
            const jobId = currentJob.id;
            try {
                const { doc, updateDoc } = window.firebaseModules;
                await updateDoc(doc(window.db, 'Solar-jobs', jobId), { 'Status Update': 'In-Progress', completedDays: selectedCompletionDays });
                const job = allJobs.find(j => j.id === jobId);
                if (job) { job.status = 'In-Progress'; job['Status Update'] = 'In-Progress'; job.completedDays = selectedCompletionDays; }
                showToast(`‚úì Job #${jobNumber}: Day${selectedCompletionDays.length > 1 ? 's' : ''} ${selectedCompletionDays.join(', ')} completed (${selectedCompletionDays.length}/${jobLength})`, 'success');
                closeStatusModal();
                buildTimeline();
            } catch (error) {
                console.error('Error:', error);
                showToast('Failed to update job completion', 'error');
            }
        }

        window.savePONumbers = async function() {
            if (!currentJob) return;
            const poNumbers = document.getElementById('po-numbers').value;
            const now = new Date().toISOString();
            try {
                const { doc, updateDoc } = window.firebaseModules;
                await updateDoc(doc(window.db, 'Solar-jobs', currentJob.id), {
                    poNumbers,
                    poNumbersUpdatedAt: now
                });
                const job = allJobs.find(j => j.id === currentJob.id);
                if (job) { job.poNumbers = poNumbers; job.poNumbersUpdatedAt = now; }
                if (currentJob) { currentJob.poNumbers = poNumbers; currentJob.poNumbersUpdatedAt = now; }
                document.getElementById('po-timestamp').textContent = `Last saved: ${formatTimestamp(now)}`;
                showToast('PO Numbers saved successfully', 'success');
            } catch (error) { showToast('Failed to save PO numbers', 'error'); }
        }

        window.saveJobNotes = async function() {
            if (!currentJob) return;
            try {
                const { doc, updateDoc } = window.firebaseModules;
                await updateDoc(doc(window.db, 'Solar-jobs', currentJob.id), { notes: document.getElementById('job-notes').value });
                const job = allJobs.find(j => j.id === currentJob.id);
                if (job) job.notes = document.getElementById('job-notes').value;
                showToast('Notes saved successfully', 'success');
            } catch (error) { showToast('Failed to save notes', 'error'); }
        }

        window.showAdditionalCostsModal = function() {
            if (!currentJob) return;
            document.getElementById('additional-costs-job-number').textContent = currentJob['Job Number'] || 'N/A';
            document.getElementById('materials-cost').value = currentJob.materialsCost || '';
            document.getElementById('materials-notes').value = currentJob.materialsNotes || '';
            document.getElementById('additional-costs-modal').classList.add('show');
        }

        window.closeAdditionalCostsModal = function() {
            document.getElementById('additional-costs-modal').classList.remove('show');
        }

        window.submitAdditionalCosts = async function() {
            if (!currentJob) { showToast('Error: No job selected', 'error'); return; }
            const materialsCost = parseFloat(document.getElementById('materials-cost').value) || 0;
            const materialsNotes = document.getElementById('materials-notes').value.trim();
            try {
                const { doc, updateDoc } = window.firebaseModules;
                await updateDoc(doc(window.db, 'Solar-jobs', currentJob.id), { materialsCost, materialsNotes, additionalCostsUpdatedAt: new Date().toISOString() });
                const job = allJobs.find(j => j.id === currentJob.id);
                if (job) { job.materialsCost = materialsCost; job.materialsNotes = materialsNotes; }
                showToast(`Additional costs saved: ¬£${materialsCost.toFixed(2)} (Materials)`, 'success');
                closeAdditionalCostsModal();
            } catch (error) { showToast('Failed to save additional costs', 'error'); }
        }

        function updateTimeline() { buildTimeline(); }
        function formatDay(date) { return date.toLocaleDateString('en-GB', { weekday: 'short' }).toUpperCase(); }
        function formatMonth(date) { return date.toLocaleDateString('en-GB', { month: 'short' }); }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        document.getElementById('status-modal').addEventListener('click', e => { if (e.target.id === 'status-modal') closeStatusModal(); });
        document.getElementById('additional-costs-modal').addEventListener('click', e => { if (e.target.id === 'additional-costs-modal') closeAdditionalCostsModal(); });

        window.updateTimeline = updateTimeline;
        window.closeStatusModal = closeStatusModal;
    </script>
</body>
</html>
