<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin - Mass Upload Jobs (CSV) | Pingu Solar</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #FFC857;
            --accent: #00D9FF;
            --dark: #1A1A2E;
            --dark-light: #252541;
            --dark-lighter: #2F2F4A;
            --text: #EAEAEA;
            --text-dim: #9A9AB0;
            --success: #4ECCA3;
            --error: #FF6B6B;
            --shadow: rgba(255, 107, 53, 0.3);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--dark);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        .logo {
            font-family: 'Syne', sans-serif;
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.4rem;
            display: inline-block;
            text-decoration: none;
        }
        h1 {
            font-family: 'Syne', sans-serif;
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            color: var(--text-dim);
            font-size: 1rem;
        }
        .back-home {
            display: inline-block;
            margin-top: 1rem;
            background: var(--dark-light);
            color: var(--text);
            padding: 0.7rem 1.4rem;
            border-radius: 8px;
            text-decoration: none;
            border: 2px solid var(--primary);
            transition: all 0.3s;
            font-weight: 600;
        }
        .back-home:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        .upload-card {
            background: var(--dark-light);
            border-radius: 16px;
            padding: 2.5rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
        .upload-card:hover {
            border-color: var(--primary);
        }
        .drop-zone {
            border: 3px dashed var(--text-dim);
            border-radius: 12px;
            padding: 3.5rem 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 2rem 0;
        }
        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(255,107,53,0.08);
        }
        .drop-zone h2 {
            margin-bottom: 0.8rem;
            color: var(--text);
        }
        .drop-zone p {
            color: var(--text-dim);
        }
        .file-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--dark-lighter);
            border-radius: 8px;
            display: none;
            font-size: 0.95rem;
        }
        .mapping-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--dark-lighter);
            border-radius: 12px;
            border: 1px solid var(--dark);
        }
        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.2rem;
        }
        .mapping-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .mapping-label {
            font-weight: 600;
            color: var(--accent);
        }
        .mapping-select {
            background: var(--dark);
            color: var(--text);
            border: 2px solid var(--dark-lighter);
            padding: 0.7rem;
            border-radius: 6px;
            font-family: inherit;
        }
        .mapping-select:focus {
            border-color: var(--primary);
            outline: none;
        }
        .required::after {
            content: " *";
            color: var(--error);
        }
        .preview-area {
            margin-top: 2.5rem;
        }
        .preview-table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid var(--dark-lighter);
            margin: 1.5rem 0;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .preview-table th,
        .preview-table td {
            padding: 0.9rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--dark);
        }
        .preview-table th {
            background: rgba(0,217,255,0.08);
            color: var(--accent);
            position: sticky;
            top: 0;
            z-index: 1;
            font-weight: 600;
        }
        .preview-table th small {
            display: block;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.3rem;
        }
        .status {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            margin: 1.5rem 0;
            text-align: center;
            font-size: 1.05rem;
        }
        .success { background: var(--success); color: var(--dark); }
        .error { background: var(--error); color: white; }
        .buttons {
            text-align: center;
            margin: 2rem 0;
        }
        .btn {
            padding: 0.9rem 2.2rem;
            border: none;
            border-radius: 8px;
            font-family: 'Syne', sans-serif;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 0.6rem;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow);
        }
        .btn-secondary {
            background: var(--dark-lighter);
            color: var(--text);
            border: 2px solid var(--text-dim);
        }
        .btn-secondary:hover {
            border-color: var(--primary);
        }
        .hidden { display: none !important; }
        .expected-cols {
            text-align: center;
            margin-top: 2.5rem;
            color: var(--text-dim);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        @media (max-width: 700px) {
            body { padding: 1.2rem; }
            .upload-card { padding: 1.8rem; }
            .drop-zone { padding: 2.5rem 1rem; }
            .mapping-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <a href="admin.html" class="logo">Pingu Solar</a>
        <h1>Mass Job Upload (CSV)</h1>
        <p class="subtitle">Upload multiple jobs at once from a CSV file</p>
        <a href="admin.html" class="back-home">← Back to Admin Dashboard</a>
    </header>

    <div class="upload-card">
        <div class="drop-zone" id="dropZone">
            <h2>Drop your CSV file here</h2>
            <p>or click to select file from your computer</p>
            <input type="file" id="fileInput" accept=".csv" hidden>
        </div>

        <div id="fileInfo" class="file-info">
            <strong>Selected file:</strong> <span id="fileName">—</span><br>
            <strong>Size:</strong> <span id="fileSize">—</span>
        </div>

        <!-- Column Mapping Section -->
        <div id="mappingSection" class="mapping-section hidden">
            <h3 style="margin-bottom: 1.2rem; color: var(--accent);">Map CSV Columns to Database Fields</h3>
            <p style="color: var(--text-dim); margin-bottom: 1.5rem;">Match each required field to the correct column in your CSV. All required fields must be assigned before preview/upload.</p>
            <div id="mappingGrid" class="mapping-grid"></div>
            <div style="margin-top: 1.5rem; text-align: center;">
                <button id="confirmMappingBtn" class="btn btn-primary" disabled>Confirm Mapping & Continue to Preview</button>
            </div>
        </div>

        <div class="buttons">
            <button class="btn btn-primary" id="previewBtn" disabled>Preview Mapped Data</button>
            <button class="btn btn-secondary" id="clearBtn">Clear / Reset</button>
        </div>

        <div id="previewArea" class="preview-area hidden">
            <h3 style="margin-bottom: 1rem; text-align: center;">Preview of Mapped Data (first 10 rows)</h3>
            <div class="preview-table-wrapper">
                <table class="preview-table" id="previewTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="buttons">
                <button class="btn btn-primary" id="uploadBtn" disabled>Upload All to Database</button>
            </div>
        </div>

        <div id="status" class="status hidden"></div>
    </div>

    <div class="expected-cols">
        <strong>Required fields (must be mapped):</strong><br>
        Job Type, Job Number, Address, Postcode, Booked Date, Projected Completion Date, Days, Panel No., Status Update, PO, Lead, Team Number
    </div>

    <div style="text-align: center; margin-top: 3rem;">
        <a href="index.html" class="back-home" style="font-size: 1.1rem; padding: 1rem 2rem;">← Return to Main Site</a>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAc_yJQ_rkzuOBh-Yxg0Q4eooXtB-tQjm0",
        authDomain: "pingu-solar.firebaseapp.com",
        projectId: "pingu-solar",
        storageBucket: "pingu-solar.firebasestorage.app",
        messagingSenderId: "232764952866",
        appId: "1:232764952866:web:5923b7f419de6355d6157b",
        measurementId: "G-PFH059DZ64"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Required fields (must be mapped)
    const requiredFields = [
        "Job Type",
        "Job Number",
        "Address",
        "Postcode",
        "Booked Date",
        "Projected Completion Date",
        "Days",
        "Panel No.",
        "Status Update",
        "Lead",
        "Team Number"
    ];

    let csvData = [];           // raw rows with original column names
    let csvHeaders = [];        // original CSV column names
    let columnMapping = {};     // dbField → csvHeader (after user confirms)

    const dropZone          = document.getElementById('dropZone');
    const fileInput         = document.getElementById('fileInput');
    const previewBtn        = document.getElementById('previewBtn');
    const uploadBtn         = document.getElementById('uploadBtn');
    const clearBtn          = document.getElementById('clearBtn');
    const statusEl          = document.getElementById('status');
    const mappingSection    = document.getElementById('mappingSection');
    const mappingGrid       = document.getElementById('mappingGrid');
    const confirmMappingBtn = document.getElementById('confirmMappingBtn');

    // Drag & drop / click to select
    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) handleFile(file);
    });

    ['dragover', 'dragenter'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
    });

    dropZone.addEventListener('drop', e => {
        const file = e.dataTransfer.files[0];
        if (file && file.type === 'text/csv') handleFile(file);
        else showStatus('Please drop a valid .csv file', 'error');
    });

    function handleFile(file) {
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
        document.getElementById('fileInfo').style.display = 'block';

        const reader = new FileReader();
        reader.onload = e => parseCSV(e.target.result);
        reader.readAsText(file);
    }

    // Parse CSV → detect headers → show mapping UI
    function parseCSV(csvText) {
        csvData = [];
        const lines = csvText.trim().split('\n');

        if (lines.length < 1) {
            showStatus('File appears empty', 'error');
            return;
        }

        csvHeaders = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
            const row = {};
            csvHeaders.forEach((h, idx) => { row[h] = values[idx] || ''; });
            csvData.push(row);
        }

        if (csvData.length === 0) {
            showStatus('No valid rows found', 'error');
            return;
        }

        showStatus(`Detected ${csvData.length} rows • ${csvHeaders.length} columns`, 'success');
        showMappingInterface();
    }

    // Build mapping UI
    function showMappingInterface() {
        mappingGrid.innerHTML = '';
        mappingSection.classList.remove('hidden');
        previewBtn.disabled = true;
        uploadBtn.disabled = true;

        requiredFields.forEach(dbField => {
            const div = document.createElement('div');
            div.className = 'mapping-item';
            div.innerHTML = `
                <label class="mapping-label required">${dbField}</label>
                <select class="mapping-select" data-field="${dbField}">
                    <option value="">-- Select CSV column --</option>
                    ${csvHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}
                </select>
            `;
            mappingGrid.appendChild(div);
        });

        // Auto-suggest matches
        document.querySelectorAll('.mapping-select').forEach(sel => {
            const field = sel.dataset.field.toLowerCase().replace(/\s+/g, '');
            const match = csvHeaders.find(h => {
                const hLower = h.toLowerCase().replace(/\s+/g, '');
                return hLower.includes(field) || field.includes(hLower);
            });
            if (match) sel.value = match;
        });

        // Enable confirm button only when all required are mapped
        const check = () => {
            const unmapped = requiredFields.some(f => {
                const s = document.querySelector(`select[data-field="${f}"]`);
                return !s || !s.value;
            });
            confirmMappingBtn.disabled = unmapped;
        };

        document.querySelectorAll('.mapping-select').forEach(s => s.addEventListener('change', check));
        check();
    }

    // Confirm mapping → hide mapping → enable preview
    confirmMappingBtn.addEventListener('click', () => {
        columnMapping = {};
        document.querySelectorAll('.mapping-select').forEach(s => {
            if (s.value) columnMapping[s.dataset.field] = s.value;
        });

        mappingSection.classList.add('hidden');
        showStatus('Mapping confirmed — preview now shows mapped values', 'success');
        previewBtn.disabled = false;
    });

    // Preview: show ONLY mapped fields with correct values
    previewBtn.addEventListener('click', () => {
        if (Object.keys(columnMapping).length < requiredFields.length) {
            showStatus('Please map all required fields first', 'error');
            return;
        }

        const thead = document.querySelector('#previewTable thead');
        const tbody = document.querySelector('#previewTable tbody');

        thead.innerHTML = '';
        tbody.innerHTML = '';

        // Header row
        const headerRow = document.createElement('tr');
        requiredFields.forEach(field => {
            const csvCol = columnMapping[field] || '(not mapped)';
            const th = document.createElement('th');
            th.innerHTML = `${field}<br><small>← ${csvCol}</small>`;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Data rows (first 10)
        csvData.slice(0, 10).forEach(row => {
            const tr = document.createElement('tr');
            requiredFields.forEach(field => {
                const csvCol = columnMapping[field];
                const value = csvCol && row[csvCol] !== undefined ? row[csvCol] : '';
                const td = document.createElement('td');
                td.textContent = value;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        document.getElementById('previewArea').classList.remove('hidden');
        uploadBtn.disabled = false;
    });

    // Upload: send only mapped fields with correct values
    uploadBtn.addEventListener('click', async () => {
        if (Object.keys(columnMapping).length < requiredFields.length) {
            showStatus('Mapping incomplete — cannot upload', 'error');
            return;
        }

        statusEl.textContent = `Uploading ${csvData.length} jobs...`;
        statusEl.className = 'status';
        statusEl.classList.remove('hidden', 'success', 'error');

        let success = 0;
        let failed = 0;

        for (const row of csvData) {
            try {
                const docData = {
                    "uploadDate": new Date().toISOString(),
                    "status": (row[columnMapping["Status Update"]] || "pending").toLowerCase()
                };

                requiredFields.forEach(field => {
                    const csvCol = columnMapping[field];
                    if (csvCol && row[csvCol] !== undefined && row[csvCol] !== '') {
                        docData[field] = row[csvCol];
                    }
                });

                await addDoc(collection(db, "Solar-jobs"), docData);
                success++;
            } catch (err) {
                console.error(err);
                failed++;
            }
        }

        if (failed === 0) {
            statusEl.textContent = `Successfully uploaded ${success} jobs!`;
            statusEl.className = 'status success';
        } else {
            statusEl.textContent = `Uploaded ${success} • ${failed} failed`;
            statusEl.className = 'status error';
        }
    });

    // Reset
    clearBtn.addEventListener('click', () => {
        fileInput.value = '';
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('previewArea').classList.add('hidden');
        document.getElementById('mappingSection').classList.add('hidden');
        previewBtn.disabled = true;
        uploadBtn.disabled = true;
        statusEl.classList.add('hidden');
        csvData = [];
        csvHeaders = [];
        columnMapping = {};
        document.querySelector('#previewTable thead').innerHTML = '';
        document.querySelector('#previewTable tbody').innerHTML = '';
        mappingGrid.innerHTML = '';
    });

    function showStatus(message, type = 'success') {
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
        statusEl.classList.remove('hidden');
    }
</script>

</body>
</html>
