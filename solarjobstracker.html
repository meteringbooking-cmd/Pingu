<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Jobs Tracker + Stats</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 20px; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* Stats Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: #fff; border: 1px solid #e1e4e8; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-card h4 { margin: 0; color: #65676b; font-size: 0.85rem; text-transform: uppercase; }
        .stat-card div { font-size: 1.5rem; font-weight: bold; color: #1c1e21; margin-top: 5px; }
        .highlight-blue { border-top: 4px solid #007bff; }
        .highlight-green { border-top: 4px solid #28a745; }
        .highlight-orange { border-top: 4px solid #fd7e14; }

        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; align-items: center; }
        select, input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        input[type="text"] { flex-grow: 1; min-width: 200px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #4b4b4b; position: sticky; top: 0; }
        tr:hover { background-color: #fcfcfc; cursor: pointer; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; border-radius: 12px; width: 70%; max-height: 80vh; overflow-y: auto; }
        .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .label { font-weight: bold; color: #727272; margin-bottom: 3px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <h2>Solar Jobs Tracker</h2>

    <div id="statsDashboard" class="stats-grid">
        <div class="stat-card highlight-blue"><h4>Total</h4><div id="stat-total">0</div></div>
        <div class="stat-card"><h4>Solar Install</h4><div id="stat-solar">0</div></div>
        <div class="stat-card"><h4>Survey</h4><div id="stat-survey">0</div></div>
        <div class="stat-card"><h4>Battery</h4><div id="stat-battery">0</div></div>
        <div class="stat-card"><h4>Enphase</h4><div id="stat-enphase">0</div></div>
        <div class="stat-card"><h4>Tesla</h4><div id="stat-tesla">0</div></div>
        <div class="stat-card"><h4>Fox/Evo</h4><div id="stat-fox">0</div></div>
        <div class="stat-card highlight-green"><h4>KF Completed</h4><div id="stat-kf">0</div></div>
    </div>
    
    <div class="controls">
        <input type="file" id="csvFile" accept=".csv">
        <select id="typeFilter" onchange="runFilters()">
            <option value="">All Job Types</option>
            <option value="solar">Solar Install</option>
            <option value="survey">Survey</option>
            <option value="revisit">Revisit</option>
            <option value="aftercare">AfterCare</option>
            <option value="battery">Battery</option>
        </select>
        <select id="installFilter" onchange="runFilters()">
            <option value="">All Install Types</option>
            <option value="booked">Booked</option>
            <option value="completed">Completed</option>
        </select>
        <input type="text" id="searchInput" placeholder="Search anything (Postcode, Job #, Lead...)" onkeyup="runFilters()">
    </div>

    <table id="jobsTable">
        <thead>
            <tr>
                <th>Job Number</th>
                <th>Job Type</th>
                <th>Install Type</th>
                <th>Complete on KF</th>
                <th>Compliance</th>
                <th>Issues</th>
                <th>Resolved</th>
                <th>Lead</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:24px;" onclick="closeModal()">&times;</span>
        <h3>Job Detail View</h3>
        <hr><br>
        <div id="modalData" class="detail-grid"></div>
    </div>
</div>

<script>
    let allData = [];

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                processData(results.data);
            }
        });
    });

    function processData(data) {
        const postcodeMap = new Map();
        data.forEach(row => {
            const pc = (row['Postcode'] || '').trim().toUpperCase();
            const jobType = (row['Job Type'] || '').toLowerCase();
            if (!postcodeMap.has(pc)) {
                postcodeMap.set(pc, row);
            } else {
                const existing = postcodeMap.get(pc);
                if (existing['Job Type'].toLowerCase().includes('survey') && !jobType.includes('survey')) {
                    postcodeMap.set(pc, row);
                }
            }
        });
        allData = Array.from(postcodeMap.values());
        runFilters();
    }

    function runFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;
        const installFilter = document.getElementById('installFilter').value.toLowerCase();

        const filtered = allData.filter(row => {
            const matchesSearch = Object.values(row).some(v => String(v).toLowerCase().includes(searchTerm));
            const matchesType = typeFilter === "" || String(row['Job Type']).toLowerCase().includes(typeFilter);
            const matchesInstall = installFilter === "" || String(row['Booked Status']).toLowerCase().includes(installFilter);
            return matchesSearch && matchesType && matchesInstall;
        });

        updateStats(filtered);
        renderTable(filtered);
    }

    function updateStats(data) {
        const count = (arr, key, term) => arr.filter(r => String(r[key]).toLowerCase().includes(term.toLowerCase())).length;
        
        document.getElementById('stat-total').innerText = data.length;
        document.getElementById('stat-solar').innerText = count(data, 'Job Type', 'solar');
        document.getElementById('stat-survey').innerText = count(data, 'Job Type', 'survey');
        document.getElementById('stat-battery').innerText = count(data, 'Job Type', 'battery');
        document.getElementById('stat-enphase').innerText = count(data, 'Enphase', 'y'); // Assumes Y/N in Enphase col
        document.getElementById('stat-tesla').innerText = count(data, 'Job Type', 'tesla') + count(data, 'Booked Status', 'tesla');
        document.getElementById('stat-fox').innerText = data.filter(r => {
            const val = (r['Job Type'] + r['Booked Status']).toLowerCase();
            return val.includes('fox') || val.includes('evo');
        }).length;
        document.getElementById('stat-kf').innerText = data.filter(r => {
            const val = String(r['Complete on KF']).trim().toUpperCase();
            return val === 'Y' || val === 'YES';
        }).length;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.onclick = () => showDetails(row);
            tr.innerHTML = `
                <td>${row['Job Number'] || ''}</td>
                <td>${row['Job Type'] || ''}</td>
                <td>${row['Booked Status'] || ''}</td>
                <td>${row['Complete on KF'] || ''}</td>
                <td>${row['Compliance Checked'] || ''}</td>
                <td>${row['Issues Sent'] || ''}</td>
                <td>${row['Issues Resolved'] || ''}</td>
                <td>${row['Lead'] || ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function showDetails(row) {
        const display = document.getElementById('modalData');
        display.innerHTML = '';
        for (const [key, value] of Object.entries(row)) {
            display.innerHTML += `<div class="detail-item"><div class="label">${key}</div><div>${value || '-'}</div></div>`;
        }
        document.getElementById('detailsModal').style.display = "block";
    }

    function closeModal() { document.getElementById('detailsModal').style.display = "none"; }
</script>
</body>
</html>
