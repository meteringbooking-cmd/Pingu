<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar OS | Stealth Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-p: #f8fafc;
            --text-s: #94a3b8;
            --enphase: #3b82f6;
            --tesla: #ef4444;
            --fox: #f59e0b;
            --success: #10b981;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 30px; 
            color: var(--text-p);
            letter-spacing: -0.01em;
        }

        .container { max-width: 1600px; margin: auto; }

        /* Header & Upload */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        h2 { font-size: 1.8rem; font-weight: 700; background: linear-gradient(to right, #fff, #64748b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .file-upload {
            background: var(--surface);
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid #334155;
            cursor: pointer;
            transition: 0.3s;
        }
        .file-upload:hover { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

        /* Stats: The Sexy Part */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 20px; 
            margin-bottom: 40px; 
        }

        .stat-card { 
            background: linear-gradient(145deg, #1e293b, #0f172a);
            padding: 24px; 
            border-radius: 20px; 
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 70%);
        }

        .stat-card h4 { margin: 0; color: var(--text-s); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1rem; }
        .stat-card .value { font-size: 2rem; font-weight: 800; margin-top: 10px; }
        
        .border-enphase { border-bottom: 3px solid var(--enphase); }
        .border-tesla { border-bottom: 3px solid var(--tesla); }
        .border-fox { border-bottom: 3px solid var(--fox); }
        .border-kf { border-bottom: 3px solid var(--success); }

        /* Controls */
        .controls { 
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(12px);
            padding: 24px; 
            border-radius: 20px; 
            border: 1px solid #334155;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group label { display: block; margin-bottom: 8px; font-size: 0.75rem; font-weight: 600; color: var(--text-s); }
        
        input, select { 
            width: 100%;
            background: #0f172a;
            padding: 12px; 
            border: 1px solid #334155; 
            border-radius: 12px; 
            color: #fff;
            outline: none;
            box-sizing: border-box;
        }

        input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        /* Table Area */
        .table-container { 
            background: var(--surface); 
            border-radius: 20px; 
            border: 1px solid #334155;
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(15, 23, 42, 0.5); text-align: left; padding: 18px; font-size: 0.8rem; color: var(--text-s); text-transform: uppercase; }
        td { padding: 18px; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        tr:hover td { background: rgba(99, 102, 241, 0.05); cursor: pointer; color: #fff; }

        /* Status Pills */
        .pill { padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; }
        .pill-kf { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .pill-pending { background: rgba(148, 163, 184, 0.1); color: var(--text-s); border: 1px solid rgba(148, 163, 184, 0.2); }

        /* Sexy Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        .modal-content { 
            background: var(--surface); 
            margin: 40px auto; 
            padding: 40px; 
            border-radius: 30px; 
            width: 75%; 
            max-height: 85vh; 
            overflow-y: auto; 
            border: 1px solid #475569;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 30px; }
        .detail-label { font-size: 0.65rem; color: var(--text-s); text-transform: uppercase; font-weight: 800; margin-bottom: 4px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>SOLAR<span style="color:var(--accent); font-weight:300;">OS</span></h2>
        <input type="file" id="csvFile" accept=".csv" class="file-upload">
    </header>

    <div id="statsDashboard" class="stats-grid">
        <div class="stat-card"><h4>Total Fleet</h4><div id="stat-total" class="value">0</div></div>
        <div class="stat-card"><h4>Installations</h4><div id="stat-solar" class="value">0</div></div>
        <div class="stat-card border-enphase"><h4>Enphase</h4><div id="stat-enphase" class="value" style="color:var(--enphase);">0</div></div>
        <div class="stat-card border-tesla"><h4>Tesla</h4><div id="stat-tesla" class="value" style="color:var(--tesla);">0</div></div>
        <div class="stat-card border-fox"><h4>Fox/Evo</h4><div id="stat-fox" class="value" style="color:var(--fox);">0</div></div>
        <div class="stat-card border-kf"><h4>KF Sync</h4><div id="stat-kf" class="value" style="color:var(--success);">0</div></div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label>System Phase</label>
            <select id="typeFilter" onchange="runFilters()">
                <option value="">All Systems</option>
                <option value="solar">Solar Install</option>
                <option value="survey">Survey</option>
                <option value="revisit">Revisit</option>
                <option value="aftercare">Aftercare</option>
            </select>
        </div>
        <div class="control-group">
            <label>Hardware/Status</label>
            <select id="techFilter" onchange="runFilters()">
                <option value="">Full Range</option>
                <option value="enphase">Enphase</option>
                <option value="tesla">Tesla Powerwall</option>
                <option value="fox">Fox ESS / Evo</option>
                <option value="revisit">Revisit (Status)</option>
                <option value="n/a">N/A</option>
            </select>
        </div>
        <div class="control-group"><label>Window Start</label><input type="date" id="startDate" onchange="runFilters()"></div>
        <div class="control-group"><label>Window End</label><input type="date" id="endDate" onchange="runFilters()"></div>
        <div class="control-group"><label>Command Search</label><input type="text" id="searchInput" placeholder="Search parameters..." onkeyup="runFilters()"></div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Job ID</th>
                    <th>System Type</th>
                    <th>Completion Date</th>
                    <th>Status</th>
                    <th>Sync</th>
                    <th>Lead</th>
                    <th>Health</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:1.5rem;" onclick="closeModal()">✕</span>
        <h2 id="modalTitle" style="margin-bottom:40px; color:#fff; -webkit-text-fill-color: initial;">Data Node Insight</h2>
        <div id="modalData" class="detail-grid"></div>
    </div>
</div>

<script>
    let allData = [];

    const parseDate = (d) => {
        if (!d) return null;
        const pts = d.includes('/') ? d.split('/') : d.split('-');
        if (pts.length !== 3) return null;
        return pts[0].length === 4 ? new Date(pts[0], pts[1]-1, pts[2]) : new Date(pts[2], pts[1]-1, pts[0]);
    };

    const techMatch = (row, f) => {
        const comb = `${row['Job Type']} ${row['Booked Status']} ${row['Enphase']}`.toLowerCase();
        if (f === 'fox') return comb.includes('fox') || comb.includes('evo');
        if (f === 'revisit') return comb.includes('revisit') || comb.includes('rv');
        return comb.includes(f);
    };

    document.getElementById('csvFile').addEventListener('change', (e) => {
        Papa.parse(e.target.files[0], {
            header: true, skipEmptyLines: true,
            complete: (r) => {
                const map = new Map();
                r.data.forEach(row => {
                    const pc = (row['Postcode'] || '').trim().toUpperCase();
                    if(!pc) return;
                    const isSrv = (row['Job Type'] || '').toLowerCase().includes('survey');
                    if(!map.has(pc) || (map.get(pc)['Job Type'].toLowerCase().includes('survey') && !isSrv)) map.set(pc, row);
                });
                allData = Array.from(map.values());
                runFilters();
            }
        });
    });

    function runFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const tF = document.getElementById('typeFilter').value;
        const hF = document.getElementById('techFilter').value;
        const sD = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
        const eD = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;

        const filtered = allData.filter(row => {
            const mS = Object.values(row).some(v => String(v).toLowerCase().includes(q));
            const mT = !tF || String(row['Job Type']).toLowerCase().includes(tF);
            const mH = !hF || techMatch(row, hF);
            const rD = parseDate(row['Projected Completion Date']);
            let mD = true;
            if (sD && (!rD || rD < sD)) mD = false;
            if (eD && (!rD || rD > eD)) mD = false;
            return mS && mT && mH && mD;
        });
        updateStats(filtered);
        render(filtered);
    }

    function updateStats(data) {
        document.getElementById('stat-total').innerText = data.length;
        document.getElementById('stat-solar').innerText = data.filter(r => String(r['Job Type']).toLowerCase().includes('solar')).length;
        document.getElementById('stat-enphase').innerText = data.filter(r => techMatch(r, 'enphase')).length;
        document.getElementById('stat-tesla').innerText = data.filter(r => techMatch(r, 'tesla')).length;
        document.getElementById('stat-fox').innerText = data.filter(r => techMatch(r, 'fox')).length;
        document.getElementById('stat-kf').innerText = data.filter(r => ['Y','YES'].includes(String(r['Complete on KF']).trim().toUpperCase())).length;
    }

    function render(data) {
        const tb = document.getElementById('tableBody');
        tb.innerHTML = '';
        data.forEach(r => {
            const kf = ['Y','YES'].includes(String(r['Complete on KF']).trim().toUpperCase());
            const tr = document.createElement('tr');
            tr.onclick = () => showDetails(r);
            tr.innerHTML = `
                <td style="color:var(--accent); font-weight:700;">${r['Job Number']}</td>
                <td>${r['Job Type']}</td>
                <td>${r['Projected Completion Date'] || '---'}</td>
                <td><span class="pill" style="background:rgba(99,102,241,0.1); color:var(--accent); border:1px solid rgba(99,102,241,0.2)">${r['Booked Status']}</span></td>
                <td><span class="pill ${kf?'pill-kf':'pill-pending'}">${kf?'SYNCED':'IDLE'}</span></td>
                <td>${r['Lead'] || 'N/A'}</td>
                <td>${r['Issues Sent'] ? '<span style="color:var(--tesla)">● </span>Error' : '<span style="color:var(--success)">● </span>Nominal'}</td>
            `;
            tb.appendChild(tr);
        });
    }

    function showDetails(row) {
        const d = document.getElementById('modalData');
        d.innerHTML = '';
        Object.entries(row).forEach(([k, v]) => {
            d.innerHTML += `<div><div class="detail-label">${k}</div><div style="color:#fff;">${v || '---'}</div></div>`;
        });
        document.getElementById('detailsModal').style.display = "block";
    }

    function closeModal() { document.getElementById('detailsModal').style.display = "none"; }
</script>
</body>
</html>
