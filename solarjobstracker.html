<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Jobs Tracker - Advanced Filtering</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 20px; color: #1c1e21; }
        .container { max-width: 1450px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* Stats Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 25px; }
        .stat-card { background: #fff; border: 1px solid #e1e4e8; padding: 12px; border-radius: 8px; text-align: center; }
        .stat-card h4 { margin: 0; color: #65676b; font-size: 0.7rem; text-transform: uppercase; }
        .stat-card div { font-size: 1.3rem; font-weight: bold; margin-top: 5px; }
        .highlight-blue { border-top: 4px solid #007bff; background: #f0f7ff; }
        .highlight-green { border-top: 4px solid #28a745; background: #f1fcf4; }

        /* Controls */
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        .control-group label { font-size: 0.75rem; font-weight: bold; color: #4b4b4b; }
        select, input { padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        .search-span { grid-column: span 2; }

        /* Table */
        .table-container { overflow-x: auto; max-height: 600px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background-color: #34495e; color: white; text-align: left; padding: 12px; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background-color: #f8f9fa; cursor: pointer; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: white; margin: 2% auto; padding: 30px; border-radius: 12px; width: 80%; max-height: 90vh; overflow-y: auto; }
        .detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .close-btn { float: right; font-size: 30px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2>Solar Jobs Tracker</h2>

    <div id="statsDashboard" class="stats-grid">
        <div class="stat-card highlight-blue"><h4>Total</h4><div id="stat-total">0</div></div>
        <div class="stat-card"><h4>Solar</h4><div id="stat-solar">0</div></div>
        <div class="stat-card"><h4>Survey</h4><div id="stat-survey">0</div></div>
        <div class="stat-card"><h4>Revisit</h4><div id="stat-revisit">0</div></div>
        <div class="stat-card highlight-green"><h4>Enphase</h4><div id="stat-enphase">0</div></div>
        <div class="stat-card highlight-green"><h4>Tesla</h4><div id="stat-tesla">0</div></div>
        <div class="stat-card highlight-green"><h4>Fox</h4><div id="stat-fox">0</div></div>
        <div class="stat-card"><h4>KF Done</h4><div id="stat-kf">0</div></div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label>CSV File</label>
            <input type="file" id="csvFile" accept=".csv">
        </div>
        <div class="control-group">
            <label>Job Type</label>
            <select id="typeFilter" onchange="runFilters()">
                <option value="">All Types</option>
                <option value="solar">Solar Install</option>
                <option value="survey">Survey</option>
                <option value="revisit">Revisit</option>
                <option value="aftercare">AfterCare</option>
            </select>
        </div>
        <div class="control-group">
            <label>Install Tech</label>
            <select id="techFilter" onchange="runFilters()">
                <option value="">All Tech</option>
                <option value="enphase">Enphase</option>
                <option value="fox">Fox / Fox Evo</option>
                <option value="tesla">Tesla</option>
                <option value="revisit">Revisit (Status)</option>
                <option value="n/a">N/A (Status)</option>
            </select>
        </div>
        <div class="control-group">
            <label>Start Date (Col F)</label>
            <input type="date" id="startDate" onchange="runFilters()">
        </div>
        <div class="control-group">
            <label>End Date (Col F)</label>
            <input type="date" id="endDate" onchange="runFilters()">
        </div>
        <div class="control-group search-span">
            <label>Global Search</label>
            <input type="text" id="searchInput" placeholder="Search Address, Postcode, Lead..." onkeyup="runFilters()">
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Job Number</th>
                    <th>Type</th>
                    <th>Proj. Comp Date</th>
                    <th>Status (G)</th>
                    <th>KF Complete</th>
                    <th>Issues</th>
                    <th>Resolved</th>
                    <th>Lead</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle">Job Details</h3>
        <hr><br>
        <div id="modalData" class="detail-grid"></div>
    </div>
</div>

<script>
    let allData = [];

    const parseDate = (dateStr) => {
        if (!dateStr) return null;
        // Handles common CSV formats (DD/MM/YYYY or YYYY-MM-DD)
        const parts = dateStr.includes('/') ? dateStr.split('/') : dateStr.split('-');
        if (parts.length !== 3) return null;
        if (parts[0].length === 4) return new Date(parts[0], parts[1]-1, parts[2]); // YYYY-MM-DD
        return new Date(parts[2], parts[1]-1, parts[0]); // DD/MM/YYYY
    };

    const checkTech = (row, filterVal) => {
        const combined = `${row['Job Type']} ${row['Booked Status']} ${row['Enphase']}`.toLowerCase();
        if (filterVal === 'fox') return combined.includes('fox') || combined.includes('evo');
        if (filterVal === 'revisit') return combined.includes('revisit') || combined.includes('rv');
        return combined.includes(filterVal);
    };

    document.getElementById('csvFile').addEventListener('change', function(e) {
        Papa.parse(e.target.files[0], {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                const postcodeMap = new Map();
                results.data.forEach(row => {
                    const pc = (row['Postcode'] || '').trim().toUpperCase();
                    if (!pc) return;
                    const isSurvey = (row['Job Type'] || '').toLowerCase().includes('survey');
                    if (!postcodeMap.has(pc) || (postcodeMap.get(pc)['Job Type'].toLowerCase().includes('survey') && !isSurvey)) {
                        postcodeMap.set(pc, row);
                    }
                });
                allData = Array.from(postcodeMap.values());
                runFilters();
            }
        });
    });

    function runFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const typeF = document.getElementById('typeFilter').value;
        const techF = document.getElementById('techFilter').value;
        const startD = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
        const endD = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;

        const filtered = allData.filter(row => {
            const matchesSearch = Object.values(row).some(v => String(v).toLowerCase().includes(search));
            const matchesType = !typeF || String(row['Job Type']).toLowerCase().includes(typeF);
            const matchesTech = !techF || checkTech(row, techF);
            
            // Date Logic (Column F)
            const rowDate = parseDate(row['Projected Completion Date']);
            let matchesDate = true;
            if (startD && (!rowDate || rowDate < startD)) matchesDate = false;
            if (endD && (!rowDate || rowDate > endD)) matchesDate = false;

            return matchesSearch && matchesType && matchesTech && matchesDate;
        });

        updateStats(filtered);
        renderTable(filtered);
    }

    function updateStats(data) {
        const getCount = (val) => data.filter(r => checkTech(r, val)).length;
        document.getElementById('stat-total').innerText = data.length;
        document.getElementById('stat-solar').innerText = data.filter(r => String(r['Job Type']).toLowerCase().includes('solar')).length;
        document.getElementById('stat-survey').innerText = data.filter(r => String(r['Job Type']).toLowerCase().includes('survey')).length;
        document.getElementById('stat-revisit').innerText = getCount('revisit');
        document.getElementById('stat-enphase').innerText = getCount('enphase');
        document.getElementById('stat-tesla').innerText = getCount('tesla');
        document.getElementById('stat-fox').innerText = getCount('fox');
        document.getElementById('stat-kf').innerText = data.filter(r => ['Y','YES'].includes(String(r['Complete on KF']).trim().toUpperCase())).length;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.onclick = () => showDetails(row);
            tr.innerHTML = `
                <td><b>${row['Job Number'] || '-'}</b></td>
                <td>${row['Job Type'] || '-'}</td>
                <td>${row['Projected Completion Date'] || '-'}</td>
                <td>${row['Booked Status'] || '-'}</td>
                <td>${row['Complete on KF'] || '-'}</td>
                <td>${row['Issues Sent'] || ''}</td>
                <td>${row['Issues Resolved'] || '-'}</td>
                <td>${row['Lead'] || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function showDetails(row) {
        const display = document.getElementById('modalData');
        document.getElementById('modalTitle').innerText = `Job Details: ${row['Job Number']}`;
        display.innerHTML = '';
        Object.entries(row).forEach(([k, v]) => {
            display.innerHTML += `<div class="detail-item"><div style="font-size:0.7rem; font-weight:bold; color:#888;">${k}</div><div>${v || '-'}</div></div>`;
        });
        document.getElementById('detailsModal').style.display = "block";
    }

    function closeModal() { document.getElementById('detailsModal').style.display = "none"; }
</script>
</body>
</html>
