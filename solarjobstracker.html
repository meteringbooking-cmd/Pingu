<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Tracker Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 24px; 
            color: var(--text-main);
            line-height: 1.5;
        }

        .container { 
            max-width: 1500px; 
            margin: auto; 
        }

        /* Modern Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        h2 { font-weight: 700; letter-spacing: -0.025em; margin: 0; }

        /* Stats Cards */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 20px; 
            margin-bottom: 32px; 
        }

        .stat-card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 16px; 
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover { transform: translateY(-2px); }
        .stat-card h4 { margin: 0; color: var(--text-sub); font-size: 0.75rem; text-transform: uppercase; font-weight: 600; }
        .stat-card .value { font-size: 1.75rem; font-weight: 700; margin-top: 8px; color: var(--primary); }

        /* Filter Bar */
        .controls { 
            background: var(--card); 
            padding: 24px; 
            border-radius: 16px; 
            border: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        .control-group { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 150px; }
        .control-group label { font-size: 0.75rem; font-weight: 600; color: var(--text-sub); }
        
        input, select { 
            padding: 10px 14px; 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* Table Design */
        .table-container { 
            background: var(--card); 
            border-radius: 16px; 
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f1f5f9; text-align: left; padding: 16px; font-weight: 600; color: var(--text-sub); border-bottom: 1px solid var(--border); }
        td { padding: 16px; border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; cursor: pointer; }

        /* Badges */
        .badge { 
            padding: 4px 10px; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: 500; 
            display: inline-block;
        }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-blue { background: #e0e7ff; color: #3730a3; }
        .badge-grey { background: #f1f5f9; color: #475569; }

        /* Modal Area */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .modal-content { 
            background: var(--card); 
            margin: 50px auto; 
            padding: 40px; 
            border-radius: 24px; 
            width: 70%; 
            max-height: 80vh; 
            overflow-y: auto; 
            position: relative;
        }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 24px; }
        .close-btn { position: absolute; right: 24px; top: 24px; font-size: 24px; cursor: pointer; color: var(--text-sub); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>Solar Jobs Tracker</h2>
        <input type="file" id="csvFile" accept=".csv" style="font-size: 0.8rem;">
    </header>

    <div id="statsDashboard" class="stats-grid">
        <div class="stat-card"><h4>Total Jobs</h4><div id="stat-total" class="value">0</div></div>
        <div class="stat-card"><h4>Solar Install</h4><div id="stat-solar" class="value">0</div></div>
        <div class="stat-card"><h4>Enphase</h4><div id="stat-enphase" class="value" style="color:#2563eb;">0</div></div>
        <div class="stat-card"><h4>Tesla</h4><div id="stat-tesla" class="value" style="color:#dc2626;">0</div></div>
        <div class="stat-card"><h4>Fox/Evo</h4><div id="stat-fox" class="value" style="color:#f59e0b;">0</div></div>
        <div class="stat-card"><h4>KF Completed</h4><div id="stat-kf" class="value" style="color:#16a34a;">0</div></div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label>Job Type</label>
            <select id="typeFilter" onchange="runFilters()">
                <option value="">All Types</option>
                <option value="solar">Solar Install</option>
                <option value="survey">Survey</option>
                <option value="revisit">Revisit</option>
                <option value="aftercare">Aftercare</option>
            </select>
        </div>
        <div class="control-group">
            <label>Install Tech / Status</label>
            <select id="techFilter" onchange="runFilters()">
                <option value="">All Status/Tech</option>
                <option value="enphase">Enphase</option>
                <option value="tesla">Tesla</option>
                <option value="fox">Fox / Evo</option>
                <option value="revisit">Revisit (Status)</option>
                <option value="n/a">N/A</option>
            </select>
        </div>
        <div class="control-group">
            <label>From Date</label>
            <input type="date" id="startDate" onchange="runFilters()">
        </div>
        <div class="control-group">
            <label>To Date</label>
            <input type="date" id="endDate" onchange="runFilters()">
        </div>
        <div class="control-group" style="flex: 2;">
            <label>Search Data</label>
            <input type="text" id="searchInput" placeholder="Search Address, Job No, Lead..." onkeyup="runFilters()">
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Job Number</th>
                    <th>Job Type</th>
                    <th>Proj. Comp</th>
                    <th>Install Status</th>
                    <th>KF Complete</th>
                    <th>Lead</th>
                    <th>Issues</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle" style="margin-bottom: 30px;">Job Details</h2>
        <div id="modalData" class="detail-grid"></div>
    </div>
</div>

<script>
    let allData = [];

    const parseDate = (d) => {
        if (!d) return null;
        const pts = d.includes('/') ? d.split('/') : d.split('-');
        if (pts.length !== 3) return null;
        return pts[0].length === 4 ? new Date(pts[0], pts[1]-1, pts[2]) : new Date(pts[2], pts[1]-1, pts[0]);
    };

    const techMatch = (row, filter) => {
        const combined = `${row['Job Type']} ${row['Booked Status']} ${row['Enphase']}`.toLowerCase();
        if (filter === 'fox') return combined.includes('fox') || combined.includes('evo');
        if (filter === 'revisit') return combined.includes('revisit') || combined.includes('rv');
        return combined.includes(filter);
    };

    document.getElementById('csvFile').addEventListener('change', (e) => {
        Papa.parse(e.target.files[0], {
            header: true, skipEmptyLines: true,
            complete: (r) => {
                const map = new Map();
                r.data.forEach(row => {
                    const pc = (row['Postcode'] || '').trim().toUpperCase();
                    if(!pc) return;
                    const isSrv = (row['Job Type'] || '').toLowerCase().includes('survey');
                    if(!map.has(pc) || (map.get(pc)['Job Type'].toLowerCase().includes('survey') && !isSrv)) map.set(pc, row);
                });
                allData = Array.from(map.values());
                runFilters();
            }
        });
    });

    function runFilters() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const typeF = document.getElementById('typeFilter').value;
        const techF = document.getElementById('techFilter').value;
        const start = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
        const end = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;

        const filtered = allData.filter(row => {
            const mSearch = Object.values(row).some(v => String(v).toLowerCase().includes(query));
            const mType = !typeF || String(row['Job Type']).toLowerCase().includes(typeF);
            const mTech = !techF || techMatch(row, techF);
            const rDate = parseDate(row['Projected Completion Date']);
            let mDate = true;
            if (start && (!rDate || rDate < start)) mDate = false;
            if (end && (!rDate || rDate > end)) mDate = false;
            return mSearch && mType && mTech && mDate;
        });
        updateDashboard(filtered);
        renderTable(filtered);
    }

    function updateDashboard(data) {
        const count = (tech) => data.filter(r => techMatch(r, tech)).length;
        document.getElementById('stat-total').innerText = data.length;
        document.getElementById('stat-solar').innerText = data.filter(r => String(r['Job Type']).toLowerCase().includes('solar')).length;
        document.getElementById('stat-enphase').innerText = count('enphase');
        document.getElementById('stat-tesla').innerText = count('tesla');
        document.getElementById('stat-fox').innerText = count('fox');
        document.getElementById('stat-kf').innerText = data.filter(r => ['Y','YES'].includes(String(r['Complete on KF']).trim().toUpperCase())).length;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        data.forEach(row => {
            const isKF = ['Y','YES'].includes(String(row['Complete on KF']).trim().toUpperCase());
            const tr = document.createElement('tr');
            tr.onclick = () => showDetails(row);
            tr.innerHTML = `
                <td><span style="font-weight:600; color:var(--primary)">${row['Job Number']}</span></td>
                <td>${row['Job Type']}</td>
                <td style="color:var(--text-sub)">${row['Projected Completion Date'] || '-'}</td>
                <td><span class="badge badge-blue">${row['Booked Status']}</span></td>
                <td><span class="badge ${isKF ? 'badge-green':'badge-grey'}">${isKF ? 'Completed' : 'Pending'}</span></td>
                <td>${row['Lead'] || '-'}</td>
                <td style="color:#ef4444; font-size:0.75rem;">${row['Issues Sent'] ? '⚠️ Issue' : '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function showDetails(row) {
        const display = document.getElementById('modalData');
        document.getElementById('modalTitle').innerText = `Job #${row['Job Number']}`;
        display.innerHTML = '';
        Object.entries(row).forEach(([k, v]) => {
            display.innerHTML += `<div><div style="font-size:0.7rem; font-weight:700; color:var(--text-sub); text-transform:uppercase;">${k}</div>
                                  <div style="margin-top:4px;">${v || '-'}</div></div>`;
        });
        document.getElementById('detailsModal').style.display = "block";
    }

    function closeModal() { document.getElementById('detailsModal').style.display = "none"; }
</script>
</body>
</html>
