<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Jobs Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; }
        .controls { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; background: #eee; padding: 15px; border-radius: 5px; }
        input[type="text"] { padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; cursor: pointer; }
        th { background-color: #34495e; color: white; }
        tr:hover { background-color: #f1f1f1; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 60%; max-height: 80vh; overflow-y: auto; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .detail-item { padding: 5px; border-bottom: 1px solid #eee; }
        .label { font-weight: bold; color: #7f8c8d; }
    </style>
</head>
<body>

<div class="container">
    <h2>Solar Jobs Tracker</h2>
    
    <div class="controls">
        <input type="file" id="csvFile" accept=".csv">
        <input type="text" id="searchInput" placeholder="Filter jobs (Type, Number, Lead...)" onkeyup="filterTable()">
    </div>

    <table id="jobsTable">
        <thead>
            <tr>
                <th>Job Number</th>
                <th>Job Type</th>
                <th>Install Type</th>
                <th>Complete on KF</th>
                <th>Compliance</th>
                <th>Issues (1,2,3)</th>
                <th>Resolved</th>
                <th>Lead</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>Full Job Details</h3>
        <div id="modalData" class="detail-grid"></div>
    </div>
</div>

<script>
    let allData = [];

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                processData(results.data);
            }
        });
    });

    function processData(data) {
        const postcodeMap = new Map();

        data.forEach(row => {
            const pc = (row['Postcode'] || '').trim().toUpperCase();
            const jobType = (row['Job Type'] || '').toLowerCase();

            if (!postcodeMap.has(pc)) {
                postcodeMap.set(pc, row);
            } else {
                // Deduplication logic: If existing is a 'survey' and new one isn't, replace it
                const existing = postcodeMap.get(pc);
                if (existing['Job Type'].toLowerCase().includes('survey') && !jobType.includes('survey')) {
                    postcodeMap.set(pc, row);
                }
            }
        });

        allData = Array.from(postcodeMap.values());
        renderTable(allData);
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.onclick = () => showDetails(index);
            
            // Mapping column headers to table cells
            tr.innerHTML = `
                <td>${row['Job Number'] || ''}</td>
                <td>${row['Job Type'] || ''}</td>
                <td>${row['Booked Status'] || ''}</td>
                <td>${row['Complete on KF'] || ''}</td>
                <td>${row['Compliance Checked'] || ''}</td>
                <td>${row['Issues Sent'] || ''} | ${row['Issues Sent2'] || ''} | ${row['Issues Sent3'] || ''}</td>
                <td>${row['Issues Resolved'] || ''}</td>
                <td>${row['Lead'] || ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function filterTable() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allData.filter(row => {
            return Object.values(row).some(val => 
                String(val).toLowerCase().includes(input)
            );
        });
        renderTable(filtered);
    }

    function showDetails(index) {
        const row = allData[index];
        const modal = document.getElementById('detailsModal');
        const display = document.getElementById('modalData');
        display.innerHTML = '';

        for (const [key, value] of Object.entries(row)) {
            display.innerHTML += `
                <div class="detail-item">
                    <div class="label">${key}</div>
                    <div>${value || 'N/A'}</div>
                </div>
            `;
        }
        modal.style.display = "block";
    }

    function closeModal() {
        document.getElementById('detailsModal').style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target == document.getElementById('detailsModal')) closeModal();
    }
</script>

</body>
</html>
